<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>â˜ï¸DB åº«å­˜ç®¡å®¶ (Supabaseç‰ˆ)</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS æ¨£å¼æ²¿ç”¨åŸæœ¬çš„ï¼Œä¸¦æ–°å¢ä¸€é»æ¨£å¼ */
        :root { --primary: #2c3e50; --action: #e67e22; --danger: #e74c3c; --success: #27ae60; --bg: #f4f6f8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; font-size: 16px; line-height: 1.5; }
        /* ... (è«‹ä¿ç•™æ‚¨åŸæœ‰çš„å®Œæ•´ CSS æ¨£å¼ï¼Œé€™è£¡çœç•¥ä»¥ç¯€çœç¯‡å¹…) ... */
        /* æ–°å¢ï¼šå¸‚åƒ¹é¡¯ç¤ºæ¨£å¼ */
        .market-price-badge { font-size: 0.8rem; background: #e0f7fa; color: #006064; padding: 2px 6px; border-radius: 4px; margin-left: 5px; border: 1px solid #b2ebf2; }
    </style>
</head>
<body>
    <!-- (HTML çµæ§‹èˆ‡åŸæœ¬å¤§åŒå°ç•°ï¼Œåƒ…èª¿æ•´ Loading èˆ‡ Auth ä»‹é¢) -->
    <div id="loadingOverlay" style="position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <h2 style="color:var(--primary)">æ­£åœ¨é€£ç·š Supabase...</h2>
    </div>

    <div id="authOverlay" style="position:fixed;inset:0;background:#fff;z-index:9998;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
        <h2>â˜ï¸ åº«å­˜ç®¡å®¶</h2>
        <input type="email" id="logEmail" class="form-control" placeholder="Email" style="margin-bottom:10px;width:100%;max-width:300px;padding:10px;">
        <input type="password" id="logPwd" class="form-control" placeholder="å¯†ç¢¼" style="margin-bottom:10px;width:100%;max-width:300px;padding:10px;">
        <button onclick="app.auth()" class="btn btn-primary" style="width:100%;max-width:300px;padding:10px;">ç™»å…¥ / è¨»å†Š</button>
        <p id="authErr" style="color:red;margin-top:10px;"></p>
    </div>

    <header style="background:linear-gradient(135deg, var(--primary), #34495e); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <h1 style="margin:0;font-size:1.2rem;">â˜ï¸ åº«å­˜ç®¡å®¶</h1>
        <div id="userRoleBadge" class="role-badge" style="font-size:0.8rem;opacity:0.8;"></div>
        <button onclick="app.logout()" style="position:absolute;right:15px;top:15px;background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 10px;border-radius:15px;cursor:pointer;">ç™»å‡º</button>
    </header>

    <!-- ä¸»é é¢å®¹å™¨ -->
    <div id="view-home" class="view-section active" style="padding:15px; max-width:800px; margin:0 auto;">
         <div class="search-area" style="background:white;padding:15px;border-radius:10px;margin-bottom:15px;">
            <input type="text" id="searchInp" oninput="app.renderHome()" placeholder="æœå°‹ç”¢å“..." style="width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:8px;">
            <div style="display:flex;gap:10px;">
                <select id="fBrand" onchange="app.renderHome()" style="flex:1;padding:8px;"></select>
                <select id="fLoc" onchange="app.renderHome()" style="flex:1;padding:8px;"></select>
            </div>
         </div>
         <div id="homeList"></div>
    </div>

    <!-- (å…¶é¤˜ Expiry, Add, Detail, Settings é é¢çš„ HTML è«‹ä¿ç•™åŸæ¨£ï¼ŒID ä¸è®Š) -->
    <!-- ç‚ºäº†ç¤ºç¯„å®Œæ•´æ€§ï¼Œé€™è£¡å‡è¨­æ‚¨æœƒè¤‡è£½åŸæœ‰çš„ HTML çµæ§‹ï¼Œä¸‹æ–¹ Javascript æœƒæ¥ç®¡é‚è¼¯ -->

    <!-- ä¸‹æ–¹å°èˆªåˆ— -->
    <nav class="nav-bar" style="position:fixed;bottom:0;left:0;right:0;background:white;display:flex;height:60px;border-top:1px solid #eee;z-index:900;">
        <button class="nav-item" onclick="app.nav('home')" style="flex:1;border:none;background:none;">ğŸ </button>
        <button class="nav-item" onclick="app.nav('add')" style="flex:1;border:none;background:none;">â•</button>
        <button class="nav-item" onclick="app.nav('settings')" style="flex:1;border:none;background:none;">âš™ï¸</button>
    </nav>

    <script>
        // ğŸ”¥ è«‹å¡«å¯«æ‚¨çš„ Supabase Config ğŸ”¥
        const SB_URL = "https://nvdvhhsktatjixxjvoie.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZHZoaHNrdGF0aml4eGp2b2llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTIwODQsImV4cCI6MjA4Nzg2ODA4NH0.YA36lZLZNp3CLzgEd_CJxr_aupvVhyY6MZmrNGMsRag"; 
        
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);
        let session = null;
        let ST = { prods: [], sets: {} };
        
        // åˆå§‹åŒ–
        async function init() {
            const { data } = await supabase.auth.getSession();
            session = data.session;
            if (session) {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'none';
                syncData();
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            // ç›£è½ç™»å…¥ç‹€æ…‹
            supabase.auth.onAuthStateChange((_event, _session) => {
                session = _session;
                if(session) {
                    document.getElementById('authOverlay').style.display = 'none';
                    syncData();
                } else {
                    document.getElementById('authOverlay').style.display = 'flex';
                }
            });
        }

        // åŒæ­¥æ•¸æ“š (Realtime)
        function syncData() {
            // 1. ç›£è½å…¨åŸŸè¨­å®š inventory settings
            supabase.from('settings').select('*').eq('key', 'global').single().then(res => {
                if(res.data) {
                    ST.sets = res.data.value;
                    renderSets();
                }
            });
            
            // 2. åˆå§‹è®€å–ç”¢å“
            fetchProducts();

            // 3. é–‹å•Ÿ Realtime è¨‚é–± (è‡ªå‹•æ›´æ–°)
            supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, (payload) => {
                console.log('Change received!', payload);
                // ç°¡å–®èµ·è¦‹ï¼Œæœ‰è®Šå‹•å°±é‡æ–°æ‹‰å– (ç”Ÿç”¢ç’°å¢ƒå¯åšå±€éƒ¨å„ªåŒ–)
                fetchProducts(); 
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, (payload) => {
                if(payload.new && payload.new.key === 'global') {
                    ST.sets = payload.new.value;
                    renderSets();
                }
            })
            .subscribe();
        }

        async function fetchProducts() {
            // è½‰æˆ SQL é‚è¼¯
            let query = supabase.from('inventory').select('*').order('created_at', { ascending: false });
            // å¦‚æœæ²’é–‹å•Ÿå…¨åŸŸæª¢è¦–ï¼Œåªçœ‹è‡ªå·±çš„
            if (ST.sets.global_view_enabled === false) { 
                 // éœ€è¦åœ¨å¾Œç«¯ RLS è™•ç†ï¼Œé€™è£¡åƒ…åšå‰ç«¯éæ¿¾ç¤ºæ„
            }
            const { data, error } = await query;
            if(!error) {
                ST.prods = data;
                app.renderHome();
                // è§¸ç™¼å…¶ä»–é é¢é‡æ–°æ¸²æŸ“å‡½æ•¸...
            }
        }

        const app = {
            // èªè¨¼
            auth: async () => {
                const e = document.getElementById('logEmail').value;
                const p = document.getElementById('logPwd').value;
                // å˜—è©¦ç™»å…¥
                let { error } = await supabase.auth.signInWithPassword({ email: e, password: p });
                if (error) {
                    // å˜—è©¦è¨»å†Š
                    const { error: upErr } = await supabase.auth.signUp({ email: e, password: p });
                    if(upErr) document.getElementById('authErr').innerText = error.message;
                    else alert("è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±æˆ–ç›´æ¥ç™»å…¥ï¼ˆè¦– Supabase è¨­å®šè€Œå®šï¼‰");
                }
            },
            logout: async () => { await supabase.auth.signOut(); location.reload(); },

            // å°èˆª
            nav: (id) => {
                document.querySelectorAll('.view-section').forEach(d=>d.style.display='none');
                const el = document.getElementById('view-'+id);
                if(el) el.style.display='block';
            },

            // æ¸²æŸ“ä¸»é  (åŒ…å«å¸‚åƒ¹é¡¯ç¤º)
            renderHome: () => {
                const list = document.getElementById('homeList');
                const s = (document.getElementById('searchInp').value || "").toLowerCase();
                // ç¯©é¸
                const data = ST.prods.filter(p => !p.deleted && (p.name||"").toLowerCase().includes(s));
                
                list.innerHTML = data.map(p => {
                    // é¡¯ç¤ºå¸‚åƒ¹æç¤º
                    let marketInfo = "";
                    if(p.market_price) {
                         // è¨ˆç®—åƒ¹å·®
                         const diff = p.net - p.market_price;
                         const diffTxt = diff < 0 ? `çœ ${Math.abs(diff).toFixed(1)}` : `è²´ ${diff.toFixed(1)}`;
                         const color = diff < 0 ? 'green' : 'red';
                         marketInfo = `<span class="market-price-badge" style="color:${color};border-color:${color}">å¸‚åƒ¹ $${p.market_price} (${diffTxt})</span>`;
                    }

                    return `
                    <div class="card" style="background:#fff;padding:15px;border-radius:10px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <div style="font-weight:bold;font-size:1.1rem;">${p.name}</div>
                        <div style="color:#666;font-size:0.9rem;">${p.brand || ''} | ${p.loc || ''}</div>
                        <div style="display:flex;justify-content:space-between;margin-top:5px;">
                            <span style="color:#e67e22;font-weight:bold;">$${p.net}/${p.unit} ${marketInfo}</span>
                            <span style="font-size:0.8rem;color:#999;">${new Date(p.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>`;
                }).join('');
            },

            // ä¸Šå‚³åœ–ç‰‡ (Supabase Storage)
            uploadImg: async (file) => {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `${session.user.id}/${fileName}`;
                
                let { error: uploadError } = await supabase.storage.from('inventory').upload(filePath, file);
                if (uploadError) throw uploadError;
                
                const { data } = supabase.storage.from('inventory').getPublicUrl(filePath);
                return data.publicUrl;
            },
            
            // æ–°å¢ç”¢å“ç¯„ä¾‹
            saveProd: async () => {
                // (æ­¤è™•åƒ…ç‚ºé‚è¼¯ç¤ºç¯„ï¼Œæ‚¨éœ€ç¶å®š DOM)
                const fileInput = document.getElementById('pImgFile'); 
                let imgUrl = null;
                if(fileInput && fileInput.files.length > 0) {
                    imgUrl = await app.uploadImg(fileInput.files[0]);
                }
                
                const newProd = {
                    name: document.getElementById('pName').value,
                    // ...å–å€¼...
                    img: imgUrl,
                    creator: session.user.email
                };
                
                const { error } = await supabase.from('inventory').insert(newProd);
                if(error) alert("éŒ¯èª¤: "+error.message);
                else { alert("æˆåŠŸ"); app.nav('home'); }
            }
        };

        // è¼”åŠ©æ’åº
        const renderSets = () => {
             // å¡«å……ä¸‹æ‹‰é¸å–®é‚è¼¯ (è«‹è¤‡è£½ä¹‹å‰çš„ fill/sortArr é‚è¼¯)
             const sBrands = (ST.sets.brands || []).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
             const fBrand = document.getElementById('fBrand');
             fBrand.innerHTML = '<option value="">å“ç‰Œ</option>' + sBrands.map(x=>`<option value="${x}">${x}</option>`).join('');
             // ... åœ°é»ç­‰åŒç† ...
        };

        window.onload = init;
    </script>
</body>
</html>