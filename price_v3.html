<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“åº«å­˜ç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ Supabase SDK (é€™æ˜¯åœ¨æ‚¨çš„è‡ªå®šç¾©è…³æœ¬ä¹‹å‰å¿…é ˆè¼‰å…¥çš„) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ‰€éœ€çš„æ¨£å¼ (å¯ä»¥æ ¹æ“šæ‚¨çš„å¯¦éš›æ¨£å¼é€²è¡Œèª¿æ•´) -->
    <style>
        :root {
            --primary: #1976d2;
            --success: #388e3c;
            --danger: #d32f2f;
            --warning: #fbc02d;
            --action: #ff9800;
            --text: #333;
            --background: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        #loadingOverlay, #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.2rem;
            text-align: center;
        }
        #loadingOverlay.hidden, #authOverlay.hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(0,0,0,.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingErr {
            color: var(--danger);
            margin-top: 15px;
            font-weight: bold;
        }
        #forceLoginBtn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* é è¨­éš±è— */
        }
        #authOverlay input {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
            max-width: 80%;
        }
        #authOverlay button {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #authErr {
            color: var(--danger);
            margin-top: 10px;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--card-bg);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        header .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .nav-bar {
            display: flex;
            background-color: #333;
            padding: 10px 0;
            justify-content: center;
            position: sticky;
            top: 60px; /* Adjust if header height changes */
            z-index: 998;
        }
        .nav-item {
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            text-align: center;
            flex-grow: 1;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .nav-item:hover, .nav-item.active {
            background-color: var(--action);
        }
        .view-section {
            display: none;
            padding: 20px;
        }
        .view-section.active {
            display: block;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            padding: 15px;
            position: relative;
        }
        .card-img-box {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            margin-right: 15px;
            border-radius: 6px;
            overflow: hidden;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-body {
            flex-grow: 1;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
            cursor: pointer;
        }
        .card-sub {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .price-main {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--danger);
        }
        .price-unit-net {
            font-size: 0.9rem;
            color: var(--success);
        }
        .card-actions {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chk-lbl {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }
        .chk-lbl input {
            margin-right: 5px;
        }
        .btn-mini {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-mini:hover {
            background-color: #f0f0f0;
        }
        .tag-pill {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .bg-red { background-color: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; }
        .bg-org { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        .bg-grn { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .tag-disc { background-color: #e0f2f7; color: #0288d1; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }
        .tag-bogo { background-color: #ffe0b2; color: #f57c00; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }
        .tag-owner { background-color: #e0f7fa; color: #00838f; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }
        .tag-user { background-color: #e1f5fe; color: #039be5; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }

        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-control {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        .form-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .img-preview-box {
            width: 150px;
            height: 150px;
            border: 1px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .img-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        .remove-img-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Detail View */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .detail-table th, .detail-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        .detail-table th {
            background-color: #f0f0f0;
            width: 100px;
            font-weight: bold;
            color: #555;
        }
        .detail-img {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            cursor: zoom-in;
        }
        .promo-line {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.95rem;
        }
        .promo-val {
            font-weight: bold;
            color: var(--danger);
        }
        .warn-box {
            background-color: #fffde7;
            border: 1px solid #ffeb3b;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            color: #fbc02d;
        }

        /* Lightbox for images */
        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #lbImg {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        #lightbox button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Settings View */
        .settings-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .settings-card h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .settings-card .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .settings-card .form-row input {
            flex-grow: 1;
        }
        .settings-item-pill {
            display: inline-flex;
            align-items: center;
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 0 5px 8px 0;
            font-size: 0.9rem;
            color: #444;
        }
        .setting-del-btn {
            margin-left: 8px;
            color: #d32f2f;
            cursor: pointer;
            font-weight: bold;
        }
        .setting-edit-txt {
            cursor: pointer;
        }
        .setting-edit-txt:hover {
            text-decoration: underline;
        }
        .role-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: bold;
            display: none;
        }
        .role-super { background-color: #8e44ad; color: white; }
        .role-admin { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .role-user { background-color: #f5f5f5; color: #555; border: 1px solid #ddd; }
        .admin-email-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .admin-email-row:last-child {
            border-bottom: none;
        }
        .admin-email-row span {
            font-size: 0.9rem;
        }
        .admin-email-row button {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        .hidden {
            display: none !important;
        }
        .global-view-toggle-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--success);
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Tag Management */
        .tag-mgmt-pill {
            background-color: #e1f5fe;
            color: #039be5;
            border: 1px solid #90caf9;
        }

        /* Compare View */
        .compare-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .compare-table th, .compare-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            font-size: 0.9rem;
        }
        .compare-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        .row-cheap {
            background-color: #fffde7;
        }
        .badge-cheap {
            background-color: #fbc02d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* Trash View */
        .trash-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed #eee;
        }
        .trash-row:last-child {
            border-bottom: none;
        }
        .trash-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #eee;
            flex-shrink: 0;
        }
        .trash-info {
            flex-grow: 1;
        }
        .restore-btn {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .perm-del-btn {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef9a9a;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        /* Utility */
        .mt-15 { margin-top: 15px; }
        .mb-15 { margin-bottom: 15px; }
        .text-center { text-align: center; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .flex-col { display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

    <!-- è¼‰å…¥è¦†è“‹å±¤ (Loading Overlay) -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingStatus">æ­£åœ¨å•Ÿå‹•ä¸­...</p>
        <div id="loadingErr"></div>
        <button id="forceLoginBtn" onclick="app.nav('auth')">å¼·åˆ¶ç™»å…¥</button>
    </div>

    <!-- èªè­‰è¦†è“‹å±¤ (Auth Overlay) -->
    <div id="authOverlay" style="display: none;">
        <h2>æ­¡è¿å›ä¾†ï¼</h2>
        <p>è«‹ç™»å…¥æˆ–è¨»å†Šä»¥ç¹¼çºŒã€‚</p>
        <input type="email" id="logEmail" placeholder="é›»å­éƒµä»¶">
        <input type="password" id="logPwd" placeholder="å¯†ç¢¼">
        <button id="btnLogin" onclick="app.auth()">ç™»å…¥ / è¨»å†Š</button>
        <div id="authErr" style="margin-top: 15px;"></div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ (Main App Interface) -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="logo">
                <span id="pageTitle">åº«å­˜åŠ©æ‰‹</span>
                <span id="userRoleBadge" class="role-badge" style="display:none;"></span>
            </div>
            <div>
                <button class="btn-mini" onclick="app.logout()">ç™»å‡º</button>
                <button id="backBtn" class="btn-mini" style="margin-left: 10px; display: none;" onclick="app.nav('home')">â† è¿”å›</button>
            </div>
        </header>

        <nav class="nav-bar">
            <a class="nav-item active" id="nav-home" onclick="app.nav('home')">é¦–é </a>
            <a class="nav-item" id="nav-add" onclick="app.navToAdd()">æ–°å¢</a>
            <a class="nav-item" id="nav-exps" onclick="app.nav('exps')">æ•ˆæœŸ</a>
            <a class="nav-item" id="nav-star" onclick="app.nav('star')">é—œæ³¨</a>
            <a class="nav-item" id="nav-settings" onclick="app.nav('settings')">è¨­å®š</a>
            <a class="nav-item" id="nav-trash" onclick="app.nav('trash')">
                å›æ”¶æ¡¶ (<span id="trashCount">0</span>)
            </a>
        </nav>

        <div class="container">
            <!-- é¦–é  (Home View) -->
            <section id="view-home" class="view-section active">
                <div class="form-row" style="margin-bottom: 15px; display:flex; gap:10px;">
                    <input type="search" id="searchInp" class="form-control" placeholder="ğŸ” æœå°‹ç”¢å“åç¨±ã€å“ç‰Œã€åœ°é»..." oninput="app.renderHome()" style="flex-grow:1;">
                    <button class="btn-mini" onclick="app.resetFilter()">é‡è¨­</button>
                </div>
                <div class="form-row" style="margin-bottom: 15px; display:flex; gap:10px;">
                    <select id="fBrand" class="form-control" onchange="app.renderHome()" style="flex-grow:1;">
                        <option value="">å…¨éƒ¨å“ç‰Œ</option>
                    </select>
                    <select id="fLoc" class="form-control" onchange="app.renderHome()" style="flex-grow:1;">
                        <option value="">å…¨éƒ¨åœ°é»</option>
                    </select>
                    <select id="fTag" class="form-control" onchange="app.renderHome()" style="flex-grow:1;">
                        <option value="">ğŸ·ï¸ æ‰€æœ‰æ¨™ç±¤</option>
                    </select>
                    <select id="fSort" class="form-control" onchange="app.renderHome()" style="flex-grow:1;">
                        <option value="date_desc">ğŸ“… æœ€æ–°åŠ å…¥</option>
                        <option value="date_asc">ğŸ“… æœ€èˆŠåŠ å…¥</option>
                        <option value="exp_asc">â³ æ•ˆæœŸæœ€è¿‘</option>
                        <option value="exp_desc">â³ æ•ˆæœŸæœ€é </option>
                        <option value="price_asc">ğŸ’° æ·¨åƒ¹æœ€ä½</option>
                        <option value="price_desc">ğŸ’° æ·¨åƒ¹æœ€é«˜</option>
                        <option value="name_asc">ğŸ”¤ åç¨± A-Z</option>
                        <option value="name_desc">ğŸ”¤ åç¨± Z-A</option>
                    </select>
                </div>
                <p id="homeStats" style="text-align: right; color: #777; font-size: 0.9rem; margin-bottom: 15px;"></p>
                <div id="homeList">
                    <!-- ç”¢å“å¡ç‰‡å°‡æœƒè¼‰å…¥åˆ°é€™è£¡ -->
                </div>
            </section>

            <!-- æ–°å¢/ç·¨è¼¯ç”¢å“ (Add/Edit Product View) -->
            <section id="view-add" class="view-section">
                <h2 id="addTitle" style="text-align: center; color: var(--primary); margin-bottom: 25px;">æ–°å¢ç”¢å“</h2>
                <input type="hidden" id="editId">
                <input type="hidden" id="pOldPid">
                <input type="hidden" id="pOldImg">
                <div class="form-group">
                    <label for="pName" class="form-label">ç”¢å“åç¨± *</label>
                    <input type="text" id="pName" class="form-control" placeholder="ä¾‹å¦‚ï¼šçµ±ä¸€å¸ƒä¸" oninput="app.suggest(this.value)" required>
                    <div id="suggestionBox" style="border: 1px solid #eee; border-top: none; max-height: 200px; overflow-y: auto; display: none; background: white; z-index: 10;"></div>
                </div>
                <div class="form-group">
                    <label for="pBrand" class="form-label">å“ç‰Œ *</label>
                    <input list="brands" id="pBrand" class="form-control" placeholder="ä¾‹å¦‚ï¼šçµ±ä¸€">
                    <datalist id="brands"></datalist>
                </div>
                <div class="form-group">
                    <label for="pLoc" class="form-label">åœ°é» *</label>
                    <input list="locs" id="pLoc" class="form-control" placeholder="ä¾‹å¦‚ï¼šå®¶è£¡å†°ç®±">
                    <datalist id="locs"></datalist>
                </div>
                <div class="form-row" style="display:flex; gap:10px;">
                    <div class="form-group" style="flex: 2;">
                        <label for="pQty" class="form-label">æ•¸é‡ *</label>
                        <input type="number" id="pQty" class="form-control" value="1" min="1" oninput="app.calc()">
                    </div>
                    <div class="form-group" style="flex: 3;">
                        <label for="pUnit" class="form-label">å–®ä½ *</label>
                        <input list="units" id="pUnit" class="form-control" placeholder="ä¾‹å¦‚ï¼šå€‹/åŒ…/ç›’">
                        <datalist id="units"></datalist>
                    </div>
                </div>
                <div class="form-group">
                    <label for="pSpec" class="form-label">è¦æ ¼ (é¸å¡«)</label>
                    <input type="text" id="pSpec" class="form-control" placeholder="ä¾‹å¦‚ï¼šç‰¹å¤§è™Ÿ / 500g">
                </div>
                <div class="form-group">
                    <label for="pExp" class="form-label">æœ‰æ•ˆæœŸé™ (é¸å¡«)</label>
                    <input type="date" id="pExp" class="form-control">
                </div>
                <div class="form-group">
                    <label for="pNote" class="form-label">å‚™è¨» (é¸å¡«)</label>
                    <textarea id="pNote" class="form-control" placeholder="å…¶ä»–èªªæ˜..."></textarea>
                </div>

                <div class="form-group mt-15">
                    <label class="form-label">åŸå§‹åƒ¹æ ¼èˆ‡æŠ˜æ‰£ *</label>
                    <div class="form-row" style="align-items: center;">
                        <label class="chk-lbl" style="margin-right: 10px;">
                            <input type="checkbox" id="pUseFor" onchange="app.toggleFor()"> ä½¿ç”¨å¤–å¹£
                        </label>
                        <input type="number" id="pPrice" class="form-control" placeholder="åŸå§‹åƒ¹æ ¼" oninput="app.calc()" style="flex-grow:1;">
                    </div>
                    <div id="forArea" class="form-row hidden mt-10" style="align-items: center;">
                        <select id="pCurr" class="form-control" onchange="app.updRateLabel(); app.calc()" style="flex-basis: 100px; flex-shrink:0;"></select>
                        <input type="number" id="pRate" class="form-control" placeholder="åŒ¯ç‡ (1å¤–å¹£=?æœ¬å¹£)" value="1" min="0.01" step="0.01" oninput="app.updRateLabel(); app.calc()" style="flex-grow:1;">
                        <span id="rateLabel" style="flex-shrink:0; width:120px; text-align:right; font-size:0.9rem; color:#666;">1 USD = 1.00 HKD</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn-mini" onclick="app.addPromoRow('pct','','')">â• % æŠ˜æ‰£</button>
                        <button class="btn-mini" onclick="app.addPromoRow('cash','','')">â• $ æŠ˜æŠµ</button>
                        <button class="btn-mini" onclick="app.addPromoRow('bogo','','','')">â• è²·Xé€Y</button>
                    </div>
                    <div id="promoList" style="margin-top:10px;">
                        <!-- Promo rows will be added here -->
                    </div>
                    <div class="promo-line" style="border-top: 1px solid #eee; margin-top: 15px; padding-top: 10px; font-weight: bold; color: var(--text);">
                        <span id="calcForRes" style="color:var(--primary);"></span>
                        <span id="calcRes"></span>
                    </div>
                </div>

                <div class="form-group mt-15">
                    <label class="form-label">æ¨™ç±¤ (é¸å¡«)</label>
                    <div class="form-row">
                        <input type="text" id="pTagInput" class="form-control" placeholder="æ–°å¢æ¨™ç±¤" onkeypress="app.handleTagInput(event)">
                        <button class="btn-mini" onclick="app.addTagFromInput()">æ–°å¢</button>
                    </div>
                    <div id="formTagContainer" style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:5px;">
                        <!-- Selected tags will appear here -->
                    </div>
                    <div id="tagPool" style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:5px; border-top:1px dashed #eee; padding-top:10px;">
                        <!-- Tag suggestions from global settings will appear here -->
                    </div>
                </div>
                
                <div class="form-group mt-15">
                    <label class="form-label">æ“æœ‰è€…/æˆå“¡ (é¸å¡«)</label>
                    <div id="pOwnerSelect" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <!-- Owner selection chips will be rendered here -->
                    </div>
                </div>

                <div class="form-group mt-15">
                    <label for="pImgFile" class="form-label">ä¸Šå‚³åœ–ç‰‡ (é¸å¡«)</label>
                    <input type="file" id="pImgFile" class="form-control" accept="image/*" onchange="app.prevImg(this)">
                    <p style="margin: 10px 0 5px; color: #777;">æˆ– è¼¸å…¥å¤–éƒ¨åœ–ç‰‡ç¶²å€:</p>
                    <div class="form-row">
                        <input type="text" id="pImgExternal" class="form-control" placeholder="https://..." oninput="app.prevExternal(this.value)">
                    </div>
                    <input type="hidden" id="pImgUrl">
                    <input type="hidden" id="pImgPid">
                    <div id="imgPreviewBox" class="img-preview-box" style="display: none;">
                        <img id="imgPreview" class="img-preview">
                        <button class="remove-img-btn" onclick="app.removeImg()">Ã—</button>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn-secondary" onclick="app.resetForm()">é‡è¨­</button>
                    <button class="btn-primary" id="btnSave" onclick="app.saveProd()">â˜ï¸ ä¿å­˜ç”¢å“</button>
                </div>
            </section>

            <!-- ç”¢å“è©³æƒ… (Detail View) -->
            <section id="view-detail" class="view-section">
                <div id="detailContent">
                    <!-- Product details will be loaded here -->
                </div>
            </section>

            <!-- æ•ˆæœŸæé†’ (Expiry View) -->
            <section id="view-exps" class="view-section">
                <h2 style="text-align: center; color: var(--primary);">æ•ˆæœŸæé†’</h2>
                <div class="form-group">
                    <label for="fExpOwner" class="form-label">ä¾æˆå“¡ç¯©é¸</label>
                    <select id="fExpOwner" class="form-control" onchange="app.renderExps()">
                        <option value="">ğŸ‘¤ æ‰€æœ‰æˆå“¡</option>
                    </select>
                </div>
                <div id="expiryContent" style="margin-top: 20px;">
                    <!-- Expiry products will be loaded here -->
                </div>
            </section>

            <!-- é—œæ³¨ç”¢å“ (Starred View) -->
            <section id="view-star" class="view-section">
                <h2 style="text-align: center; color: var(--primary);">é—œæ³¨ç”¢å“ â­ï¸</h2>
                <div class="form-group">
                    <label for="fStarOwner" class="form-label">ä¾æˆå“¡ç¯©é¸</label>
                    <select id="fStarOwner" class="form-control" onchange="app.renderStar()">
                        <option value="">ğŸ‘¤ æ‰€æœ‰æˆå“¡</option>
                    </select>
                </div>
                <div id="starredList" style="margin-top: 20px;">
                    <!-- Starred products will be loaded here -->
                </div>
            </section>

            <!-- æ¯”åƒ¹ (Compare View) -->
            <section id="view-compare" class="view-section">
                <h2 id="compareInfo" style="text-align: center; color: var(--primary); margin-bottom: 20px;">æ¯”åƒ¹</h2>
                <table class="compare-table">
                    <thead>
                        <tr>
                            <th>ç”¢å“</th>
                            <th>æ·¨å–®åƒ¹</th>
                            <th>æ•¸é‡/è¦æ ¼</th>
                            <th>ç¸½åƒ¹/å„ªæƒ </th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="compareBody">
                        <!-- Comparison results will be loaded here -->
                    </tbody>
                </table>
            </section>

            <!-- è¨­å®š (Settings View) -->
            <section id="view-settings" class="view-section">
                <h2 style="text-align: center; color: var(--primary); margin-bottom: 25px;">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>

                <div class="settings-card">
                    <h3>æœ¬å¹£è¨­å®š</h3>
                    <div class="form-row" style="align-items: center;">
                        <label for="baseCurr" class="form-label" style="flex-shrink: 0; margin-bottom: 0;">åŸºç¤å¹£åˆ¥ *</label>
                        <select id="baseCurr" class="form-control" style="flex-grow: 1;"></select>
                        <button class="btn-primary" id="btnBaseSave" onclick="app.saveSet()" style="flex-shrink: 0;">å„²å­˜ä¿®æ”¹</button>
                    </div>
                </div>
                
                <div class="settings-card">
                    <h3>å…¨åŸŸæ¸…å–®ç®¡ç†</h3>
                    <div id="setOpts">
                        <!-- Dynamic lists for brands, locations, units, owners will be rendered here -->
                    </div>
                </div>

                <div class="settings-card">
                    <h3>æ¨™ç±¤ç®¡ç†</h3>
                    <div id="tagMgmt" style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:5px;">
                        <!-- Tags will be rendered here -->
                    </div>
                </div>

                <div class="settings-card hidden" id="adminMgmtCard">
                    <h3>ç®¡ç†å“¡èˆ‡æ¬Šé™è¨­å®š</h3>
                    <div class="global-view-toggle-area">
                        <span>ğŸŒ å•Ÿç”¨å…¨çƒæª¢è¦–æ¨¡å¼:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="globalViewToggle" onchange="app.toggleGlobalView(this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size:0.85rem; color:#4a824e;">(åƒ…è¶…ç´šç®¡ç†å“¡å¯èª¿æ•´)</span>
                    </div>

                    <div id="adminInputArea">
                        <div class="form-row" style="margin-bottom: 15px;">
                            <input type="email" id="newAdminEmail" class="form-control" placeholder="æ–°å¢ç®¡ç†å“¡éƒµç®±">
                            <button class="btn-mini" onclick="app.addAdmin()">æ–°å¢</button>
                        </div>
                    </div>
                    
                    <div id="adminList">
                        <!-- Admins will be listed here -->
                    </div>
                    <button class="btn-secondary btn-clean" onclick="app.cleanUnusedOpts()" style="margin-top: 20px; display: none;">ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é¸é …</button>
                </div>
            </section>

            <!-- å›æ”¶æ¡¶ (Trash View) -->
            <section id="view-trash" class="view-section">
                <h2 style="text-align: center; color: var(--primary);">å›æ”¶æ¡¶ ğŸ—‘ï¸</h2>
                <div id="trashList" style="margin-top: 20px;">
                    <!-- Deleted products will be loaded here -->
                </div>
            </section>
        </div>
    </div>

    <!-- åœ–ç‰‡ç‡ˆç®± (Lightbox) -->
    <div id="lightbox" onclick="this.style.display='none'">
        <button>âœ•</button>
        <img id="lbImg" src="" alt="Full size image">
    </div>

    <!-- æ‚¨çš„ä¸»è¦ JavaScript æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script>
        // ğŸ”´ å‹™å¿…å¡«å¯«æ‚¨çš„ CONFIG
        const CONFIG = {
            supabase: {
                url: "https://xajsfkbhlgadyfnoddje.supabase.co", // æ›¿æ›ç‚ºæ‚¨çš„ Supabase å°ˆæ¡ˆ URL
                anonKey: "sb_publishable_bd19g9hqpNuvJcnrbh4_jA_drV4NFli" // æ›¿æ›ç‚ºæ‚¨çš„ Supabase Anon Key
            },
            cloudinary: { cloudName: "dr8sjx0t9", preset: "Products" }
        };

        const SYMS = { 'HKD':'$', 'TWD':'NT$', 'USD':'$', 'JPY':'Â¥', 'EUR':'â‚¬', 'KRW':'â‚©', 'CNY':'Â¥', 'GBP':'Â£' };
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 1000; 
                        const scale = maxW / img.width;
                        const w = (img.width > maxW) ? maxW : img.width;
                        const h = (img.width > maxW) ? img.height * scale : img.height;
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        canvas.toBlob((blob) => { if(blob) resolve(blob); else reject(new Error("Img Error")); }, 'image/webp', 0.6); 
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function getThumb(url, w=150) {
            if(!url || !url.includes('cloudinary')) return url;
            return url.replace('/upload/', `/upload/w_${w},f_auto,q_auto/`);
        }

        // ä¿®æ­£: å°‡ 'let' æ”¹ç‚º 'var' ä»¥é¿å…é‡è¤‡å®£å‘ŠéŒ¯èª¤
        var supabase, userSession, currentUserId, settingsUnsub, productsUnsub;
        
        // Supabase è¡¨æ ¼åç¨±
        const TABLE_NAMES = {
            global_settings: 'global_settings',
            products: 'products'
        };

        const DEFAULT_SETS = {
            brands:['å…¨è”','Costco'], locs:['å®¶','å…¬å¸'], units:['å€‹','åŒ…','ç›’','g','ml'],
            owners:[], tags:[], base:'HKD', admins:[], superAdmin: "", allUsers: [], globalViewEnabled: true
        };
        let ST = { prods:[], sets: { ...DEFAULT_SETS } };
        const CURRS = ['HKD','TWD','USD','JPY','KRW','EUR','CNY','GBP'];
        let currentFormTags = []; let currentFormOwners = [];

        /**
         * Helper function to display loading errors.
         * It tries to write to #loadingErr, otherwise logs to console, and as a last resort uses alert().
         */
        function displayLoadingError(message) {
            const loadingErrElement = document.getElementById('loadingErr');
            const loadingOverlayElement = document.getElementById('loadingOverlay');

            if (loadingErrElement) {
                loadingErrElement.innerHTML = message;
            } else {
                console.error("Critical DOM Error: 'loadingErr' element not found. Displaying error via alert:", message);
                // Fallback alert for truly critical cases where the error display element itself is missing
                alert("âš ï¸ ç³»çµ±å•Ÿå‹•å¤±æ•— - é—œéµéŒ¯èª¤ï¼\n\n" + message + "\n\nè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Šã€‚");
            }
            if (loadingOverlayElement) {
                loadingOverlayElement.style.display = 'none'; // Ensure loading overlay is hidden
            }
            // ç¢ºä¿ä¸»æ‡‰ç”¨ä»‹é¢ä¸æœƒé¡¯ç¤º
            const mainAppElement = document.getElementById('mainApp');
            if (mainAppElement) {
                mainAppElement.style.display = 'none';
            }
        }

        function init() {
            // 1. æª¢æŸ¥ Supabase è¨­å®šæ˜¯å¦å·²å¡«å¯«
            if (CONFIG.supabase.url.includes("YOUR_SUPABASE_URL") || CONFIG.supabase.anonKey.includes("YOUR_SUPABASE_ANON_KEY")) {
                displayLoadingError("âš ï¸ Config æœªè¨­å®šï¼è«‹å¡«å…¥ Supabase URL èˆ‡ Anon Keyã€‚");
                return;
            }

            // 2. æª¢æŸ¥ Supabase SDK æ˜¯å¦å·²è¼‰å…¥
            // Explicitly check window.Supabase to ensure the global object is available
            if (typeof window.Supabase === 'undefined' || !window.Supabase.createClient) {
                displayLoadingError("Supabase SDK æœªè¼‰å…¥æˆ–è¼‰å…¥å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šæˆ– Supabase CDN ç¶²å€ã€‚");
                return;
            }
            // Assign SupabaseClient here if window.Supabase is confirmed to exist
            const SupabaseClient = window.Supabase;

            // 3. é•·æ™‚é–“è¼‰å…¥è­¦å‘Š
            setTimeout(() => {
                const load = document.getElementById('loadingOverlay');
                if(load && load.style.display !== 'none' && !currentUserId) { // defensive check for 'load'
                    const loadingStatusElement = document.getElementById('loadingStatus');
                    const forceLoginBtnElement = document.getElementById('forceLoginBtn');
                    if (loadingStatusElement) loadingStatusElement.innerText = "é€£ç·šå›æ‡‰æ™‚é–“éé•·..."; // defensive check
                    if (forceLoginBtnElement) forceLoginBtnElement.style.display = 'block'; // defensive check
                }
            }, 8000);

            try {
                // 4. åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯ (ç¢ºä¿åªåˆå§‹åŒ–ä¸€æ¬¡)
                if (!supabase) { 
                    supabase = SupabaseClient.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                }

                // 5. å†æ¬¡æª¢æŸ¥ Supabase å®¢æˆ¶ç«¯åŠå…¶ auth æ¨¡çµ„æ˜¯å¦æœ‰æ•ˆ
                if (!supabase || !supabase.auth) {
                    throw new Error("Supabase å®¢æˆ¶ç«¯æˆ–å…¶èªè­‰æ¨¡çµ„æœªæˆåŠŸåˆå§‹åŒ–ã€‚è«‹æª¢æŸ¥ Supabase URL èˆ‡ Anon Key æ˜¯å¦æ­£ç¢ºã€‚");
                }

                // 6. ç›£è½èªè­‰ç‹€æ…‹è®Šæ›´
                supabase.auth.onAuthStateChange((event, session) => {
                    userSession = session;
                    const mainAppElement = document.getElementById('mainApp');
                    if (session) {
                        currentUserId = session.user.id;
                        const authOverlayElement = document.getElementById('authOverlay');
                        const loadingStatusElement = document.getElementById('loadingStatus');
                        if (authOverlayElement) authOverlayElement.style.display='none'; // defensive check
                        if (loadingStatusElement) loadingStatusElement.innerText = "æ­£åœ¨åŒæ­¥æ•¸æ“š..."; // defensive check
                        if (mainAppElement) mainAppElement.style.display = 'block'; // Show main app
                        syncData();
                    } else {
                        currentUserId = null;
                        const authOverlayElement = document.getElementById('authOverlay');
                        const loadingOverlayElement = document.getElementById('loadingOverlay');
                        if (authOverlayElement) authOverlayElement.style.display='flex'; // defensive check
                        if (loadingOverlayElement) loadingOverlayElement.style.display='none'; // defensive check
                        if (mainAppElement) mainAppElement.style.display = 'none'; // Hide main app
                        if (settingsUnsub) { settingsUnsub.unsubscribe(); settingsUnsub = null; }
                        if (productsUnsub) { productsUnsub.unsubscribe(); productsUnsub = null; }
                    }
                });
            } catch(e) { 
                // æ•ç²ä»»ä½•åˆå§‹åŒ–éç¨‹ä¸­çš„éŒ¯èª¤
                displayLoadingError("åˆå§‹åŒ–å¤±æ•—: " + e.message);
            }
        }

        // Supabase æ•¸æ“šæ˜ å°„å·¥å…·
        const app = {
            mapSupabaseProduct: (dbProduct) => {
                if (!dbProduct) return {};
                return {
                    id: dbProduct.id,
                    at: new Date(dbProduct.created_at).getTime(),
                    name: dbProduct.name,
                    brand: dbProduct.brand,
                    loc: dbProduct.loc,
                    qty: dbProduct.qty,
                    unit: dbProduct.unit,
                    spec: dbProduct.spec,
                    exp: dbProduct.exp,
                    note: dbProduct.note,
                    raw: dbProduct.raw,
                    isFor: dbProduct.is_for,
                    curr: dbProduct.curr,
                    rateEx: dbProduct.rate_ex,
                    promos: dbProduct.promos,
                    DiscPct: dbProduct.disc_pct,
                    DiscCash: dbProduct.disc_cash,
                    tags: dbProduct.tags,
                    owners: dbProduct.owners,
                    total: dbProduct.total,
                    net: dbProduct.net,
                    img: dbProduct.img,
                    pid: dbProduct.pid,
                    savedBase: dbProduct.saved_base,
                    consumed: dbProduct.consumed,
                    star: dbProduct.star,
                    deleted: dbProduct.deleted,
                    deletedAt: dbProduct.deleted_at ? new Date(dbProduct.deleted_at).getTime() : null,
                    isGhost: dbProduct.is_ghost,
                    creator: dbProduct.creator_email,
                    uid: dbProduct.user_id,
                };
            },

            mapSupabaseSettings: (dbSettings) => {
                if (!dbSettings) return {};
                return {
                    brands: dbSettings.brands || [],
                    locs: dbSettings.locs || [],
                    units: dbSettings.units || [],
                    owners: dbSettings.owners || [],
                    tags: dbSettings.tags || [],
                    base: dbSettings.base_currency || 'HKD',
                    admins: dbSettings.admin_emails || [],
                    superAdmin: dbSettings.super_admin_email || '',
                    allUsers: dbSettings.all_user_emails || [],
                    globalViewEnabled: dbSettings.global_view_enabled === undefined ? true : dbSettings.global_view_enabled,
                };
            },
            
            getSym: () => SYMS[ST.sets.base] || '$', 
            getForSym: (c) => SYMS[c] || c,
            fmtDate: (ts) => new Date(ts).toISOString().split('T')[0],
            fmtTime: (ts) => new Date(ts).toLocaleString(),
            
            // åŠ å…¥å‹•æ…‹é‡æ–°æŒ‰å­—æ¯æ’åºçš„å°å·¥å…· (è™•ç† Issue 3)
            sortArr: (arr) => (arr||[]).slice().sort((a,b)=>a.localeCompare(b, 'zh-Hant')),
            
            getRole: () => {
                const em = userSession && userSession.user ? userSession.user.email : '';
                const superAdmin = ST.sets.superAdmin || ""; 
                const adminList = ST.sets.admins || [];
                const isSuper = (em === superAdmin); const isAdmin = isSuper || adminList.includes(em);
                let label = 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ¶'; let style = 'role-user';
                if(isSuper) { label = 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡'; style = 'role-super'; } else if(isAdmin) { label = 'ğŸ›¡ï¸ ç®¡ç†å“¡'; style = 'role-admin'; }
                return { isSuper, isAdmin, label, style, email: em };
            },

            toggleGlobalView: async (isChecked) => {
                const role = app.getRole();
                if (!role.isSuper) { alert("âŒ åƒ…è¶…ç´šç®¡ç†å“¡(ğŸ‘‘)å¯ä¿®æ”¹æ­¤è¨­å®šï¼"); document.getElementById('globalViewToggle').checked = !isChecked; return; }
                try {
                    const { error } = await supabase.from(TABLE_NAMES.global_settings).update({ global_view_enabled: isChecked }).eq('id', 1);
                    if (error) throw error;
                } catch (e) { alert("æ›´æ–°å¤±æ•—: " + e.message); document.getElementById('globalViewToggle').checked = !isChecked; }
            },
            
            getBogoInfo: (p) => {
                if(!p.promos || p.promos.length === 0) return null;
                const bogo = p.promos.find(x => x.type === 'bogo');
                if(bogo && (bogo.buy + bogo.get) > 1) { return `(æ¯çµ„ ${app.getSym()}${ (p.total / (bogo.buy+bogo.get)).toFixed(2) })`; }
                return null;
            },

            updHeaderRole: () => {
                const role = app.getRole();
                const badge = document.getElementById('userRoleBadge');
                if (badge) { // defensive check
                    badge.className = `role-badge ${role.style}`;
                    badge.innerText = role.label;
                    badge.style.display = 'block';
                }
                const pageTitleElement = document.getElementById('pageTitle');
                if (pageTitleElement) { // defensive check
                    pageTitleElement.innerText = role.email.split('@')[0];
                }
            },
            
            card: (p) => {
                const baseSym = app.getSym(); 
                let expPill = "", expText = p.exp || "ç„¡æ•ˆæœŸ";
                if(p.exp) {
                    const days = (new Date(p.exp) - new Date()) / 86400000;
                    if(days < 0) expPill = `<span class="tag-pill tag-exp bg-red">éæœŸ</span>`; else if(days <= 30) expPill = `<span class="tag-pill tag-exp bg-org">${Math.ceil(days)}å¤©</span>`; else expPill = `<span class="tag-pill tag-exp bg-grn">å®‰å…¨</span>`;
                }
                let forPriceHtml = ""; if(p.isFor && p.curr && p.curr !== ST.sets.base) forPriceHtml = `<span class="price-for">(${app.getForSym(p.curr)}${p.raw})</span>`;
                let badges = ""; let promoDesc = [];
                if(p.promos && p.promos.length > 0) {
                    p.promos.forEach(x => {
                        if(x.type==='pct') badges += `<span class="tag-disc">â†“${x.val}%</span>`; else if(x.type==='cash') badges += `<span class="tag-disc">-$${x.val}</span>`; else if(x.type==='bogo') badges += `<span class="tag-bogo">è²·${x.buy}é€${x.get}</span>`;
                        if(x.note) promoDesc.push(x.note);
                    });
                } else { if(p.DiscPct) badges += `<span class="tag-disc">â†“${p.DiscPct}%</span>`; if(p.DiscCash) badges += `<span class="tag-disc">-$${p.DiscCash}</span>`; if(p.DiscNote) promoDesc.push(p.DiscNote); }
                let promoTextHtml = promoDesc.length > 0 ? `<div class="badge-desc-text">${promoDesc.join(' / ')}</div>` : "";
                if(p.owners) p.owners.forEach(o => badges += `<span class="tag-owner">ğŸ‘¤ ${o}</span>`);
                if(p.tags) p.tags.forEach(t => badges += `<span class="tag-user">#${t}</span>`);
                const thumbUrl = getThumb(p.img, 150); const imgDisplay = p.img ? `<img class="card-img" src="${thumbUrl}" onclick="app.lb('${p.img}')" loading="lazy">` : `<div class="card-img" style="background:#eee; display:flex; align-items:center; justify-content:center; color:#999; font-size:2rem;">ğŸ“·</div>`;
                let creatorInfo = ""; if(app.getRole().isAdmin && p.creator && p.creator !== userSession.user.email) { creatorInfo = `<div style="font-size:0.75rem; color:#888; margin-top:2px;">ç”± ${p.creator.split('@')[0]} æ–°å¢</div>`; }
                const bogoInfo = app.getBogoInfo(p); const bogoHtml = bogoInfo ? `<span style="font-size:0.85rem; color:var(--action); font-weight:bold; margin-left:4px;">${bogoInfo}</span>` : '';

                return `<div class="card ${p.consumed?'consumed':''}" id="c-${p.id}"><div class="card-img-box">${imgDisplay}</div><div class="card-body"><div class="card-title" onclick="app.detail('${p.id}')">${p.name}</div><div class="card-sub"><span>${p.brand}</span> â€¢ <span>${p.loc}</span></div><div class="card-row" style="margin-top:2px;"><div class="card-sub">æ•ˆæœŸ: ${expText} ${expPill}</div></div>${creatorInfo}<div class="card-date">ğŸ“… åŠ å…¥: ${app.fmtDate(p.at)}</div><div class="card-row" style="margin-top:4px;"><div class="price-unit-net">æ·¨: ${baseSym}${p.net}/${p.unit}${bogoHtml}</div><div class="price-main">${baseSym}${p.total}${forPriceHtml}</div></div>${promoTextHtml}${badges ? `<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:2px;">${badges}</div>` : ''}<div class="card-actions"><label class="chk-lbl"><input type="checkbox" ${p.consumed?'checked':''} onchange="app.upd('${p.id}',{consumed:this.checked})"> å·²ç”¨/å·²é£Ÿ</label><label class="chk-lbl"><input type="checkbox" ${p.star?'checked':''} onchange="app.upd('${p.id}',{star:this.checked})"> â­ï¸</label><button class="btn-mini" style="margin-left:auto;" onclick="app.comp('${p.name.replace(/'/g, "\\'") }','${p.brand.replace(/'/g, "\\'") }')">âš–ï¸ æ¯”åƒ¹</button></div></div></div>`;
            },
            
            softDel: async (id) => {
                if(confirm("ç¢ºå®šå°‡æ­¤ç”¢å“ç§»å…¥å›æ”¶æ¡¶ï¼Ÿ")) {
                    const { error } = await supabase.from(TABLE_NAMES.products).update({ deleted: true, deleted_at: new Date().toISOString() }).eq('id', id);
                    if (error) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message); }
                    else { app.nav('home'); setTimeout(() => alert("ğŸ—‘ï¸ ç”¢å“å·²ç§»è‡³å›æ”¶æ¡¶ï¼"), 300); }
                }
            },
            restore: async (id) => {
                const { error } = await supabase.from(TABLE_NAMES.products).update({ deleted: false, deleted_at: null }).eq('id', id);
                if (error) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message); }
                else { alert("å·²é‚„åŸï¼"); }
            },
            hardDel: async (id) => {
                if(!app.getRole().isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šåƒ… Admin å¯æ°¸ä¹…åˆªé™¤è³‡æ–™ã€‚");
                if(confirm("âš ï¸ æ°¸ä¹…åˆªé™¤è­¦å‘Š\n\nç¢ºèªï¼Ÿ")) {
                    const { error } = await supabase.from(TABLE_NAMES.products).delete().eq('id', id);
                    if (error) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message); }
                }
            },
            updTrashCount: () => { 
                const count = ST.prods.filter(p => p.deleted === true).length; 
                const trashCountElement = document.getElementById('trashCount');
                const btnTrashElement = document.getElementById('nav-trash'); // Corrected ID to the nav item
                if (trashCountElement) trashCountElement.innerText = count; // defensive check
                if (btnTrashElement) { // defensive check
                    if(count > 0) btnTrashElement.classList.add('btn-danger'); 
                    else btnTrashElement.classList.remove('btn-danger'); 
                }
            },
            renderTrash: () => {
                const trashItems = ST.prods.filter(p => p.deleted === true);
                const role = app.getRole();
                const trashListElement = document.getElementById('trashList');
                if (!trashListElement) { console.error("Error: 'trashList' element not found."); return; } // defensive check

                if(trashItems.length === 0) { trashListElement.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">å›æ”¶æ¡¶æ˜¯ç©ºçš„ ğŸ‰</div>'; return; }
                trashListElement.innerHTML = trashItems.map(p => {
                    const thumbUrl = getThumb(p.img, 150);
                    const thumb = p.img ? `<img class="trash-thumb" src="${thumbUrl}" onclick="app.lb('${p.img}')">` : '<div class="trash-thumb" style="display:flex;align-items:center;justify-content:center;">ç„¡åœ–</div>';
                    const delBtn = role.isAdmin ? `<button class="perm-del-btn" onclick="app.hardDel('${p.id}')">æ°¸ä¹…åˆªé™¤</button>` : '';
                    return `<div class="trash-row">${thumb}<div class="trash-info"><div><b>${p.name}</b></div><div style="font-size:0.8rem;color:#888;">${p.pid?`ID:${p.pid}`:'ç„¡ID'}</div></div><div style="display:flex;flex-direction:column;gap:6px;"><button class="restore-btn" onclick="app.restore('${p.id}')">é‚„åŸ</button>${delBtn}</div></div>`;
                }).join('');
            },
            
            renderHome: () => { 
                const searchInpElement = document.getElementById('searchInp');
                const fBrandElement = document.getElementById('fBrand');
                const fLocElement = document.getElementById('fLoc');
                const fTagElement = document.getElementById('fTag');
                const fSortElement = document.getElementById('fSort');
                const homeStatsElement = document.getElementById('homeStats');
                const homeListElement = document.getElementById('homeList');

                if (!searchInpElement || !fBrandElement || !fLocElement || !fTagElement || !fSortElement || !homeStatsElement || !homeListElement) {
                    console.error("Error: One or more home view elements not found.");
                    return;
                }

                const s = searchInpElement.value.toLowerCase(); 
                const b = fBrandElement.value; 
                const l = fLocElement.value; 
                const t = fTagElement.value; 
                const sort = fSortElement.value; 
                const allTags = app.sortArr(ST.sets.tags); 
                
                if(fTagElement.options.length <= 1 || fTagElement.innerHTML.indexOf(t) === -1 && t !== "") { 
                    fTagElement.innerHTML = `<option value="">ğŸ·ï¸ æ‰€æœ‰æ¨™ç±¤</option>` + allTags.map(tag => `<option value="${tag}">${tag}</option>`).join(''); 
                    fTagElement.value = t; 
                } 
                let d = ST.prods.filter(p => !p.deleted && (p.name+p.brand+p.loc).toLowerCase().includes(s) && (!b || p.brand===b) && (!l || p.loc===l) && (!t || (p.tags && p.tags.includes(t)) )); 
                d.sort((x,y) => { const tsX = x.at||0, tsY = y.at||0; if(sort==='date_desc') return tsY - tsX; else if(sort==='date_asc') return tsX - tsY; else if(sort==='price_asc') return x.net - y.net; else if(sort==='price_desc') return y.net - x.net; else if(sort==='exp_asc') return (x.exp||'z').localeCompare(y.exp||'z'); else if(sort==='exp_desc') return (y.exp||'').localeCompare(x.exp||''); else if(sort==='name_asc') return x.name.localeCompare(y.name, 'zh-Hant'); else if(sort==='name_desc') return y.name.localeCompare(x.name, 'zh-Hant'); else return tsY - tsX; }); 
                const pendingCount = d.filter(x => !x.consumed && x.exp).length; 
                homeStatsElement.innerText = `ç¸½æ•¸: ${d.length} | å¾…ç”¨/å¾…é£Ÿ: ${pendingCount}`; 
                homeListElement.innerHTML = d.map(app.card).join(''); 
            },
            resetFilter: () => { 
                const searchInpElement = document.getElementById('searchInp');
                const fBrandElement = document.getElementById('fBrand');
                const fLocElement = document.getElementById('fLoc');
                const fTagElement = document.getElementById('fTag');
                const fSortElement = document.getElementById('fSort');

                if (searchInpElement) searchInpElement.value=''; 
                if (fBrandElement) fBrandElement.value=''; 
                if (fLocElement) fLocElement.value=''; 
                if (fTagElement) fTagElement.value=''; 
                if (fSortElement) fSortElement.value='date_desc'; 
                app.renderHome(); 
            },
            renderExps: () => { 
                const fExpOwnerElement = document.getElementById('fExpOwner');
                const expiryContentElement = document.getElementById('expiryContent');

                if (!fExpOwnerElement || !expiryContentElement) {
                    console.error("Error: One or more expiry view elements not found.");
                    return;
                }

                const ownerVal = fExpOwnerElement.value; 
                const items = ST.prods.filter(p => !p.deleted && !p.consumed && p.exp && (ownerVal === "" || (p.owners && p.owners.includes(ownerVal)))); 
                const s = (arr) => arr.sort((a,b)=>a.exp.localeCompare(b.exp)); 
                const today = new Date(); 
                const reds=[], orgs=[], grns=[]; 
                items.forEach(p => { const diff = (new Date(p.exp) - today) / 86400000; if(diff < 0) reds.push(p); else if(diff <= 30) orgs.push(p); else grns.push(p); }); 
                const blk = (t, c, arr) => arr.length ? `<div class="exp-head ${c}" style="padding:10px;color:white;border-radius:6px;margin:20px 0 12px;font-weight:bold;font-size:1rem;">${t} (${arr.length})</div>${s(arr).map(app.card).join('')}` : ''; 
                expiryContentElement.innerHTML = (reds.length?blk("ğŸ”´ å·²éæœŸ", "bg-red", reds):'') + (orgs.length?blk("ğŸŸ  30å¤©å…§åˆ°æœŸ", "bg-org", orgs):'') + (grns.length?blk("ğŸŸ¢ å®‰å…¨æœŸ", "bg-grn", grns):'') || '<div style="text-align:center;padding:30px;color:#999;font-size:1rem;">ç„¡ç›¸é—œç”¢å“</div>'; 
            },
            renderStar: () => { 
                const fStarOwnerElement = document.getElementById('fStarOwner');
                const starredListElement = document.getElementById('starredList');

                if (!fStarOwnerElement || !starredListElement) {
                    console.error("Error: One or more starred view elements not found.");
                    return;
                }

                const ownerVal = fStarOwnerElement.value; 
                const stars = ST.prods.filter(p => !p.deleted && p.star && (ownerVal === "" || (p.owners && p.owners.includes(ownerVal)))); 
                starredListElement.innerHTML = stars.length ? stars.map(app.card).join('') : '<div style="text-align:center;padding:20px;color:#999;">å°šæœªåŠ å…¥é—œæ³¨â­ï¸</div>'; 
            },
            
            detail: (id) => { 
                const p = ST.prods.find(x=>x.id===id); if(!p) return; 
                app.nav('detail'); 

                const detailContentElement = document.getElementById('detailContent');
                if (!detailContentElement) { console.error("Error: 'detailContent' element not found."); return; } // defensive check

                const canEdit = app.getRole().isAdmin || p.creator === userSession.user.email; 
                let warn = ""; if(p.savedBase && p.savedBase !== ST.sets.base) warn = `<div class="warn-box"><span>âš ï¸</span><div><b>åŒ¯ç‡åŸºæº–ä¸ä¸€è‡´</b>...</div></div>`; 
                const bs = app.getSym(); 
                let breakdownHtml = ""; 
                if(p.isFor && p.curr && p.curr !== ST.sets.base) { 
                    breakdownHtml += `<div class="promo-line"><span>å¤–å¹£åŸåƒ¹</span><span>${app.getForSym(p.curr)}${p.raw}</span></div><div class="promo-line"><span>åŒ¯ç‡æ›ç®— (x${p.rateEx})</span><span>${bs}${(p.raw * (p.rateEx||1)).toFixed(2)}</span></div>`; 
                } else { 
                    breakdownHtml += `<div class="promo-line"><span>åŸå§‹åƒ¹æ ¼</span><span>${bs}${p.raw}</span></div>`; 
                } 
                if(p.promos && p.promos.length > 0) { 
                    p.promos.forEach(x => { let lbl = x.note ? x.note : ''; let valDisplay = ''; if(x.type==='pct') { if(!lbl) lbl=`æŠ˜æ‰£ ${x.val}%`; valDisplay=`-${x.val}%`; } else if(x.type==='cash') { if(!lbl) lbl=`æŠ˜æ‰£ $${x.val}`; valDisplay=`-${bs}${x.val}`; } else if(x.type==='bogo') { if(!lbl) lbl=`è²·${x.buy}é€${x.get}`; valDisplay=`å« (æ¯åŒ… ${bs}${(p.total / (x.buy+x.get)).toFixed(2)})`; } breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ ${lbl}</span><span>${valDisplay}</span></div>`; }); 
                } else { if(p.DiscPct) breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ æŠ˜æ‰£ ${p.DiscPct}%</span><span>-${p.DiscPct}%</span></div>`; if(p.DiscCash) breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ ç¾é‡‘æŠ˜æŠµ</span><span>-${bs}${p.DiscCash}</span></div>`; } 
                breakdownHtml += `<div class="promo-line" style="border-top:1px solid #ddd; margin-top:4px; padding-top:4px; font-weight:bold; color:var(--text);"><span>æœ€çµ‚å¯¦ä»˜</span><span class="promo-val">${bs}${p.total}</span></div>`; 
                let tagsHtml = ""; 
                if(p.owners) tagsHtml += `<div style="margin-top:10px;display:flex;gap:5px;">${p.owners.map(o=>`<span class="tag-owner">ğŸ‘¤ ${o}</span>`).join('')}</div>`; 
                if(p.tags) tagsHtml += `<div style="margin-top:10px;display:flex;gap:5px;">${p.tags.map(t=>`<span class="tag-user">#${t}</span>`).join('')}</div>`; 
                const detailUrl = getThumb(p.img, 800); 
                const imgHtml = p.img ? `<img src="${detailUrl}" class="detail-img" onclick="app.lb('${p.img}')">` : `<div style="height:120px;background:#eee;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#999;font-size:2rem;">ğŸ“·</div>`; 
                const btnStarStyle = p.star ? 'background:#fff9c4; color:#fbc02d; border-color:#fbc02d;' : 'background:white; color:#555;'; 
                const btnConStyle = p.consumed ? 'background:#424242; color:white; border-color:#424242;' : 'background:white; color:#555;'; 
                const editBtns = canEdit ? `<button class="btn-mini" style="padding:10px 16px; background:#fff3e0;color:#ef6c00;" onclick="app.loadToForm('${p.id}', true)">âœï¸ ä¿®æ”¹</button><button class="btn-mini" style="padding:10px 16px; background:#ffebee;color:#c62828;" onclick="app.softDel('${p.id}')">ğŸ—‘ï¸ ä¸Ÿæ£„</button>` : `<span style="color:#999; font-size:0.8rem;">(åƒ…ç™¼å¸ƒè€…å¯ä¿®æ”¹)</span>`; 
                detailContentElement.innerHTML = `<div style="text-align:center; padding:10px;">${imgHtml}</div>${warn}<h2 style="text-align:center; margin:10px 0 5px; color:var(--primary); font-size:1.4rem;">${p.name}</h2><div style="text-align:center;font-size:0.85rem;color:#777;margin-bottom:5px;">${p.creator ? 'ç”± '+p.creator+' æ–°å¢' : ''}</div><div style="text-align:center;margin-bottom:15px;display:flex;flex-wrap:wrap;justify-content:center;gap:5px;">${tagsHtml}</div><div style="display:flex; gap:10px; justify-content:center; margin-bottom:25px; flex-wrap:wrap;"><button class="btn-mini" style="padding:10px 14px; ${btnConStyle}" onclick="app.upd('${p.id}',{consumed:${!p.consumed}}).then(()=>app.detail('${p.id}'))">${p.consumed ? 'âœ… å·²ç”¨/å·²é£Ÿ' : 'ğŸ½ å¾…ç”¨/å¾…é£Ÿ'}</button><button class="btn-mini" style="padding:10px 14px; ${btnStarStyle}" onclick="app.upd('${p.id}',{star:${!p.star}}).then(()=>app.detail('${p.id}'))">${p.star ? 'â­ï¸ å·²é—œæ³¨' : 'â˜† é—œæ³¨'}</button><button class="btn-mini" style="padding:10px 16px; background:#e3f2fd;color:#1565c0;" onclick="app.comp('${p.name.replace(/'/g,"\\'")}','${p.brand.replace(/'/g,"\\'")}','')">âš–ï¸ æ¯”åƒ¹</button>${editBtns}</div><table class="detail-table"><tr><th>åœ°é»/å“ç‰Œ</th><td>${p.loc}<br>${p.brand}</td></tr><tr><th>è¦æ ¼/æ•¸é‡</th><td>${p.qty} ${p.unit}<br>${p.spec||'ç„¡è¦æ ¼'}</td></tr><tr><th>åŠ å…¥æ—¥æœŸ</th><td>${app.fmtDate(p.at)}</td></tr><tr><th>æœ‰æ•ˆæ—¥æœŸ</th><td>${p.exp||'--'}</td></tr><tr><th>æ·¨å–®åƒ¹</th><td>${bs}${p.net} / ${p.unit}</td></tr><tr><th>åƒ¹æ ¼è©³æƒ…</th><td>${breakdownHtml}</td></tr><tr><th>å‚™è¨»</th><td style="white-space:pre-wrap;color:#555;">${p.note||'--'}</td></tr></table>`; 
            },

            addPromoRow: (type, val='', note='', buy='', get='') => { 
                const promoListElement = document.getElementById('promoList');
                if (!promoListElement) { console.error("Error: 'promoList' element not found."); return; } // defensive check

                const div = document.createElement('div'); div.className = 'promo-row'; 
                if (type === 'bogo') { div.innerHTML = `<div class="chk-lbl" style="font-weight:bold;color:var(--action)">è²·</div><input type="number" class="form-control promo-inp-bogo inp-buy" placeholder="2" value="${buy}" oninput="app.calc()"><div class="chk-lbl" style="font-weight:bold;color:var(--action)">é€</div><input type="number" class="form-control promo-inp-bogo inp-get" placeholder="1" value="${get}" oninput="app.calc()"><input type="hidden" class="promo-inp-s" data-type="bogo" value="0"><input type="text" class="form-control promo-inp-l" placeholder="èªªæ˜ (é¸å¡«)" value="${note}"><span class="promo-del" onclick="this.parentElement.remove();app.calc()">&times;</span>`; } else { div.innerHTML = `<div class="chk-lbl" style="width:20px; justify-content:center;">${type==='pct'?'%':'$'}</div><input type="number" class="form-control promo-inp-s" data-type="${type}" placeholder="${type==='pct'?'10':'20'}" value="${val}" oninput="app.calc()"><input type="text" class="form-control promo-inp-l" placeholder="èªªæ˜" value="${note}"><span class="promo-del" onclick="this.parentElement.remove();app.calc()">&times;</span>`; } 
                promoListElement.appendChild(div); 
                app.calc(); 
            },
            handleTagInput: (e) => { if(e.key === 'Enter') { e.preventDefault(); app.addTagFromInput(); } }, addTagFromInput: () => { const inp = document.getElementById('pTagInput'); if (!inp) { console.error("Error: 'pTagInput' element not found."); return; } const val = inp.value.trim(); if(val) { app.addTag(val); inp.value = ''; } }, addTag: async (tag) => { if(!currentFormTags.includes(tag)) { currentFormTags.push(tag); app.renderFormTags(); if(!(ST.sets.tags||[]).includes(tag)) { try { await app.updateGlobalSettingsArray('tags', tag); } catch(e) { console.error("æ–°å¢æ¨™ç±¤å¤±æ•—", e); } } } }, removeTag: (tag) => { currentFormTags = currentFormTags.filter(t => t !== tag); app.renderFormTags(); }, 
            renderFormTags: () => { 
                const container = document.getElementById('formTagContainer'); 
                const tagPoolElement = document.getElementById('tagPool');
                if (!container || !tagPoolElement) { console.error("Error: 'formTagContainer' or 'tagPool' element not found."); return; } // defensive check

                container.innerHTML = currentFormTags.map(t => `<div class="tag-chip"><span>#${t}</span><span style="color:#d32f2f;margin-left:2px;" onclick="app.removeTag('${t}')">&times;</span></div>`).join(''); 
                if(currentFormTags.length === 0) container.innerHTML = '<span style="color:#aaa;font-size:0.9rem;padding:4px;">(æœªé¸æ“‡æ¨™ç±¤)</span>'; 
                const pool = app.sortArr(ST.sets.tags); 
                const available = pool.filter(t => !currentFormTags.includes(t)); 
                tagPoolElement.innerHTML = available.length ? available.map(t => `<div class="tag-suggestion" onclick="app.addTag('${t}')">+ ${t}</div>`).join('') : ''; 
            },
            toggleOwner: (name) => { const idx = currentFormOwners.indexOf(name); if(idx > -1) currentFormOwners.splice(idx, 1); else currentFormOwners.push(name); app.renderOwnerSelect(); }, 
            renderOwnerSelect: () => { 
                const div = document.getElementById('pOwnerSelect'); 
                if (!div) { console.error("Error: 'pOwnerSelect' element not found."); return; } // defensive check
                const list = app.sortArr(ST.sets.owners); 
                div.innerHTML = list.length ? list.map(o => { const active = currentFormOwners.includes(o) ? 'active' : ''; return `<div class="owner-chip-btn ${active}" onclick="app.toggleOwner('${o}')">ğŸ‘¤ ${o}</div>`; }).join('') : '<div style="color:#999;font-size:0.9rem;">(æš«ç„¡æˆå“¡ï¼Œè«‹è‡³ã€Œè¨­å®šã€æ–°å¢)</div>'; 
            },
            
            // ğŸ›  ä¿®å¾© Issue 2: å‹•æ…‹è£œé½Šé¸é … (`ensureOpt`)
            loadToForm: (id, isEditMode) => { 
                app.resetForm(); const p = ST.prods.find(x=>x.id===id); if(!p) return; 

                // Defensive checks for all elements accessed in this function
                const suggestionBox = document.getElementById('suggestionBox');
                const editId = document.getElementById('editId');
                const addTitle = document.getElementById('addTitle');
                const btnSave = document.getElementById('btnSave');
                const pName = document.getElementById('pName');
                const pBrand = document.getElementById('pBrand');
                const pLoc = document.getElementById('pLoc');
                const pUnit = document.getElementById('pUnit');
                const pSpec = document.getElementById('pSpec');
                const pQty = document.getElementById('pQty');
                const pExp = document.getElementById('pExp');
                const pNote = document.getElementById('pNote');
                const pPrice = document.getElementById('pPrice');
                const pUseFor = document.getElementById('pUseFor');
                const pCurr = document.getElementById('pCurr');
                const pRate = document.getElementById('pRate');
                const promoList = document.getElementById('promoList');
                const pImgUrl = document.getElementById('pImgUrl');
                const pImgPid = document.getElementById('pImgPid');
                const pImgExternal = document.getElementById('pImgExternal');
                const pOldPid = document.getElementById('pOldPid');
                const pOldImg = document.getElementById('pOldImg');
                const imgPreview = document.getElementById('imgPreview');
                const imgPreviewBox = document.getElementById('imgPreviewBox');
                
                // Exit if any critical element is missing
                if (!suggestionBox || !editId || !addTitle || !btnSave || !pName || !pBrand || !pLoc || !pUnit || !pSpec || !pQty || !pExp || !pNote || !pPrice || !pUseFor || !pCurr || !pRate || !promoList || !pImgUrl || !pImgPid || !pImgExternal || !pOldPid || !pOldImg || !imgPreview || !imgPreviewBox) {
                    console.error("Error: One or more elements missing in loadToForm.");
                    return;
                }

                suggestionBox.style.display='none'; 
                editId.value = isEditMode ? p.id : ''; 
                addTitle.innerText = isEditMode ? "ç·¨è¼¯ç”¢å“" : "æ–°å¢ç”¢å“"; 
                btnSave.innerText = isEditMode ? "âœï¸ æ›´æ–°è³‡æ–™" : "â˜ï¸ ä¿å­˜ç”¢å“"; 
                pName.value = p.name; 
                
                const ensureOpt = (id, val) => { const s = document.getElementById(id); if(val && s) { if(!Array.from(s.options).some(o=>o.value===val)) s.add(new Option(val,val)); s.value=val; } };
                ensureOpt('pBrand', p.brand); ensureOpt('pLoc', p.loc); ensureOpt('pUnit', p.unit);
                
                pSpec.value = p.spec; pQty.value = p.qty; pExp.value = p.exp; pNote.value = p.note; pPrice.value = p.raw; pUseFor.checked = p.isFor; if(p.isFor) { pCurr.value = p.curr; pRate.value = p.rateEx; } app.toggleFor(); promoList.innerHTML = ''; if(p.promos && p.promos.length > 0) { p.promos.forEach(x => app.addPromoRow(x.type, x.val, x.note, x.buy, x.get)); } else { if(p.DiscPct) app.addPromoRow('pct', p.DiscPct, p.DiscNote||''); if(p.DiscCash) app.addPromoRow('cash', p.DiscCash, p.CashNote||''); } currentFormTags = p.tags ? [...p.tags] : []; app.renderFormTags(); currentFormOwners = p.owners ? [...p.owners] : []; app.renderOwnerSelect(); pImgUrl.value = p.img || ''; pImgPid.value = p.pid || ''; if(p.img && !p.img.includes('cloudinary.com')) { pImgExternal.value = p.img; } if(isEditMode) { pOldPid.value = p.pid || ''; pOldImg.value = p.img || ''; } if(p.img) { imgPreview.src = p.img; imgPreviewBox.style.display='block'; } else { app.removeImg(); } app.calc(); if(isEditMode) app.nav('add'); 
            },
            
            // ğŸ›  ä¿®å¾© Issue 1: åªåœ¨æ–°å¢æ™‚å¡å…¥ Creator !
            saveProd: async () => { 
                const pNameElement = document.getElementById('pName');
                const btnSaveElement = document.getElementById('btnSave');
                const pImgUrlElement = document.getElementById('pImgUrl');
                const pImgPidElement = document.getElementById('pImgPid');
                const pImgFileElement = document.getElementById('pImgFile');
                const pImgExternalElement = document.getElementById('pImgExternal');
                const promoListElement = document.getElementById('promoList');
                const pBrandElement = document.getElementById('pBrand');
                const pLocElement = document.getElementById('pLoc');
                const pQtyElement = document.getElementById('pQty');
                const pUnitElement = document.getElementById('pUnit');
                const pSpecElement = document.getElementById('pSpec');
                const pExpElement = document.getElementById('pExp');
                const pNoteElement = document.getElementById('pNote');
                const pPriceElement = document.getElementById('pPrice');
                const pUseForElement = document.getElementById('pUseFor');
                const pCurrElement = document.getElementById('pCurr');
                const pRateElement = document.getElementById('pRate');
                const editIdElement = document.getElementById('editId');
                const pOldPidElement = document.getElementById('pOldPid');
                const pOldImgElement = document.getElementById('pOldImg');

                // Defensive checks for all elements
                if (!pNameElement || !btnSaveElement || !pImgUrlElement || !pImgPidElement || !pImgFileElement || !pImgExternalElement || !promoListElement || !pBrandElement || !pLocElement || !pQtyElement || !pUnitElement || !pSpecElement || !pExpElement || !pNoteElement || !pPriceElement || !pUseForElement || !pCurrElement || !pRateElement || !editIdElement || !pOldPidElement || !pOldImgElement) {
                    console.error("Error: One or more critical elements missing in saveProd.");
                    alert("å„²å­˜å¤±æ•—: é é¢å…ƒç´ ä¸å®Œæ•´ã€‚");
                    return;
                }

                const name = pNameElement.value.trim(); if(!name) return alert("è«‹è¼¸å…¥åç¨±"); 
                const btn = btnSaveElement; btn.disabled=true; btn.innerText="è™•ç†ä¸­..."; 
                let u = pImgUrlElement.value; let pid = pImgPidElement.value; 
                const f = pImgFileElement.files[0]; const extUrl = pImgExternalElement.value.trim(); 
                if(f) { btn.innerText = "åœ–ç‰‡å£“ç¸®ä¸Šå‚³ä¸­..."; try { const compressedBlob = await compressImage(f); const fd = new FormData(); fd.append('file', compressedBlob); fd.append('upload_preset', CONFIG.cloudinary.preset); fd.append('folder', `inventory_app/${currentUserId}`); fd.append('tags', 'inventory_v62_optimized'); const r = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/image/upload`, {method:'POST', body:fd}); const j = await r.json(); if(j.error) throw new Error(j.error.message); u = j.secure_url; pid = j.public_id; } catch(e) { alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—: " + e.message); btn.disabled=false; btn.innerText = "â˜ï¸ ä¿å­˜ç”¢å“"; return; } } else if (extUrl) { u = extUrl; pid = ""; } 
                const promoRows = promoListElement.querySelectorAll('.promo-row'); const promos = []; let sumPct = 0; let sumCash = 0;
                promoRows.forEach(row => { const typeInput = row.querySelector('.promo-inp-s'); if (!typeInput) return; // defensive check for typeInput
                    const type = typeInput.dataset.type; 
                    const noteInput = row.querySelector('.promo-inp-l');
                    const note = noteInput ? noteInput.value : ''; // defensive check for noteInput
                    if (type === 'bogo') { 
                        const buyInput = row.querySelector('.inp-buy');
                        const getInput = row.querySelector('.inp-get');
                        const buy = buyInput ? (parseFloat(buyInput.value)||0) : 0; // defensive check
                        const get = getInput ? (parseFloat(getInput.value)||0) : 0; // defensive check
                        if(buy > 0 && get > 0) { promos.push({ type, buy, get, note }); } 
                    } else { 
                        const val = parseFloat(typeInput.value)||0; if(val > 0) { promos.push({type, val, note}); if(type==='pct') sumPct += val; if(type==='cash') sumCash += val; } 
                    } 
                }); 
                const c = app.calc(); 
                
                const dataToSave = {
                    name: name, brand: pBrandElement.value, loc: pLocElement.value,
                    qty: parseFloat(pQtyElement.value)||1, unit: pUnitElement.value,
                    spec: pSpecElement.value, exp: pExpElement.value || null, note: pNoteElement.value,
                    raw: parseFloat(pPriceElement.value)||0, is_for: pUseForElement.checked,
                    curr: pCurrElement.value, rate_ex: parseFloat(pRateElement.value)||1,
                    promos: promos,
                    disc_pct: sumPct, disc_cash: sumCash,
                    tags: currentFormTags, owners: currentFormOwners,
                    total: c.t, net: c.n, img: u, pid: pid, saved_base: ST.sets.base,
                    user_id: currentUserId
                };
                
                const editId = editIdElement.value; 
                try { 
                    if(editId) { 
                        const oldPid = pOldPidElement.value; const oldImg = pOldImgElement.value; 
                        if (oldPid && oldPid !== pid && oldImg.includes('cloudinary.com')) {
                            const { error: ghostError } = await supabase.from(TABLE_NAMES.products).insert({
                                name: "ğŸ—‘ï¸: "+name, img: oldImg, pid: oldPid, deleted: true, deleted_at: new Date().toISOString(),
                                is_ghost: true, creator_email: userSession.user.email, user_id: currentUserId,
                                raw: 0, total: 0, net: 0 // Provide defaults for NOT NULL columns
                            });
                            if (ghostError) console.error("æ–°å¢ ghost ç”¢å“å¤±æ•—:", ghostError.message);
                        }
                        dataToSave.creator_email = userSession.user.email; // Ensure creator_email is always set on update too if it's an important field
                        const { error } = await supabase.from(TABLE_NAMES.products).update(dataToSave).eq('id', editId);
                        if (error) throw error;
                        alert("æ›´æ–°æˆåŠŸ"); 
                    } else { 
                        dataToSave.created_at = new Date().toISOString();
                        dataToSave.consumed = false; dataToSave.star = false; dataToSave.deleted = false; dataToSave.is_ghost = false; 
                        dataToSave.creator_email = userSession.user.email; // Only set creator_email on initial insert
                        const { error } = await supabase.from(TABLE_NAMES.products).insert(dataToSave);
                        if (error) throw error;
                        alert("æ–°å¢æˆåŠŸ"); 
                    } 
                    app.nav('home'); 
                } catch(e) { alert("å„²å­˜å¤±æ•— (æ¬Šé™/ç¶²çµ¡): " + e.message); } finally { btn.disabled=false; btn.innerText = editId ? "âœï¸ æ›´æ–°è³‡æ–™" : "â˜ï¸ ä¿å­˜ç”¢å“"; } 
            },
            resetForm: () => { 
                const elementsToReset = ['pName','pPrice','pRate','pQty','pSpec','pExp','pNote','pTagInput','pImgFile','pImgExternal','pQty','editId','pOldPid','pOldImg','pUseFor'];
                elementsToReset.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) { // defensive check
                        if (el.type === 'checkbox') el.checked = false;
                        else el.value = '';
                    }
                });
                const promoListElement = document.getElementById('promoList');
                const addTitleElement = document.getElementById('addTitle');
                const btnSaveElement = document.getElementById('btnSave');
                if (promoListElement) promoListElement.innerHTML = ''; // defensive check
                currentFormTags = []; app.renderFormTags(); currentFormOwners = []; app.renderOwnerSelect(); 
                if (addTitleElement) addTitleElement.innerText="æ–°å¢ç”¢å“"; // defensive check
                if (btnSaveElement) btnSaveElement.innerText="â˜ï¸ ä¿å­˜ç”¢å“"; // defensive check
                const pQtyElement = document.getElementById('pQty');
                if (pQtyElement) pQtyElement.value=1; // defensive check
                app.removeImg(); 
                const pUseForElement = document.getElementById('pUseFor');
                if (pUseForElement) pUseForElement.checked=false; // defensive check
                app.toggleFor(); 
            },
            removeImg: () => { 
                const elements = ['pImgFile','pImgExternal','pImgUrl','pImgPid','imgPreview','imgPreviewBox'];
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) { // defensive check
                        if (el.type === 'file' || el.type === 'text' || el.tagName === 'INPUT') el.value = '';
                        if (el.tagName === 'IMG') el.src = '';
                        if (id === 'imgPreviewBox') el.style.display = 'none';
                    }
                });
            }, 
            prevImg: (i) => { 
                const pImgExternalElement = document.getElementById('pImgExternal');
                const imgPreviewElement = document.getElementById('imgPreview');
                const imgPreviewBoxElement = document.getElementById('imgPreviewBox');

                if (!pImgExternalElement || !imgPreviewElement || !imgPreviewBoxElement) {
                    console.error("Error: One or more image preview elements not found.");
                    return;
                }

                pImgExternalElement.value = ""; 
                if(i.files[0]) { 
                    imgPreviewElement.src=URL.createObjectURL(i.files[0]); 
                    imgPreviewBoxElement.style.display='block'; 
                } 
            }, 
            prevExternal: (url) => { 
                const pImgFileElement = document.getElementById('pImgFile');
                const imgPreviewElement = document.getElementById('imgPreview');
                const imgPreviewBoxElement = document.getElementById('imgPreviewBox');

                if (!pImgFileElement || !imgPreviewElement || !imgPreviewBoxElement) {
                    console.error("Error: One or more image preview elements not found.");
                    return;
                }

                if(url) { 
                    pImgFileElement.value = ""; 
                    imgPreviewElement.src = url; 
                    imgPreviewBoxElement.style.display = 'block'; 
                } 
            }, 
            lb: (url) => { 
                const lbImgElement = document.getElementById('lbImg');
                const lightboxElement = document.getElementById('lightbox');

                if (!lbImgElement || !lightboxElement) {
                    console.error("Error: 'lbImg' or 'lightbox' element not found.");
                    return;
                }

                lbImgElement.src=url; 
                lightboxElement.style.display='flex'; 
            },
            comp: (name, brand) => { 
                const list = ST.prods.filter(p => !p.deleted && p.name === name); list.sort((a,b) => a.net - b.net); 
                const minPrice = list.length ? list[0].net : 0; const bs = app.getSym(); 

                const compareInfoElement = document.getElementById('compareInfo');
                const compareBodyElement = document.getElementById('compareBody');

                if (!compareInfoElement || !compareBodyElement) {
                    console.error("Error: One or more compare view elements not found.");
                    // Return default values or throw to prevent further errors
                    return { t: 0, n: 0 };
                }

                compareInfoElement.innerText = `æ¯”åƒ¹: ${name} (å…±${list.length}ç­†)`; 
                compareBodyElement.innerHTML = list.map(p => { const thumbUrl = getThumb(p.img, 100); const thumb = p.img ? `<img src="${thumbUrl}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;float:left;margin-right:8px;" onclick="app.lb('${p.img}')">` : `<div style="width:40px;height:40px;background:#eee;float:left;margin-right:8px;display:flex;align-items:center;justify-content:center;">ğŸ“·</div>`; const isCheap = (p.net === minPrice); let priceDisplay = `<div><b>${bs}${p.total}</b></div>`; if (p.isFor && p.curr !== ST.sets.base) priceDisplay += `<div style="color:#666;font-size:0.85rem;">(${app.getForSym(p.curr)}${p.raw})</div>`; let discInfo = ""; if(p.promos && p.promos.length > 0) { p.promos.forEach(x => { if(x.type==='pct') discInfo += `<span class="tag-disc">â†“${x.val}%</span>`; else if(x.type==='cash') discInfo += `<span class="tag-disc">-$${x.val}</span>`; else if(x.type==='bogo') discInfo += `<span class="tag-bogo">è²·${x.buy}é€${x.get}</span>`; }); } else if(p.DiscPct || p.DiscCash) { if(p.DiscPct) discInfo += `<span class="tag-disc">â†“${p.DiscPct}%</span>`; if(p.DiscCash) discInfo += `<span class="tag-disc">-$${p.DiscCash}</span>`; } if(discInfo) priceDisplay += `<div style="margin-top:2px;">${discInfo}</div>`; const bogoInfo = app.getBogoInfo(p); if(bogoInfo) priceDisplay += `<div style="margin-top:2px; font-size:0.8rem; color:var(--action); font-weight:bold;">${bogoInfo}</div>`; const statusHtml = `<div style="display:flex; flex-direction:column; gap:8px; align-items:flex-start;"><label class="chk-lbl" style="font-size:0.85rem;"><input type="checkbox" ${p.consumed?'checked':''} onchange="app.upd('${p.id}',{consumed:this.checked})"> å·²ç”¨</label><label class="chk-lbl" style="font-size:0.85rem;"><input type="checkbox" ${p.star?'checked':''} onchange="app.upd('${p.id}',{star:this.checked})"> â­ï¸</label></div>`; return `<tr class="${isCheap?'row-cheap':''}"><td onclick="app.detail('${p.id}')">${thumb} <b>${p.brand}</b><br><small>${p.loc}</small></td><td style="color:${isCheap?'#e65100':'var(--danger)'};font-weight:bold;">${bs}${p.net}${isCheap?" <span class='badge-cheap'>ğŸ†</span>":""}</td><td>${p.qty}${p.unit}<br><span style="font-size:0.8rem;color:#777;">${p.spec||''}</span></td><td>${priceDisplay}</td><td>${statusHtml}</td></tr>`; }).join(''); app.nav('compare'); 
            },
            toggleFor: () => { 
                const pUseForElement = document.getElementById('pUseFor');
                const pCurrElement = document.getElementById('pCurr');
                const forAreaElement = document.getElementById('forArea');

                if (!pUseForElement || !pCurrElement || !forAreaElement) {
                    console.error("Error: One or more currency toggle elements not found.");
                    return;
                }

                const c = pUseForElement.checked; 
                pCurrElement.disabled = !c; 
                forAreaElement.classList.toggle('hidden', !c); 
                if(c && !pCurrElement.value) pCurrElement.value='USD'; 
                app.updRateLabel(); app.calc(); 
            }, 
            updRateLabel: () => { 
                const pCurrElement = document.getElementById('pCurr');
                const pRateElement = document.getElementById('pRate');
                const rateLabelElement = document.getElementById('rateLabel');

                if (!pCurrElement || !pRateElement || !rateLabelElement) {
                    console.error("Error: One or more rate label elements not found.");
                    return;
                }

                const f = pCurrElement.value; 
                const b = ST.sets.base; 
                const r = pRateElement.value || '?'; 
                rateLabelElement.innerText = `1 ${f} = ${r} ${b}`; 
            },
            calc: () => { 
                const pPriceElement = document.getElementById('pPrice');
                const promoListElement = document.getElementById('promoList');
                const pQtyElement = document.getElementById('pQty');
                const pUseForElement = document.getElementById('pUseFor');
                const pRateElement = document.getElementById('pRate');
                const pCurrElement = document.getElementById('pCurr');
                const calcForResElement = document.getElementById('calcForRes');
                const calcResElement = document.getElementById('calcRes');

                if (!pPriceElement || !promoListElement || !pQtyElement || !pUseForElement || !pRateElement || !pCurrElement || !calcForResElement || !calcResElement) {
                    console.error("Error: One or more calculation elements not found.");
                    // Return default values or throw to prevent further errors
                    return { t: 0, n: 0 };
                }

                const raw = parseFloat(pPriceElement.value)||0; 
                let pct = 0; let cash = 0; let bogoCount = 0; 
                promoListElement.querySelectorAll('.promo-row').forEach(row => { 
                    const typeInput = row.querySelector('.promo-inp-s');
                    if (!typeInput) return; // defensive check
                    const type = typeInput.dataset.type; 
                    if (type === 'bogo') { 
                        const buyInput = row.querySelector('.inp-buy');
                        const getInput = row.querySelector('.inp-get');
                        const buy = buyInput ? (parseFloat(buyInput.value)||0) : 0; // defensive check
                        const get = getInput ? (parseFloat(getInput.value)||0) : 0; // defensive check
                        if(buy > 0 && get > 0) { bogoCount = buy + get; } 
                    } else { 
                        const val = parseFloat(typeInput.value)||0; if(val > 0) { pct += (type === 'pct' ? val : 0); cash += (type === 'cash' ? val : 0); } 
                    } 
                }); 
                let valFor = raw * (1 - pct/100) - cash; 
                if(valFor < 0) valFor = 0; 
                let valBase = valFor; 
                const isFor = pUseForElement.checked; 
                if(isFor) { 
                    valBase = valFor * (parseFloat(pRateElement.value)||1); 
                    calcForResElement.innerText = `å¤–å¹£å¯¦ä»˜: ${app.getForSym(pCurrElement.value)}${valFor.toFixed(2)}`; 
                } else { 
                    calcForResElement.innerText = ""; 
                } 
                let perPackHtml = ""; 
                if (bogoCount > 1) { const packPrice = valBase / bogoCount; perPackHtml = ` <B style="color:#e65100;">(æ¯çµ„/åŒ…: ${app.getSym()}${packPrice.toFixed(2)})</B>`; } 
                const q = parseFloat(pQtyElement.value)||1; 
                const net = valBase/q; 
                calcResElement.innerHTML = `æœ¬å¹£å¯¦ä»˜: ${app.getSym()}${valBase.toFixed(2)}${perPackHtml} <span style="font-size:0.9rem; color:#666; font-weight:normal;">(å–®: ${app.getSym()}${net.toFixed(2)})</span>`; 
                return { t: Number(valBase.toFixed(2)), n: Number(net.toFixed(2)) }; 
            },
            upd: async (id, o) => {
                const { error } = await supabase.from(TABLE_NAMES.products).update(o).eq('id', id);
                if (error) { alert("æ›´æ–°å¤±æ•— (æ¬Šé™): " + error.message); }
            },
            auth: async () => {
                if (!supabase) { alert("âš ï¸ ç³»çµ±æœªå•Ÿå‹•ï¼\nè«‹æª¢æŸ¥ Supabase Configã€‚"); return; }
                const logEmailElement = document.getElementById('logEmail');
                const logPwdElement = document.getElementById('logPwd');
                const btnLoginElement = document.getElementById('btnLogin');
                const authErrElement = document.getElementById('authErr');

                if (!logEmailElement || !logPwdElement || !btnLoginElement || !authErrElement) {
                    console.error("Error: One or more authentication elements not found.");
                    alert("ç™»å…¥/è¨»å†Šå¤±æ•—: é é¢å…ƒç´ ä¸å®Œæ•´ã€‚");
                    return;
                }

                const e = logEmailElement.value.trim();
                const p = logPwdElement.value.trim();
                if(!e || !p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
                const btn = btnLoginElement;
                const errBox = authErrElement;
                btn.disabled = true; btn.innerText = "é©—è­‰ä¸­..."; errBox.innerText = "";

                let { data, error } = await supabase.auth.signInWithPassword({ email: e, password: p });

                if (error) {
                    if (error.message.includes('Invalid login credentials') || error.message.includes('Email not confirmed') || error.message.includes('User not found')) {
                        let { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email: e, password: p });
                        if (signUpError) {
                            if (signUpError.message.includes('User already registered')) {
                                errBox.innerText = "âš ï¸ å¸³è™Ÿå·²å­˜åœ¨ï¼Œä½†å¯†ç¢¼éŒ¯èª¤æˆ–æœªé©—è­‰ã€‚è«‹æª¢æŸ¥éƒµç®±ä»¥é©—è­‰å¸³è™Ÿã€‚";
                            } else if (signUpError.message.includes('Password should be at least 6 characters')) {
                                errBox.innerText = "âš ï¸ å¯†ç¢¼å¤ªå¼±ï¼Œè«‹è‡³å°‘è¼¸å…¥ 6 ä½æ•¸ã€‚";
                            } else {
                                errBox.innerText = "è¨»å†Šå¤±æ•—: " + signUpError.message;
                            }
                        } else {
                            if (signUpData.user && signUpData.session) {
                                btn.innerText = "è¨»å†ŠæˆåŠŸï¼Œè«‹æª¢æŸ¥éƒµç®±ä»¥é©—è­‰å¸³è™Ÿã€‚";
                                alert("è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„éƒµç®±ä¸¦é©—è­‰å¸³è™Ÿï¼Œç„¶å¾Œé‡æ–°ç™»å…¥ã€‚");
                                await supabase.auth.signOut();
                            } else if (signUpData.user) {
                                btn.innerText = "è¨»å†ŠæˆåŠŸï¼Œè«‹æª¢æŸ¥éƒµç®±ä»¥é©—è­‰å¸³è™Ÿã€‚";
                                alert("è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„éƒµç®±ä¸¦é©—è­‰å¸³è™Ÿï¼Œç„¶å¾Œé‡æ–°ç™»å…¥ã€‚");
                                await supabase.auth.signOut();
                            }
                        }
                    } else {
                        errBox.innerText = "ç™»å…¥éŒ¯èª¤: " + error.message;
                    }
                } else {
                    btn.innerText = "ç™»å…¥æˆåŠŸ...";
                }
                btn.disabled = false; btn.innerText = "ç™»å…¥ / è¨»å†Š";
            },
            logout: async () => {
                const { error } = await supabase.auth.signOut();
                if (error) { console.error("ç™»å‡ºå¤±æ•—:", error.message); alert("ç™»å‡ºå¤±æ•—: " + error.message); }
                else { location.reload(); }
            },
            suggest: (v) => { 
                const b = document.getElementById('suggestionBox'); 
                if (!b) { console.error("Error: 'suggestionBox' element not found."); return; } // defensive check
                if(!v) { b.style.display='none'; return; } 
                const hits = ST.prods.filter(p=> !p.deleted && p.name.includes(v)).slice(0,5); 
                b.innerHTML = hits.map(p=>`<div class="suggest-item" onclick="app.loadToForm('${p.id}', false)"><img class="s-img" src="${p.img||''}"><div><div class="s-info">${p.name}</div><div style="font-size:0.9rem;color:#888;">${p.brand} | $${p.net}/${p.unit}</div></div></div>`).join(''); 
                b.style.display = hits.length ? 'block' : 'none'; 
            },
            navToAdd: () => { app.resetForm(); app.nav('add'); }, 
            nav: (v) => { 
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); 
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 

                const viewElement = document.getElementById('view-'+v);
                const navElement = document.getElementById('nav-'+v);
                const backBtnElement = document.getElementById('backBtn');
                const editIdElement = document.getElementById('editId');

                if (viewElement) viewElement.classList.add('active'); else console.error(`Error: View element 'view-${v}' not found.`);
                if (navElement) navElement.classList.add('active'); else console.error(`Error: Nav item 'nav-${v}' not found.`);

                if(v==='home') { 
                    if (backBtnElement) backBtnElement.style.display='none'; 
                    app.updHeaderRole(); app.renderHome(); 
                } else if(v==='add' && editIdElement && !editIdElement.value) { // defensive check for editIdElement
                    app.resetForm();
                } else if(v==='trash') {
                    app.renderTrash();
                } else {
                    if (backBtnElement) backBtnElement.style.display='block'; 
                }
                window.scrollTo(0,0); 
            },
            
            // Helper to update an array field in global_settings
            updateGlobalSettingsArray: async (field, oldValue, newValue = null, remove = false) => {
                const { data: currentSettings, error: fetchError } = await supabase.from(TABLE_NAMES.global_settings).select(field).eq('id', 1).single();
                if (fetchError) throw fetchError;

                let currentArray = currentSettings[field] || [];
                let newArray;

                if (remove) {
                    newArray = currentArray.filter(item => item !== oldValue);
                } else if (newValue !== null) { // Edit
                    newArray = currentArray.map(item => item === oldValue ? newValue : item);
                } else { // Add (newValue is implicitly oldValue)
                    if (!currentArray.includes(oldValue)) {
                        newArray = [...currentArray, oldValue];
                    } else {
                        newArray = currentArray; // No change needed
                    }
                }

                if (JSON.stringify(newArray.sort()) === JSON.stringify(currentArray.sort())) {
                    return { data: null, error: null }; // No actual change
                }

                const { data, error } = await supabase.from(TABLE_NAMES.global_settings).update({ [field]: newArray }).eq('id', 1);
                if (error) throw error;
                return { data, error };
            },

            addOpt: async (type, id) => {
                const el = document.getElementById(id); 
                if (!el) { console.error(`Error: Element '${id}' not found.`); return; } // defensive check
                const v = el.value.trim(); if(!v) return;
                try {
                    await app.updateGlobalSettingsArray(type, v);
                    el.value='';
                } catch(e) { alert('æ–°å¢å¤±æ•— (æ¬Šé™): '+e.message); }
            },
            delOpt: async (type, val) => {
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šä¸€èˆ¬ç”¨æˆ¶ç„¡æ³•åˆªé™¤é¸é …ã€‚");
                let isUsed = false;
                if (type === 'owners') isUsed = ST.prods.some(p => !p.deleted && p.owners && p.owners.includes(val));
                else { const map = { brands: 'brand', locs: 'loc', units: 'unit' }; isUsed = ST.prods.some(p => !p.deleted && p[map[type]] === val); }
                if (isUsed) return alert(`âŒ ç„¡æ³•åˆªé™¤ [${val}]ï¼Œå› ç‚ºç›®å‰æœ‰ç”¢å“æ­£åœ¨ä½¿ç”¨æ­¤é¸é …ã€‚`);
                if(!confirm(`ç¢ºå®šç§»é™¤å…¨åŸŸé¸é … [${val}]ï¼Ÿ`)) return;
                try {
                    await app.updateGlobalSettingsArray(type, val, null, true);
                } catch(e) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: "+e.message); }
            },
            editOpt: async (type, oldVal) => {
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³");
                const newVal = prompt(`å°‡æ¨™ç±¤ [#${oldVal}] æ”¹åç‚º:`, oldVal); if(!newVal || newVal === oldVal) return;
                try {
                    await app.updateGlobalSettingsArray(type, oldVal, newVal);
                    if (type !== 'owners') {
                        const map = { brands:'brand', locs:'loc', units:'unit' };
                        const fieldToUpdate = map[type];
                        const { error: updateProdError } = await supabase.from(TABLE_NAMES.products)
                            .update({ [fieldToUpdate]: newVal })
                            .eq(fieldToUpdate, oldVal);
                        if (updateProdError) throw updateProdError;
                    }
                    alert("æ›´æ–°å®Œæˆ");
                } catch(e) { alert("æ›´æ–°å¤±æ•—: "+e.message); }
            },
            cleanUnusedOpts: async () => {
                if(!app.getRole().isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šåƒ… Admin å¯åŸ·è¡Œæ¸…ç†ã€‚");
                if(!confirm("âš ï¸ ç¢ºå®šè¦ç§»é™¤æ‰€æœ‰ã€Œç›®å‰æ²’è¢«ä»»ä½•ç”¢å“ä½¿ç”¨ã€çš„é¸é …å—ï¼Ÿ")) return;

                const usedBrands = new Set(); const usedLocs = new Set(); const usedUnits = new Set(); const usedOwners = new Set();
                ST.prods.forEach(p => { if(!p.deleted) {
                    if(p.brand) usedBrands.add(p.brand); if(p.loc) usedLocs.add(p.loc); if(p.unit) usedUnits.add(p.unit);
                    if(p.owners) p.owners.forEach(o => usedOwners.add(o));
                }});

                const newBrands = (ST.sets.brands || []).filter(x => usedBrands.has(x));
                const newLocs = (ST.sets.locs || []).filter(x => usedLocs.has(x));
                const newUnits = (ST.sets.units || []).filter(x => usedUnits.has(x));
                const newOwners = (ST.sets.owners || []).filter(x => usedOwners.has(x));

                try {
                    const { error } = await supabase.from(TABLE_NAMES.global_settings).update({
                        brands: newBrands, locs: newLocs, units: newUnits, owners: newOwners
                    }).eq('id', 1);
                    if (error) throw error;
                    alert("ğŸ§¹ æ¸…ç†å®Œæˆï¼");
                } catch(e) { alert("éŒ¯èª¤: "+e.message); }
            },
            saveSet: async () => {
                const baseCurrElement = document.getElementById('baseCurr');
                const btnBaseSaveElement = document.getElementById('btnBaseSave');

                if (!baseCurrElement || !btnBaseSaveElement) {
                    console.error("Error: 'baseCurr' or 'btnBaseSave' element not found.");
                    return;
                }

                const newBase = baseCurrElement.value; const oldBase = ST.sets.base;
                if(newBase === oldBase) return alert("å¹£åˆ¥æœªæ”¹è®Š");
                if(!confirm(`ç¢ºå®šè®Šæ›´æœ¬å¹£ [${oldBase}] -> [${newBase}]ï¼Ÿ`)) return;
                const btn=btnBaseSaveElement; btn.disabled=true; btn.innerText="å„²å­˜ä¸­...";
                try {
                    const nowStr = app.fmtTime(Date.now());
                    const { error: settingsError } = await supabase.from(TABLE_NAMES.global_settings).update({ base_currency: newBase }).eq('id', 1);
                    if (settingsError) throw settingsError;

                    const updatePromises = ST.prods.map(p => {
                        const log = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n[ç³»çµ±é€šçŸ¥] åŒ¯ç‡åŸºæº–è®Šæ›´\nâ€¢ æ™‚é–“: ${nowStr}\nâ€¢ è®Šæ›´: ${oldBase} â” ${newBase}\nâ€¢ é‡‘é¡æœªè®Šï¼Œåƒ…æ›´æ–°å–®ä½ç¬¦è™Ÿ\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                        return supabase.from(TABLE_NAMES.products).update({
                            note: (p.note || '') + log,
                            saved_base: oldBase
                        }).eq('id', p.id);
                    });
                    await Promise.all(updatePromises);
                    alert("å·²æ›´æ–°è¨­å®š");
                } catch (e) { alert("è¨­å®šæ›´æ–°å¤±æ•—: " + e.message); } finally { btn.disabled=false; btn.innerText="å„²å­˜ä¿®æ”¹"; }
            },

            addAdmin: async (emTarget) => {
                const newAdminEmailElement = document.getElementById('newAdminEmail');
                if (!newAdminEmailElement) { console.error("Error: 'newAdminEmail' element not found."); return; } // defensive check

                const em = emTarget || newAdminEmailElement.value.trim();
                if(!em) return;
                if(!app.getRole().isAdmin) return alert("æ¬Šé™ä¸è¶³");
                try {
                    const { data: currentSettings, error: fetchError } = await supabase.from(TABLE_NAMES.global_settings).select('admin_emails, all_user_emails').eq('id', 1).single();
                    if (fetchError) throw fetchError;

                    let newAdmins = [...(currentSettings.admin_emails || [])];
                    if (!newAdmins.includes(em)) {
                        newAdmins.push(em);
                    }

                    let newAllUsers = [...(currentSettings.all_user_emails || [])];
                    if (!newAllUsers.includes(em)) {
                        newAllUsers.push(em);
                    }

                    const { error } = await supabase.from(TABLE_NAMES.global_settings).update({
                        admin_emails: newAdmins,
                        all_user_emails: newAllUsers
                    }).eq('id', 1);
                    if (error) throw error;

                    newAdminEmailElement.value = '';
                } catch(e) { alert("æˆæ¬Šå¤±æ•—: " + e.message); }
            },
            
            delAdmin: async (em) => {
                if(!app.getRole().isAdmin) return alert("æ¬Šé™ä¸è¶³");
                if(em === ST.sets.superAdmin) return alert("âŒ ç¦æ­¢ç§»é™¤è¶…ç´šç®¡ç†å“¡ï¼");
                if(!confirm(`âš ï¸ ç¢ºå®šè¦å°‡ [${em}] é™ç´šç‚ºä¸€èˆ¬ç”¨æˆ¶ï¼Ÿ`)) return;
                try {
                    const { data: currentSettings, error: fetchError } = await supabase.from(TABLE_NAMES.global_settings).select('admin_emails').eq('id', 1).single();
                    if (fetchError) throw fetchError;

                    const newAdmins = (currentSettings.admin_emails || []).filter(adminEm => adminEm !== em);

                    const { error } = await supabase.from(TABLE_NAMES.global_settings).update({ admin_emails: newAdmins }).eq('id', 1);
                    if (error) throw error;
                } catch(e) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: "+e.message); }
            },
            
            editTag: async (oldT) => {
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³");
                const newT = prompt(`å°‡æ¨™ç±¤ [#${oldT}] æ”¹åç‚º:`, oldT); if(!newT || newT === oldT) return;
                try {
                    await app.updateGlobalSettingsArray('tags', oldT, newT);

                    const { data: productsWithTag, error: fetchProdsError } = await supabase.from(TABLE_NAMES.products)
                        .select('id, tags')
                        .contains('tags', [oldT]);
                    if (fetchProdsError) throw fetchProdsError;

                    let count = 0;
                    const updatePromises = productsWithTag.map(p => {
                        const updatedTags = (p.tags || []).map(tag => tag === oldT ? newT : tag);
                        count++;
                        return supabase.from(TABLE_NAMES.products).update({ tags: updatedTags }).eq('id', p.id);
                    });
                    await Promise.all(updatePromises);

                    alert(`âœ… å·²æ›´æ–° ${count} å€‹ç”¢å“çš„æ¨™ç±¤`);
                } catch(e) { alert("æ›´æ–°å¤±æ•—: "+e.message); }
            },
            delTag: async (t) => {
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³");
                const isUsed = ST.prods.some(p => !p.deleted && p.tags && p.tags.includes(t));
                if (isUsed) return alert(`âŒ ç„¡æ³•åˆªé™¤æ¨™ç±¤ [#${t}]ï¼Œå› ç‚ºå…¶æ­£åœ¨ä½¿ç”¨ä¸­ã€‚`);
                if(!confirm(`âš ï¸ ç¢ºå®šç§»é™¤å…¨åŸŸæ¨™ç±¤ [#${t}]ï¼Ÿ`)) return;
                try {
                    await app.updateGlobalSettingsArray('tags', t, null, true);
                } catch(e) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: "+e.message); }
            }
        };

        async function syncData() {
            if(!currentUserId) return;
            if (settingsUnsub) { settingsUnsub.unsubscribe(); settingsUnsub = null; }

            // å¯¦æ™‚ç›£è½è¨­å®š
            settingsUnsub = supabase
                .from(TABLE_NAMES.global_settings)
                .select('*')
                .eq('id', 1)
                .single()
                .on('POSTGRES_CHANGES', { event: '*', schema: 'public', table: TABLE_NAMES.global_settings, filter: 'id=eq.1' }, payload => {
                    ST.sets = { ...DEFAULT_SETS, ...app.mapSupabaseSettings(payload.new) };
                    const currentEmail = userSession.user.email;
                    if (currentEmail && !(ST.sets.allUsers || []).includes(currentEmail)) {
                        // åœ¨æ­¤è™•æ›´æ–° all_user_emails (Supabase é™£åˆ—æ›´æ–°éœ€è¦å…ˆè®€å–å†å¯«å…¥)
                        supabase.from(TABLE_NAMES.global_settings)
                            .select('all_user_emails')
                            .eq('id', 1)
                            .single()
                            .then(({ data, error }) => {
                                if (data && !data.all_user_emails.includes(currentEmail)) {
                                    const newAllUsers = [...data.all_user_emails, currentEmail];
                                    supabase.from(TABLE_NAMES.global_settings)
                                        .update({ all_user_emails: newAllUsers })
                                        .eq('id', 1)
                                        .catch(e => console.warn("å¯«å…¥ç”¨æˆ¶æ¸…å–®æ¬Šé™ä¸è¶³ï¼Œç•¥é", e));
                                }
                            });
                    }
                    renderSets(); app.updHeaderRole(); syncProducts();
                })
                .subscribe();

            // é¦–æ¬¡è®€å–è¨­å®š
            const { data, error } = await supabase.from(TABLE_NAMES.global_settings).select('*').eq('id', 1).single();

            if (error && error.code === 'PGRST116') { // No rows found
                const currentUserEmail = userSession.user.email;
                const initData = { ...DEFAULT_SETS, superAdmin: currentUserEmail, admins: [currentUserEmail], allUsers: [currentUserEmail] };
                const { error: insertError } = await supabase.from(TABLE_NAMES.global_settings).upsert({
                    id: 1,
                    brands: initData.brands,
                    locs: initData.locs,
                    units: initData.units,
                    owners: initData.owners,
                    tags: initData.tags,
                    base_currency: initData.base,
                    super_admin_email: initData.superAdmin,
                    admin_emails: initData.admins,
                    all_user_emails: initData.allUsers, // ä¿®æ­£: æ¬„ä½åç¨±
                    global_view_enabled: initData.globalViewEnabled
                }, { onConflict: 'id' });
                if (insertError) {
                    console.error("åˆå§‹åŒ–è¨­å®šæª”å¤±æ•—:", insertError);
                    displayLoadingError("åˆå§‹åŒ–å¤±æ•—: " + insertError.message);
                } else {
                    ST.sets = initData;
                }
            } else if (error) {
                console.error("è¨­å®šè®€å–å¤±æ•—:", error);
                ST.sets = DEFAULT_SETS;
                displayLoadingError("è¨­å®šè®€å–å¤±æ•—: " + error.message);
            } else {
                ST.sets = { ...DEFAULT_SETS, ...app.mapSupabaseSettings(data) };
                const currentEmail = userSession.user.email;
                // å¦‚æœæ˜¯é¦–æ¬¡è¼‰å…¥ï¼Œç¢ºä¿ç•¶å‰ç”¨æˆ¶åœ¨ all_user_emails ä¸­
                if (currentEmail && !(ST.sets.allUsers || []).includes(currentEmail)) {
                    const newAllUsers = [...(ST.sets.allUsers || []), currentEmail];
                    supabase.from(TABLE_NAMES.global_settings)
                        .update({ all_user_emails: newAllUsers })
                        .eq('id', 1)
                        .then(res => { if(res.error) console.warn("æ›´æ–°æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨å¤±æ•—", res.error); })
                        .catch(e => console.warn("æ›´æ–°æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨ç•°å¸¸", e));
                    ST.sets.allUsers = newAllUsers; // ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹
                }
            }
            renderSets(); app.updHeaderRole(); syncProducts();
        }

        async function syncProducts() {
            if(productsUnsub) { productsUnsub.unsubscribe(); productsUnsub = null; }

            let query = supabase.from(TABLE_NAMES.products).select('*');

            const role = app.getRole();
            if (!role.isAdmin && ST.sets.globalViewEnabled === false) {
                query = query.eq('creator_email', userSession.user.email);
            }

            const loadingOverlayElement = document.getElementById('loadingOverlay');

            // å¯¦æ™‚ç›£è½ç”¢å“
            productsUnsub = query
                .order('created_at', { ascending: false })
                .on('POSTGRES_CHANGES', { event: '*', schema: 'public', table: TABLE_NAMES.products }, payload => {
                    // ç‚ºäº†ç°¡åŒ–ï¼Œæ”¶åˆ°ä»»ä½•è®Šæ›´äº‹ä»¶éƒ½é‡æ–°æŠ“å–å…¨éƒ¨ç”¢å“
                    supabase.from(TABLE_NAMES.products).select('*')
                        .then(({data, error}) => {
                            if (!error) {
                                ST.prods = data.map(app.mapSupabaseProduct);
                                app.renderHome(); app.renderExps(); app.renderStar(); app.updTrashCount();
                                if(document.getElementById('view-trash').classList.contains('active')) app.renderTrash();
                                if (loadingOverlayElement) loadingOverlayElement.style.display='none'; // defensive check
                            } else {
                                console.error("ç”¢å“å³æ™‚æ›´æ–°å¤±æ•—:", error.message);
                                displayLoadingError("ç”¢å“å³æ™‚æ›´æ–°å¤±æ•—: " + error.message);
                            }
                        });
                })
                .subscribe();

            // é¦–æ¬¡è®€å–ç”¢å“
            const { data, error } = await query.order('created_at', { ascending: false });
            if (error) {
                displayLoadingError("ç”¢å“è®€å–å¤±æ•—: " + error.message);
            } else {
                ST.prods = data.map(app.mapSupabaseProduct);
                app.renderHome(); app.renderExps(); app.renderStar(); app.updTrashCount();
                if(document.getElementById('view-trash').classList.contains('active')) app.renderTrash();
                if (loadingOverlayElement) loadingOverlayElement.style.display='none'; // defensive check
            }
        }

        // ğŸ›  ä¿®å¾© Issue 3: æ¸²æŸ“å…¨åŸŸåˆ—è¡¨æ™‚ï¼Œå…¨éƒ¨ä½¿ç”¨ `app.sortArr` å°‡é¸é …æŒ‰å­—æ¯é€²è¡Œå®Œç¾æ’åº
        function renderSets() { 
            const role = app.getRole(); const isAdmin = role.isAdmin; const isSuper = role.isSuper;
            
            // ä½¿ç”¨æ–°å¢åŠ çš„æ’åºå‡½æ•¸è™•ç†æ‰€æœ‰å…¨åŸŸæ¸…å–®
            const sBrands = app.sortArr(ST.sets.brands);
            const sLocs = app.sortArr(ST.sets.locs);
            const sUnits = app.sortArr(ST.sets.units);
            const sOwners = app.sortArr(ST.sets.owners);
            const sTags = app.sortArr(ST.sets.tags);

            // Defensive checks for elements in renderSets
            const fBrandElement = document.getElementById('fBrand');
            const fLocElement = document.getElementById('fLoc');
            const fExpOwnerElement = document.getElementById('fExpOwner');
            const fStarOwnerElement = document.getElementById('fStarOwner');
            const pBrandElement = document.getElementById('pBrand');
            const pLocElement = document.getElementById('pLoc');
            const pUnitElement = document.getElementById('pUnit');
            const pCurrElement = document.getElementById('pCurr');
            const baseCurrElement = document.getElementById('baseCurr');
            const setOptsElement = document.getElementById('setOpts');
            const adminMgmtCardElement = document.getElementById('adminMgmtCard');
            const btnCleanElement = document.querySelector('.btn-clean');
            const globalViewToggleElement = document.getElementById('globalViewToggle');
            const tagMgmtElement = document.getElementById('tagMgmt');
            const adminListElement = document.getElementById('adminList');
            const adminInputAreaElement = document.getElementById('adminInputArea');

            const fill = (id, arr, label) => { 
                const el = document.getElementById(id); 
                if (el) el.innerHTML = `<option value="">${label}</option>` + arr.map(x=>`<option value="${x}">${x}</option>`).join(''); 
            }; 
            if (fBrandElement) fill('fBrand', sBrands, 'å…¨éƒ¨å“ç‰Œ'); 
            if (fLocElement) fill('fLoc', sLocs, 'å…¨éƒ¨åœ°é»'); 
            const buildOwnerSelect = (arr) => `<option value="">ğŸ‘¤ æ‰€æœ‰æˆå“¡</option>` + (arr||[]).map(x=>`<option value="${x}">${x.split('@')[0]}</option>`).join('');
            if (fExpOwnerElement) fExpOwnerElement.innerHTML = buildOwnerSelect(sOwners); 
            if (fStarOwnerElement) fStarOwnerElement.innerHTML = buildOwnerSelect(sOwners);
            
            const fillPure = (id, arr) => { 
                const el = document.getElementById(id); 
                if (el) el.innerHTML = arr.map(x=>`<option value="${x}">${x}</option>`).join(''); 
            }; 
            if (pBrandElement) fillPure('pBrand', sBrands); 
            if (pLocElement) fillPure('pLoc', sLocs); 
            if (pUnitElement) pUnitElement.innerHTML = sUnits.map(x=>`<option value="${x}">${x}</option>`).join(''); 
            
            const cs = CURRS.map(x=>`<option value="${x}">${x}</option>`).join(''); 
            if (pCurrElement) pCurrElement.innerHTML = cs; 
            if (baseCurrElement) {
                baseCurrElement.innerHTML = cs; 
                baseCurrElement.value = ST.sets.base; 
            }
            
            const delBtn = (type, val) => isAdmin ? `<span class="setting-del-btn" onclick="app.delOpt('${type}','${val.replace(/'/g,"\\'")}')">&times;</span>` : '';
            const mkList = (label, type, arr) => `<div class="form-group"><label class="form-label">${label}</label><div class="form-row"><input id="inp_${type}" class="form-control" placeholder="æ–°å¢"><button class="btn-mini" onclick="app.addOpt('${type}','inp_${type}')">åŠ </button></div><div style="margin-top:10px;line-height:2;">${arr.map(v => `<span class="setting-item-pill"><span class="setting-edit-txt" onclick="app.editOpt('${type}','${v.replace(/'/g,"\\'")}')">${v}</span> ${delBtn(type,v)}</span>`).join('')}</div></div><hr>`; 
            
            if (setOptsElement) { // defensive check
                // ä»¥ä¸‹çµ±ä¸€ä»£å…¥å·²ç¶“ Sort éçš„é™£åˆ—
                setOptsElement.innerHTML = mkList('æ‰€æœ‰äººæ¸…å–® (Owners)', 'owners', sOwners) + mkList('å“ç‰Œæ¸…å–®', 'brands', sBrands) + mkList('åœ°é»æ¸…å–®', 'locs', sLocs) + mkList('å–®ä½æ¸…å–®', 'units', sUnits); 
            }

            if(isAdmin) { 
                if (adminMgmtCardElement) adminMgmtCardElement.classList.remove('hidden'); 
                
                if (isSuper) {
                    const rawUsers = ST.sets.allUsers || [];
                    const adminUsers = ST.sets.admins || [];
                    const superAdminEmail = ST.sets.superAdmin;
                    // åˆä½µæ‰€æœ‰ç›¸é—œéƒµç®±ä¸¦å»é‡ï¼Œç„¶å¾Œæ’åº
                    const allUsersEmailsSet = new Set([...rawUsers, ...adminUsers, superAdminEmail].filter(Boolean));

                    if (adminListElement) { // defensive check
                        adminListElement.innerHTML = Array.from(allUsersEmailsSet).sort((a,b) => a.localeCompare(b)).map(em => {
                            let uRole = 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ¶';
                            let badgeStyle = 'background:#f5f5f5; color:#555; border:1px solid #ddd;';
                            let btnHtml = `<button class="btn-mini" style="background:#f0f8ff; color:#0277bd; border-color:#81d4fa; width:80px;" onclick="app.addAdmin('${em}')">â¬†ï¸ å‡æ¬Šé™</button>`;

                            if (em === superAdminEmail) {
                                uRole = 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡';
                                badgeStyle = 'background:#8e44ad; color:white; border:none;';
                                btnHtml = `<span style="font-size:0.8rem; color:#999; margin-right:8px;">ç„¡å¯æ“ä½œ</span>`;
                            } else if (adminUsers.includes(em)) {
                                uRole = 'ğŸ›¡ï¸ ç®¡ç†å“¡';
                                badgeStyle = 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;';
                                btnHtml = `<button class="btn-mini" style="background:#ffebee; color:#c62828; border-color:#ffcdd2; width:80px;" onclick="app.delAdmin('${em}')">â¬‡ï¸ é™ç´š</button>`;
                            }

                            return `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px dashed #eee;">
                                <div style="flex:1; min-width:0; margin-right:10px;">
                                    <div style="font-weight:600; font-size:0.95rem; word-break:break-all; color:#333;">${em}</div>
                                    <span style="font-size:0.75rem; padding:2px 8px; border-radius:12px; margin-top:4px; display:inline-block; ${badgeStyle}">${uRole}</span>
                                </div>
                                <div style="flex-shrink:0;">${btnHtml}</div>
                            </div>`;
                        }).join('');
                    }
                } else {
                    if (adminInputAreaElement) adminInputAreaElement.style.display = 'none'; // defensive check
                    const superAdminEmail = ST.sets.superAdmin;
                    const adminUsers = ST.sets.admins || [];
                    const displayAdmins = [...new Set([superAdminEmail, ...adminUsers].filter(Boolean))].sort((a,b) => a.localeCompare(b));

                    if (adminListElement) { // defensive check
                        adminListElement.innerHTML = displayAdmins.map(a => {
                            const isS = (a === superAdminEmail);
                            const pillStyle = isS ? 'background:#8e44ad; color:white; border:none;' : 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;';
                            const icon = isS ? 'ğŸ‘‘ ' : 'ğŸ›¡ï¸ ';
                            return `<div style="padding:10px; border-bottom:1px solid #eee;"><span class="setting-item-pill" style="${pillStyle}">${icon}${a}</span></div>`;
                        }).join('');
                    }
                }

                if (btnCleanElement) btnCleanElement.style.display = 'block'; // defensive check
                
                if (globalViewToggleElement) { // defensive check
                    globalViewToggleElement.checked = ST.sets.globalViewEnabled !== false;
                    globalViewToggleElement.disabled = !isSuper; 
                }
                
            } else { 
                if (adminMgmtCardElement) adminMgmtCardElement.classList.add('hidden'); // defensive check
                if (btnCleanElement) btnCleanElement.style.display = 'none'; // defensive check
            }
            
            if (tagMgmtElement) { // defensive check
                tagMgmtElement.innerHTML = sTags.length ? sTags.map(t => { const editAction = isAdmin ? `onclick="app.editTag('${t}')"` : ''; const delAction = isAdmin ? `<span class="setting-del-btn" onclick="app.delTag('${t}')">&times;</span>` : ''; return `<span class="setting-item-pill tag-mgmt-pill"><span class="setting-edit-txt" ${editAction}>#${t}</span> ${delAction}</span>`; }).join('') : '<span style="color:#aaa;">(ç›®å‰ç„¡æ¨™ç±¤)</span>';
            }
            if(document.getElementById('view-add').classList.contains('active')) app.renderOwnerSelect();
        }

        window.app = app; 
        // å°‡ window.onload æ›¿æ›ç‚º DOMContentLoaded ä»¥ç¢ºä¿è…³æœ¬åœ¨ DOM æº–å‚™å¥½å¾Œç›¡å¿«åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>