<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#2c3e50">

    <!-- Android PWA è¨­å®š -->
    <meta name="mobile-web-app-capable" content="yes">
    <script>
        const manifestData = {
            "name": "â˜ï¸DB åº«å­˜ç®¡å®¶",
            "short_name": "åº«å­˜ç®¡å®¶",
            "start_url": window.location.href,
            "display": "standalone",
            "background_color": "#f4f6f8",
            "theme_color": "#2c3e50",
            "icons": [{"src": "https://img.icons8.com/inv/192/box.png", "sizes": "192x192", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/manifest+json'});
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(manifestBlob);
        document.head.appendChild(manifestLink);
    </script>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/inv/192/box.png">

    <title>â˜ï¸DB åº«å­˜ç®¡å®¶ V62.39 (Supabase ç‰ˆ)</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #2c3e50; --secondary: #34495e; 
            --action: #e67e22; --info: #3498db; --danger: #e74c3c; --success: #27ae60; 
            --bg: #f4f6f8; --card-bg: #fff; --text: #222; --border: #ced4da;
            --header-h: 60px; --nav-h: 65px; --base-font: 17px; --img-size: 110px; 
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 20px); font-size: var(--base-font); line-height: 1.5; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; min-height: var(--header-h); display: flex; align-items: center; justify-content: center; position: sticky; top: 0; z-index: 1000; padding: 0 15px; padding-top: env(safe-area-inset-top); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        .header-content { display:flex; flex-direction:column; align-items:center; }
        header h1 { font-size: 1.1rem; margin: 0; font-weight: 700; letter-spacing: 0.5px; }
        
        /* Role Badge */
        .role-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-top: 2px; font-weight: bold; background: rgba(0,0,0,0.2); }
        .role-super { background: #8e44ad; color: white; border: 1px solid #9b59b6; }
        .role-admin { background: #2980b9; color: white; border: 1px solid #3498db; }
        .role-user { background: #7f8c8d; color: white; border: 1px solid #bdc3c7; }

        .head-btn-left { position: absolute; left: 15px; top: calc(env(safe-area-inset-top) + 15px); background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; display: none; padding:0; }
        .head-btn-right { position: absolute; right: 15px; top: calc(env(safe-area-inset-top) + 12px); font-size: 0.9rem; background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 14px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(5px); }

        /* VIEWS */
        .view-section { display: none; padding: 15px; max-width: 900px; margin: 0 auto; animation: fade 0.25s ease-out; }
        .view-section.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARD */
        .card { background: var(--card-bg); border-radius: 16px; padding: 14px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; gap: 14px; border: 1px solid transparent; position: relative; transition: transform 0.1s; }
        .card:active { transform: scale(0.99); }
        .card.consumed { opacity: 0.6; filter: grayscale(1); background: #f0f0f0; border: 1px dashed #bbb; }
        
        .card-img-box { width: var(--img-size); height: var(--img-size); flex-shrink: 0; border-radius: 12px; overflow: hidden; background: #e0e0e0; display: flex; align-items: center; justify-content: center; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: space-between; }
        .card-row { display: flex; justify-content: space-between; align-items: baseline; }
        .card-title { font-weight: 700; color: var(--primary); font-size: 1.15rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-bottom: 4px; }
        .card-sub { font-size: 0.9rem; color: #666; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 4px; }
        .card-date { font-size: 0.8rem; color: #999; margin-top: 2px; }

        .price-main { font-weight: 800; font-size: 1.2rem; color: var(--danger); }
        .price-for { font-size: 0.85rem; color: #7f8c8d; font-weight: normal; margin-left: 6px; }
        .price-unit-net { font-size: 0.9rem; color: #666; font-weight: 500; }
        
        /* Badges */
        .tag-pill { padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #ddd; background: #fff; color: #555; display: inline-block; }
        .tag-exp { color: white; border: none; font-weight: bold; }
        .tag-disc { color: #c0392b; background: #ffebee; border: 1px solid #ffcdd2; font-weight: bold; font-size: 0.75rem; margin-right: 4px; border-radius:4px; padding: 1px 4px;}
        .tag-bogo { color: #fff; background: #ef5350; border: 1px solid #e53935; font-weight: bold; font-size: 0.75rem; margin-right: 4px; border-radius:12px; padding: 1px 8px;}
        .tag-user { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; font-size: 0.75rem; margin-right: 4px; border-radius: 12px; padding: 1px 8px; }
        .tag-owner { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; font-size: 0.75rem; margin-right: 4px; border-radius: 4px; padding: 1px 6px; font-weight: bold; }
        .bg-red { background: var(--danger); } .bg-org { background: var(--action); } .bg-grn { background: var(--success); }
        
        .badge-desc-text { font-size: 0.8rem; color: var(--success); display: block; margin-top: 2px; line-height: 1.2; word-break: break-all; }

        /* ACTIONS */
        .card-actions { margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; display: flex; justify-content: flex-start; gap: 15px; align-items: center; font-size: 0.9rem; color: #555; }
        .chk-lbl { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 4px 6px 4px 0; }
        .chk-lbl input { width: 18px; height: 18px; accent-color: var(--primary); } 

        /* FORMS */
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { font-size: 0.95rem; color: #444; font-weight: 700; margin-bottom: 8px; display: block; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; box-sizing: border-box; background: #fff; appearance: none; -webkit-appearance: none; }
        .form-control:focus { outline: none; border-color: var(--info); box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        .form-row { display: flex; gap: 12px; }
        
        .search-area { background:white; padding:15px; border-radius:16px; margin-bottom:18px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
        
        /* Promo List */
        .promo-container { background: #fcfcfc; border: 1px dashed #ccc; border-top:none; border-radius: 0 0 10px 10px; padding: 10px; }
        .promo-header { display:flex; gap:6px; margin-top:5px; flex-wrap: wrap; }
        .promo-btn-add { flex:1; padding:8px; border:1px dashed #aaa; background:white; color:#555; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:bold; white-space: nowrap; min-width: 80px; }
        .promo-row { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; animation: fade 0.2s; background: white; border: 1px solid #eee; padding: 4px; border-radius: 8px; }
        .promo-inp-s { width: 60px; flex-shrink: 0; padding:8px; text-align:center; font-weight:bold; color:var(--danger); }
        .promo-inp-bogo { width: 45px; flex-shrink: 0; padding:8px; text-align:center; font-weight:bold; color:var(--action); }
        .promo-inp-l { flex: 1; padding:8px; min-width: 0; }
        .promo-del { color: #999; font-size: 1.2rem; cursor: pointer; padding: 0 10px; }
        
        /* Tags Input */
        .tags-input-box { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; border: 1px solid var(--border); border-radius: 10px; background: white; min-height: 50px; }
        .tag-chip { background: #e3f2fd; color: #1565c0; padding: 6px 12px; border-radius: 16px; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 500; }
        .tag-pool { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-suggestion { border: 1px solid #ddd; background: #fff; color: #555; padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; }

        /* Owner Chips */
        .owner-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .owner-chip-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; background: white; color: #555; cursor: pointer; font-size: 0.95rem; transition: 0.2s; -webkit-user-select: none; user-select: none; }
        .owner-chip-btn.active { background: #27ae60; color: white; border-color: #27ae60; font-weight: bold; box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3); }

        /* Auto-Complete */
        #suggestionBox { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 100; max-height: 280px; overflow-y: auto; -webkit-overflow-scrolling: touch; border-radius: 0 0 10px 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.15); display: none; }
        .suggest-item { padding: 14px; border-bottom: 1px solid #f0f0f0; display: flex; gap: 12px; cursor: pointer; align-items: center; }
        .s-img { width: 50px; height: 50px; background: #eee; border-radius: 6px; object-fit: cover; }
        .s-info { font-size: 1rem; color: #333; font-weight: bold; }

        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; color: white; margin-top: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); }
        .btn-action { background: var(--action); }
        .btn-danger { background: var(--danger); }
        .btn-mini { padding: 8px 16px; font-size: 0.9rem; border-radius: 20px; background: white; border: 1px solid #ccc; color: #444; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap:4px; font-weight: 500; }
        .btn-mini:active { background: #eee; }

        /* DETAIL TABLE */
        .detail-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .detail-table th { text-align: left; padding: 12px; background: #f8f9fa; color: #666; border-bottom: 1px solid #eee; font-size: 0.9rem; white-space: nowrap; vertical-align: top; }
        .detail-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem; line-height: 1.4; color: #222; vertical-align: middle; }
        .row-cheap { background: #fffde7; }
        .promo-line { display:flex; justify-content:space-between; margin-bottom:4px; font-size:0.9rem; color:#666; border-bottom:1px dashed #eee; padding-bottom:2px; }
        .promo-val { font-weight:bold; color:var(--danger); }

        /* LIGHTBOX */
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        #lbImg { max-width: 98%; max-height: 85vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .lb-close { color: white; font-size: 1.2rem; margin-bottom: 20px; cursor: pointer; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 20px; }
        .detail-img { height:250px; width:100%; object-fit: contain; background:#f9f9f9; border-radius:12px; }

        /* NAV */
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid #eee; 
            display: flex; 
            height: var(--nav-h); 
            z-index: 990; 
            padding-bottom: env(safe-area-inset-bottom); 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.04); 
        }
        .nav-item { flex: 1; border: none; background: none; color: #bbb; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; padding-top: 6px; }
        .nav-item.active { color: var(--action); font-weight: 700; }
        .nav-icon { font-size: 1.6rem; }

        /* Trash Styles */
        .trash-row { display:flex; gap:12px; background:white; padding:12px; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:10px; align-items:center; border:1px solid #eee; }
        .trash-thumb { width:70px; height:70px; border-radius:8px; object-fit:cover; background:#eee; flex-shrink:0; }
        .trash-info { flex:1; min-width:0; }
        .trash-pid { font-family: monospace; font-size:0.85rem; background:#fff3cd; padding:2px 6px; border-radius:4px; color:#555; word-break:break-all; display:block; margin:4px 0; border:1px solid #ffeeba; }
        .restore-btn { background:#fff; border:1px solid #27ae60; color:#27ae60; padding:6px 12px; cursor:pointer; border-radius:6px; font-size:0.85rem; }
        .perm-del-btn { background:#fff; border:1px solid var(--danger); color:var(--danger); padding:6px 12px; cursor:pointer; border-radius:6px; font-size:0.85rem; }

        /* Setting Pills */
        .setting-item-pill { display: inline-flex; align-items: center; margin: 4px 8px 4px 0; border: 1px solid #ddd; padding: 8px 14px; border-radius: 25px; background:white; font-size: 0.95rem; }
        .setting-del-btn { margin-left:12px; color:#e74c3c; font-weight:900; cursor:pointer; font-size: 1.1rem; }
        .setting-edit-txt { cursor: pointer; border-bottom: 1px dashed #999; padding-bottom:1px; }
        .tag-mgmt-pill { border:1px solid #bbdefb; background:#e3f2fd; color:#1565c0; } 
        
        /* Clean Button */
        .btn-clean { border: 2px dashed #999; padding:15px; background: #fdfdfd; color:#555; font-weight:bold; margin-top:30px; }
        .btn-clean:active { background: #eee; }

        .hidden { display: none !important; }
        .warn-box { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; border: 1px solid #ffeeba; display: flex; align-items: flex-start; gap: 8px; }
        #loadingOverlay { transition: opacity 0.5s; opacity: 1; }
        
        .divider-text { display: flex; align-items: center; text-align: center; color: #999; font-size: 0.85rem; margin: 15px 0; }
        .divider-text::before, .divider-text::after { content: ''; flex: 1; border-bottom: 1px solid #eee; }
        .divider-text::before { margin-right: 10px; } .divider-text::after { margin-left: 10px; }
    </style>
</head>
<body>

    <!-- Lightbox -->
    <div id="lightbox" onclick="this.style.display='none'">
        <div class="lb-close">&times; é—œé–‰é è¦½</div>
        <img id="lbImg">
    </div>

    <!-- Loading -->
    <div id="loadingOverlay" style="position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div style="font-weight:bold; color:var(--primary); font-size:1.5rem;">å•Ÿå‹•åº«å­˜ç®¡å®¶ V62.39...</div><br>
        <div id="loadingStatus" style="color:#666; font-size:0.9rem; margin-bottom:20px;">æ­£åœ¨é€£ç·š Supabase...</div>
        <div id="loadingErr" style="color:red;font-size:1rem;padding:20px;text-align:center;max-width:80%;"></div>
        <button id="forceLoginBtn" style="display:none; padding:10px 20px; border:1px solid #ccc; background:white; border-radius:5px; cursor:pointer;" onclick="document.getElementById('loadingOverlay').style.display='none';document.getElementById('authOverlay').style.display='flex'">âš ï¸ å¼·åˆ¶é€²å…¥ç™»å…¥é </button>
    </div>

    <!-- Auth -->
    <div id="authOverlay" style="position:fixed;inset:0;background:#fff;z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
        <h2 style="color:var(--primary); font-size:2rem; margin-bottom:30px;">â˜ï¸ åº«å­˜ç®¡å®¶</h2>
        <div class="form-group" style="width:100%;max-width:350px;"><input type="email" id="logEmail" class="form-control" placeholder="Email"></div>
        <div class="form-group" style="width:100%;max-width:350px;"><input type="password" id="logPwd" class="form-control" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)"></div>
        <button id="btnLogin" class="btn btn-primary" style="width:100%;max-width:350px;" onclick="app.auth()">ç™»å…¥ / è¨»å†Š</button>
        <p id="authErr" style="color:red;margin-top:20px;font-size:1rem;"></p>
    </div>

    <!-- Header -->
    <header>
        <button id="backBtn" class="head-btn-left" onclick="app.nav('home')">â¬…</button>
        <div class="header-content">
            <h1 id="pageTitle">â˜ï¸ åº«å­˜ç®¡å®¶</h1>
            <div id="userRoleBadge" class="role-badge" style="display:none;"></div>
        </div>
        <button class="head-btn-right" onclick="app.logout()">ç™»å‡º</button>
    </header>

    <!-- 1. HOME -->
    <div id="view-home" class="view-section active">
        <div class="search-area">
            <input type="text" id="searchInp" class="form-control" placeholder="ğŸ”  æœå°‹åç¨±ã€å“ç‰Œ..." oninput="app.renderHome()" style="margin-bottom:12px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <select id="fBrand" class="form-control" onchange="app.renderHome()"></select>
                <select id="fLoc" class="form-control" onchange="app.renderHome()"></select>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="fTag" class="form-control" onchange="app.renderHome()" style="flex:1;">
                    <option value="">ğŸ·ï¸ æ‰€æœ‰æ¨™ç±¤</option>
                </select>
                <select id="fSort" class="form-control" onchange="app.renderHome()" style="flex:1.2;">
                    <option value="date_desc">ğŸ“… æ–° â‡¢ èˆŠ</option>
                    <option value="date_asc">ğŸ“… èˆŠ â‡¢ æ–°</option>
                    <option value="name_asc">ğŸ”¤ åç¨±: A - Z</option>
                    <option value="name_desc">ğŸ”¤ åç¨±: Z - A</option>
                    <option value="exp_asc">â³ åˆ°æœŸè¿‘</option>
                    <option value="exp_desc">â³ åˆ°æœŸé </option>
                    <option value="price_asc">ğŸ’° åƒ¹æ ¼ä½</option>
                    <option value="price_desc">ğŸ’° åƒ¹æ ¼é«˜</option>
                </select>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.9rem; color:#666; align-items:center;">
                <span id="homeStats">çµ±è¨ˆä¸­...</span>
                <span style="color:var(--info); cursor:pointer; font-weight:bold;" onclick="app.resetFilter()">ğŸ”„ é‡ç½®æ¢ä»¶</span>
            </div>
        </div>
        <div id="homeList"></div>
    </div>

    <!-- 2. EXPIRY -->
    <div id="view-expiry" class="view-section">
        <h2 style="font-size:1.5rem;">â³ æ•ˆæœŸç›£æ§</h2>
        <select id="fExpOwner" class="form-control" style="margin-bottom:15px;" onchange="app.renderExps()"></select>
        <div id="expiryContent"></div>
    </div>

    <!-- 3. ADD / EDIT -->
    <div id="view-add" class="view-section">
        <h2 id="addTitle" style="font-size:1.5rem;">æ–°å¢ç”¢å“</h2>
        <input type="hidden" id="editId">
        <input type="hidden" id="pOldPid"><input type="hidden" id="pOldImg">

        <div class="form-group">
            <label class="form-label">åç¨± (å¿…å¡«)</label>
            <input type="text" id="pName" class="form-control" autocomplete="off" oninput="app.suggest(this.value)" placeholder="ç”¢å“åç¨±...">
            <div id="suggestionBox"></div>
        </div>

        <div class="form-group">
            <label class="form-label">æ‰€æœ‰äºº (å¯å¤šé¸ ğŸ‘¤)</label>
            <div id="pOwnerSelect" class="owner-group"></div>
            <small style="color:#999; font-size:0.8rem;">* è«‹é»æ“Šé¸å–ã€‚è‹¥éœ€æ–°å¢æˆå“¡ï¼Œè«‹è‡³ã€Œè¨­å®šã€é é¢ã€‚</small>
        </div>

        <div class="form-group">
            <label class="form-label">æ¨™ç±¤åˆ†é¡</label>
            <div id="formTagContainer" class="tags-input-box" onclick="document.getElementById('pTagInput').focus()"></div>
            <div style="margin-top:6px; display:flex; gap:8px;">
                <input type="text" id="pTagInput" class="form-control" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enter..." onkeydown="app.handleTagInput(event)" style="padding:10px;">
                <button class="btn-mini" style="background:var(--primary); color:white; width:60px;" onclick="app.addTagFromInput()">ï¼‹</button>
            </div>
            <div id="tagPool" class="tag-pool"></div>
        </div>

        <div class="form-row">
            <div style="flex:1"><label class="form-label">å“ç‰Œ</label><select id="pBrand" class="form-control"></select></div>
            <div style="flex:1"><label class="form-label">åœ°é»</label><select id="pLoc" class="form-control"></select></div>
        </div>

        <div style="background:#f1f8ff; padding:15px; border-radius:12px; margin:20px 0; border:1px solid #d0e3f0;">
            <div class="form-row">
                <div style="flex:1"><label class="form-label">åŸå§‹åƒ¹æ ¼ (ç¸½åƒ¹)</label><input type="number" id="pPrice" class="form-control" oninput="app.calc()"></div>
                <div style="flex:1">
                    <label class="form-label" style="font-size:0.9rem;"><input type="checkbox" id="pUseFor" onchange="app.toggleFor()"> ä½¿ç”¨å¤–å¹£</label>
                    <select id="pCurr" class="form-control" disabled onchange="app.updRateLabel()"></select>
                </div>
            </div>
            <div id="forArea" class="hidden" style="margin-top:12px;">
                <div class="form-row">
                    <div style="flex:1">
                        <label class="form-label" id="rateLabel" style="color:#666;">1 å¤–å¹£ = ? æœ¬å¹£</label>
                        <input type="number" id="pRate" class="form-control" placeholder="åŒ¯ç‡" oninput="app.updRateLabel();app.calc()">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:18px;">
                <div style="display:flex; justify-content:space-between;">
                    <label class="form-label">å„ªæƒ æŠ˜æ‰£</label>
                </div>
                <div style="border:1px solid var(--border); border-bottom: none; border-radius:10px 10px 0 0; background:white;">
                    <div id="promoList"></div>
                </div>
                <div class="promo-container">
                    <div class="promo-header">
                        <button class="promo-btn-add" onclick="app.addPromoRow('pct')">ï¼‹ æŠ˜æ‰£ %</button>
                        <button class="promo-btn-add" onclick="app.addPromoRow('cash')">ï¼‹ ç¾é‡‘æ¸›</button>
                        <button class="promo-btn-add" onclick="app.addPromoRow('bogo')">ï¼‹ è²·Xé€Y</button>
                    </div>
                </div>
            </div>

            <div style="text-align:right; margin-top:15px; font-weight:800; color:var(--primary); font-size:1rem;" id="calcForRes"></div>
            <div style="text-align:right; margin-top:5px; font-size:1rem;color:#333;" id="calcRes">æœ¬å¹£å¯¦ä»˜: $0.00</div>
        </div>

        <div class="form-row">
            <div style="flex:1"><label class="form-label">æ•¸é‡ (ç¸½ä»¶æ•¸)</label><input type="number" id="pQty" class="form-control" value="1" oninput="app.calc()"></div>
            <div style="flex:1"><label class="form-label">å–®ä½</label><select id="pUnit" class="form-control"></select></div>
            <div style="flex:1"><label class="form-label">è¦æ ¼</label><input type="text" id="pSpec" class="form-control"></div>
        </div>

        <div class="form-group"><label class="form-label">æœ‰æ•ˆæ—¥æœŸ</label><input type="date" id="pExp" class="form-control"></div>
        <div class="form-group"><label class="form-label">å‚™è¨»</label><textarea id="pNote" class="form-control" rows="2"></textarea></div>

        <div class="form-group">
            <label class="form-label">åœ–ç‰‡ä¾†æº (äºŒé¸ä¸€)</label>
            <div style="background:white; padding:10px; border-radius:12px; border:1px solid var(--border);">
                <label class="form-label" style="font-size:0.85rem; color:#666;">æ–¹å¼ A: ä¸Šå‚³åœ–ç‰‡ (è‡ªå‹•å£“ç¸®çœç©ºé–“)</label>
                <input type="file" id="pImgFile" class="form-control" accept="image/*" onchange="app.prevImg(this)">
                
                <div class="divider-text">æˆ–</div>
                
                <label class="form-label" style="font-size:0.85rem; color:#666;">æ–¹å¼ B: è²¼ä¸Šå¤–éƒ¨åœ–ç‰‡ç¶²å€ (ä¸ä½”ç©ºé–“)</label>
                <input type="text" id="pImgExternal" class="form-control" placeholder="https://..." oninput="app.prevExternal(this.value)">
            </div>

            <input type="hidden" id="pImgUrl"><input type="hidden" id="pImgPid">
            <div id="imgPreviewBox" style="margin-top:15px; display:none; position:relative; width:fit-content;">
                <img id="imgPreview" style="height:140px; border-radius:10px; border:1px solid #ddd;">
                <button type="button" onclick="app.removeImg()" style="position:absolute; top:-10px; right:-10px; background:red; color:white; border-radius:50%; width:30px; height:30px; border:none; cursor:pointer;">&times;</button>
            </div>
        </div>
        <button class="btn btn-action" id="btnSave" onclick="app.saveProd()">â˜ï¸ ä¿å­˜ç”¢å“</button>
    </div>

    <!-- 4. DETAIL -->
    <div id="view-detail" class="view-section">
        <div id="detailContent"></div>
    </div>

    <!-- 5. COMPARE -->
    <div id="view-compare" class="view-section">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem;">âš–ï¸ åŒæ¬¾æ¯”åƒ¹</h2>
            <button class="btn-mini" onclick="app.nav('home')">è¿”å›</button>
        </div>
        <div id="compareInfo" style="color:var(--info); font-weight:bold; margin-bottom:15px; font-size:1rem;"></div>
        <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
            <table class="detail-table" style="font-size:0.9rem;">
                <thead>
                    <tr style="background:var(--secondary); color:white;">
                        <th>ç”¢å“/åœ°é»</th>
                        <th>æ·¨å–®åƒ¹</th>
                        <th>æ•¸é‡</th>
                        <th>ç¸½åƒ¹/è©³æƒ…</th>
                        <th style="min-width: 90px;">å·²ç”¨/å·²é£Ÿ</th>
                    </tr>
                </thead>
                <tbody id="compareBody"></tbody>
            </table>
        </div>
    </div>

    <!-- 6. STARRED -->
    <div id="view-starred" class="view-section">
        <h2 style="font-size:1.5rem;">â­ï¸ é—œæ³¨æ¸…å–®</h2>
        <select id="fStarOwner" class="form-control" style="margin-bottom:15px;" onchange="app.renderStar()"></select>
        <div id="starredList"></div>
    </div>

    <!-- 8. TRASH BIN -->
    <div id="view-trash" class="view-section">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem;">ğŸ—‘ï¸ å›æ”¶æ¡¶</h2>
            <button class="btn-mini" onclick="app.nav('settings')">è¿”å›</button>
        </div>
        <div class="warn-box">
            <span>â„¹ï¸</span>
            <div><b>æ¬Šé™èªªæ˜ï¼š</b><br>1. <b>ä¸€èˆ¬ç”¨æˆ¶</b>ï¼šåƒ…èƒ½åŸ·è¡Œé‚„åŸã€‚<br>2. <b>ç®¡ç†å“¡</b>ï¼šå¯åŸ·è¡Œã€Œæ°¸ä¹…åˆªé™¤ã€ã€‚<br>(æ°¸ä¹…åˆªé™¤çš„åœ–ç‰‡åœ¨ Supabase Storage ä¸­ï¼Œéœ€è¦å°æ‡‰æ¬Šé™æ‰èƒ½åˆªé™¤)</div>
        </div>
        <!-- Cloudinary é€£çµå·²ç§»é™¤ -->
        <div id="trashList"></div>
    </div>

    <!-- 7. SETTINGS -->
    <div id="view-settings" class="view-section">
        <h2 style="font-size:1.5rem;">âš™ï¸ è¨­å®šç®¡ç†</h2>
        
        <button class="btn btn-action" id="btnTrash" onclick="app.nav('trash')" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ—‘ï¸ å›æ”¶æ¡¶ / åœ–ç‰‡æ¸…ç†</span>
            <span id="trashCount" style="background:white; color:var(--action); padding:2px 10px; border-radius:12px; font-size:0.9rem; font-weight:bold;">0</span>
        </button>

        <!-- ğŸ‰ å…¨æ–°ç”¨æˆ¶èˆ‡æ¬Šé™ç®¡ç†å€å¡Š (åƒ…ç®¡ç†å“¡å¯è¦‹) -->
        <div id="adminMgmtCard" class="card hidden" style="border-left:4px solid #8e44ad; display:flex; flex-direction:column;">
            <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:#8e44ad;">ğŸ›¡ï¸ ç”¨æˆ¶ & æ¬Šé™ç®¡ç†</h3>
            
            <div class="form-row" id="adminInputArea">
                <input id="newAdminEmail" class="form-control" placeholder="æ‰‹å‹•è¼¸å…¥ç”¨æˆ¶ Email">
                <button class="btn-mini" onclick="app.addAdmin()">è¨­ç‚ºç®¡ç†è€…</button>
            </div>
            
            <!-- é€™è£¡å°‡å‹•æ…‹é¡¯ç¤ºæ‰€æœ‰å·²è¨»å†Šçš„ç”¨æˆ¶åå–® -->
            <div id="adminList" style="margin-top:15px; background:#fff; border-radius:8px; border:1px solid #eee; overflow:hidden;"></div>

            <small style="color:#999; display:block; margin-top:10px;">ğŸ’¡ è¶…ç´šç®¡ç†å“¡(ğŸ‘‘) ç„¡æ³•è¢«ç§»é™¤ã€‚</small>
            
            <!-- å…¨åŸŸæª¢è¦–æ¬Šé™é–‹é—œ -->
            <div style="margin-top:15px; padding-top:12px; border-top:1px dashed #ccc;">
                <label class="chk-lbl" style="font-weight:bold; color:var(--primary); font-size: 0.95rem;">
                    <input type="checkbox" id="globalViewToggle" onchange="app.toggleGlobalView(this.checked)">
                    ğŸŒ å…è¨±ä¸€èˆ¬ç”¨æˆ¶æŸ¥çœ‹å…¨åŸŸåº«å­˜
                </label>
                <small style="color:#999; display:block; margin-top:4px;">(è‹¥é—œé–‰ï¼Œä¸€èˆ¬ç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±æ–°å¢çš„åº«å­˜ã€‚åƒ…è¶…ç´šç®¡ç†å“¡å¯è®Šæ›´)</small>
            </div>
        </div>

        <div class="card" style="display:block;">
            <label class="form-label">ğŸ’° ç³»çµ±æœ¬å¹£ (å…¨ç«™é‡‘é¡ä»¥æ­¤é¡¯ç¤º)</label>
            <div class="form-row">
                <select id="baseCurr" class="form-control"></select>
                <button class="btn-mini" id="btnBaseSave" style="flex-grow:0; padding:0 20px; font-size:0.95rem;" onclick="app.saveSet()">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>

        <div class="card" style="display:block; border-left:4px solid var(--info);">
            <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:var(--primary);">ğŸ·ï¸ æ¨™ç±¤ç®¡ç† (å…¨åŸŸå…±ç”¨)</h3>
            <div id="tagMgmt" style="line-height:2;"></div>
            <small style="color:#999; display:block; margin-top:8px;">ğŸ’¡ ä»»ä½•äººéƒ½å¯æ–°å¢æ¨™ç±¤ï¼›åƒ…ç®¡ç†å“¡å¯åˆªé™¤/æ”¹åã€‚</small>
        </div>

        <div id="setOpts"></div>
        
        <button class="btn btn-clean" onclick="app.cleanUnusedOpts()">ğŸ§¹ ä¸€éµç§»é™¤æ‰€æœ‰ã€Œæœªä½¿ç”¨çš„é¸é …ã€</button>
        <div style="text-align:center; color:#999; font-size:0.8rem; margin-top:10px;">(è‡ªå‹•ç§»é™¤æœªä½¿ç”¨çš„é …ç›®ï¼Œä¸€èˆ¬ç”¨æˆ¶ç„¡æ¬Šé™)</div>
    </div>

    <!-- NAV -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="app.nav('home')" id="nav-home"><span class="nav-icon">ğŸ </span>é¦–é </button>
        <button class="nav-item" onclick="app.nav('expiry')" id="nav-expiry"><span class="nav-icon">ğŸ“…</span>æ•ˆæœŸ</button>
        <button class="nav-item" onclick="app.navToAdd()" id="nav-add"><span class="nav-icon">â•</span>æ–°å¢</button>
        <button class="nav-item" onclick="app.nav('starred')" id="nav-starred"><span class="nav-icon">â­ï¸</span>é—œæ³¨</button>
        <button class="nav-item" onclick="app.nav('settings')" id="nav-settings"><span class="nav-icon">âš™ï¸</span>è¨­å®š</button>
    </nav>

    <script>
        // ğŸ”´ å‹™å¿…å¡«å¯«æ‚¨çš„ Supabase CONFIGï¼
        // æ‚¨å¯ä»¥åœ¨ Supabase å°ˆæ¡ˆçš„ Settings -> API é é¢æ‰¾åˆ°é€™äº›è³‡è¨Šã€‚
        const CONFIG = {
            supabase: {
                url: "SUPABASE_URL", // æ›¿æ›ç‚ºæ‚¨çš„ Supabase URL (ä¾‹å¦‚: https://abcdefghijkl.supabase.co)
                anonKey: "SUPABASE_KEY", // æ›¿æ›ç‚ºæ‚¨çš„ Supabase "anon" public key
            },
            // Cloudflare R2 ç”¨æ–¼å¾Œç«¯å‚™ä»½ï¼Œå‰ç«¯ä¸ç›´æ¥ä½¿ç”¨ï¼Œå› æ­¤é€™è£¡ä¸é…ç½®ã€‚
        };

        const SYMS = { 'HKD':'$', 'TWD':'NT$', 'USD':'$', 'JPY':'Â¥', 'EUR':'â‚¬', 'KRW':'â‚©', 'CNY':'Â¥', 'GBP':'Â£' };
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 1000; 
                        const scale = maxW / img.width;
                        const w = (img.width > maxW) ? maxW : img.width;
                        const h = (img.width > maxW) ? img.height * scale : img.height;
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        canvas.toBlob((blob) => { if(blob) resolve(blob); else reject(new Error("Img Error")); }, 'image/webp', 0.6); 
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function getThumb(url, w=150) {
            // Supabase Storage åœ–ç‰‡ç›®å‰ç›´æ¥ä½¿ç”¨å…¬å…± URLï¼Œä¸å¸¶åƒæ•¸é€²è¡Œè®Šå½¢
            // å¦‚æœéœ€è¦ç¸®åœ–ï¼Œå¯è€ƒæ…®ä½¿ç”¨ Supabase Edge Functions æˆ–ç¬¬ä¸‰æ–¹ CDN (å¦‚ Cloudflare Images) é€²è¡Œè™•ç†ã€‚
            if(!url || !url.includes(CONFIG.supabase.url)) return url; // å¦‚æœä¸æ˜¯ Supabase URLï¼Œç›´æ¥è¿”å›
            return url; 
        }

        let supabase, uid, prodUnsub;
        
        const DEFAULT_SETS = { brands:['å…¨è”','Costco'], locs:['å®¶','å…¬å¸'], units:['å€‹','åŒ…','ç›’','g','ml'], owners:[], tags:[], base:'HKD', admins:[], superAdmin: "", allUsers: [], globalViewEnabled: true };
        let ST = { prods:[], sets: { ...DEFAULT_SETS } };
        const CURRS = ['HKD','TWD','USD','JPY','KRW','EUR','CNY','GBP'];
        let currentFormTags = []; let currentFormOwners = [];

        // å®šç¾© Supabase è³‡æ–™è¡¨åç¨±
        const TABLE_NAMES = {
            settings: 'settings_global',
            products: 'inventory_global'
        };

        async function init() {
            if (CONFIG.supabase.url.includes("YOUR_SUPABASE_URL")) {
                document.getElementById('loadingErr').innerHTML = "âš ï¸ Config æœªè¨­å®šï¼è«‹å¡«å…¥ Supabase URL å’Œ Anon Keyã€‚";
                return;
            }
            setTimeout(() => {
                const load = document.getElementById('loadingOverlay');
                if (load.style.display !== 'none' && !uid) {
                    document.getElementById('loadingStatus').innerText = "é€£ç·šå›æ‡‰æ™‚é–“éé•·...";
                    document.getElementById('forceLoginBtn').style.display = 'block';
                }
            }, 8000);

            try {
                supabase = createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);

                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (session) {
                        uid = session.user.id;
                        document.getElementById('authOverlay').style.display = 'none';
                        document.getElementById('loadingStatus').innerText = "æ­£åœ¨åŒæ­¥æ•¸æ“š...";
                        await syncData(); // ç¢ºä¿è¨­å®šå…ˆè¼‰å…¥
                        syncProducts();
                    } else {
                        uid = null;
                        document.getElementById('authOverlay').style.display = 'flex';
                        document.getElementById('loadingOverlay').style.display = 'none';
                        // ç™»å‡ºæ™‚å–æ¶ˆç”¢å“è¨‚é–±ä¸¦æ¸…ç©ºç”¢å“åˆ—è¡¨
                        if (prodUnsub) prodUnsub.unsubscribe();
                        ST.prods = [];
                        app.renderHome(); // æ¸²æŸ“ç©ºçš„é¦–é 
                    }
                });

                // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æœƒè©±
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    uid = session.user.id;
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('loadingStatus').innerText = "æ­£åœ¨åŒæ­¥æ•¸æ“š...";
                    await syncData(); // ç¢ºä¿è¨­å®šå…ˆè¼‰å…¥
                    syncProducts();
                }

            } catch (e) {
                document.getElementById('loadingErr').innerText = "åˆå§‹åŒ–å¤±æ•—: " + e.message;
            }
        }

        async function syncData() {
            if (!uid) return;

            const settingsId = 'main'; // å›ºå®š ID for settings row

            try {
                const { data, error } = await supabase
                    .from(TABLE_NAMES.settings)
                    .select('*')
                    .eq('id', settingsId)
                    .single();

                if (error && error.code === 'PGRST116') { // å¦‚æœæ²’æœ‰æ‰¾åˆ°è³‡æ–™ï¼Œå‰‡åˆå§‹åŒ–
                    const { data: userData, error: userError } = await supabase.auth.getUser();
                    const currentUserEmail = userData.user ? userData.user.email : '';
                    if (userError || !currentUserEmail) throw new Error("ç„¡æ³•å–å¾—ç•¶å‰ç”¨æˆ¶ Email.");

                    const initData = {
                        id: settingsId,
                        ...DEFAULT_SETS,
                        superAdmin: currentUserEmail,
                        admins: [currentUserEmail],
                        allUsers: [currentUserEmail]
                    };
                    const { error: insertError } = await supabase.from(TABLE_NAMES.settings).insert([initData]);
                    if (insertError) {
                        console.error("åˆå§‹åŒ–è¨­å®šæª”å¤±æ•—:", insertError);
                        document.getElementById('loadingErr').innerText = "åˆå§‹åŒ–å¤±æ•—: " + insertError.message;
                    }
                    ST.sets = initData;
                } else if (error) {
                    throw error;
                } else {
                    ST.sets = { ...DEFAULT_SETS, ...data };
                }

                // æ›´æ–° allUsers åˆ—è¡¨ (ç¢ºä¿ç•¶å‰ç”¨æˆ¶åœ¨åˆ—è¡¨ä¸­)
                const { data: userData, error: userError } = await supabase.auth.getUser();
                const currentUserEmail = userData.user ? userData.user.email : '';
                if (userError || !currentUserEmail) throw new Error("ç„¡æ³•å–å¾—ç•¶å‰ç”¨æˆ¶ Email.");

                let currentAllUsers = ST.sets.allUsers || [];
                if (!currentAllUsers.includes(currentUserEmail)) {
                    currentAllUsers.push(currentUserEmail);
                    await supabase.from(TABLE_NAMES.settings).update({ allUsers: currentAllUsers }).eq('id', settingsId);
                }

            } catch (err) {
                console.error("è¨­å®šè®€å–å¤±æ•—:", err);
                document.getElementById('loadingErr').innerText = "è¨­å®šè®€å–å¤±æ•—: " + err.message;
                ST.sets = DEFAULT_SETS; // å›é€€åˆ°é è¨­å€¼
            }

            // è¨­å®š real-time è¨‚é–±
            supabase
                .channel('settings_global_channel')
                .on(
                    'postgres_changes', { event: '*', schema: 'public', table: TABLE_NAMES.settings, filter: `id=eq.${settingsId}` },
                    (payload) => {
                        if (payload.eventType === 'UPDATE' || payload.eventType === 'INSERT') {
                            ST.sets = { ...DEFAULT_SETS, ...payload.new };
                            renderSets();
                            app.updHeaderRole();
                            // å¦‚æœ globalViewEnabled æ”¹è®Šï¼Œå¯èƒ½éœ€è¦é‡æ–°åŒæ­¥ç”¢å“åˆ—è¡¨
                            // syncProducts(); // é€™æœƒé‡æ–°è¨‚é–±ï¼Œä½†åœ¨ onSnapshot å…§éƒ¨å·²ç¶“è™•ç†
                        }
                    }
                )
                .subscribe();

            renderSets();
            app.updHeaderRole();
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function syncProducts() {
            if (prodUnsub) {
                prodUnsub.unsubscribe();
                prodUnsub = null;
            }

            const role = app.getRole();
            let query = supabase
                .from(TABLE_NAMES.products)
                .select(`*, market_price`); // é¸æ“‡ market_price æ¬„ä½

            if (!role.isAdmin && ST.sets.globalViewEnabled === false) {
                // RLS æ‡‰è©²æœƒè‡ªå‹•éæ¿¾ï¼Œä½†å‰ç«¯ä¹Ÿåšä¸€å±¤ç¯©é¸ä»¥æœ€ä½³åŒ–é¡¯ç¤º
                query = query.eq('creator', app.currentUserEmail());
            }
            
            // è¨­ç½® real-time è¨‚é–±
            prodUnsub = query.on(
                'postgres_changes', { event: '*', schema: 'public', table: TABLE_NAMES.products },
                (payload) => {
                    if (payload.eventType === 'DELETE') {
                        ST.prods = ST.prods.filter(p => p.id !== payload.old.id);
                    } else if (payload.eventType === 'INSERT') {
                        ST.prods.push(payload.new);
                    } else if (payload.eventType === 'UPDATE') {
                        const index = ST.prods.findIndex(p => p.id === payload.new.id);
                        if (index > -1) {
                            ST.prods[index] = payload.new;
                        } else {
                            ST.prods.push(payload.new);
                        }
                    }
                    app.renderHome();
                    app.renderExps();
                    app.renderStar();
                    app.updTrashCount();
                    if (document.getElementById('view-trash').classList.contains('active')) app.renderTrash();
                }
            ).subscribe();

            // åˆå§‹ç²å–ç”¢å“è³‡æ–™ (åœ¨ real-time æ›´æ–°æµé–‹å§‹ä¹‹å‰)
            supabase.from(TABLE_NAMES.products)
                .select(`*, market_price`)
                .then(({ data, error }) => {
                    if (error) {
                        document.getElementById('loadingErr').innerText = "ç”¢å“è®€å–å¤±æ•—: " + error.message;
                        console.error("ç”¢å“è®€å–å¤±æ•—:", error);
                    } else {
                        let initialProds = data;
                        if (!role.isAdmin && ST.sets.globalViewEnabled === false) {
                            initialProds = initialProds.filter(p => p.creator === app.currentUserEmail());
                        }
                        ST.prods = initialProds;
                        app.renderHome();
                        app.renderExps();
                        app.renderStar();
                        app.updTrashCount();
                        if (document.getElementById('view-trash').classList.contains('active')) app.renderTrash();
                        document.getElementById('loadingOverlay').style.display = 'none';
                    }
                });
        }

        const app = {
            getSym: () => SYMS[ST.sets.base] || '$', 
            getForSym: (c) => SYMS[c] || c,
            fmtDate: (ts) => new Date(ts).toISOString().split('T')[0],
            fmtTime: (ts) => new Date(ts).toLocaleString(),
            
            // åŠ å…¥å‹•æ…‹é‡æ–°æŒ‰å­—æ¯æ’åºçš„å°å·¥å…· (è™•ç† Issue 3)
            sortArr: (arr) => (arr||[]).slice().sort((a,b)=>a.localeCompare(b, 'zh-Hant')),
            
            currentUserEmail: () => supabase.auth.currentUser ? supabase.auth.currentUser.email : '',
            getRole: () => {
                const em = app.currentUserEmail();
                const superAdmin = ST.sets.superAdmin || ""; 
                const adminList = ST.sets.admins || [];
                const isSuper = (em === superAdmin); const isAdmin = isSuper || adminList.includes(em);
                let label = 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ¶'; let style = 'role-user';
                if(isSuper) { label = 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡'; style = 'role-super'; } else if(isAdmin) { label = 'ğŸ›¡ï¸ ç®¡ç†å“¡'; style = 'role-admin'; }
                return { isSuper, isAdmin, label, style, email: em };
            },

            toggleGlobalView: async (isChecked) => {
                const role = app.getRole();
                if (!role.isSuper) { alert("âŒ åƒ…è¶…ç´šç®¡ç†å“¡(ğŸ‘‘)å¯ä¿®æ”¹æ­¤è¨­å®šï¼"); document.getElementById('globalViewToggle').checked = !isChecked; return; }
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ globalViewEnabled: isChecked }).eq('id', 'main');
                if (error) { alert("æ›´æ–°å¤±æ•—: " + error.message); document.getElementById('globalViewToggle').checked = !isChecked; }
            },
            
            getBogoInfo: (p) => {
                if(!p.promos || p.promos.length === 0) return null;
                const bogo = p.promos.find(x => x.type === 'bogo');
                if(bogo && (bogo.buy + bogo.get) > 1) { return `(æ¯çµ„ ${app.getSym()}${ (p.total / (bogo.buy+bogo.get)).toFixed(2) })`; }
                return null;
            },

            updHeaderRole: () => { const role = app.getRole(); const badge = document.getElementById('userRoleBadge'); badge.className = `role-badge ${role.style}`; badge.innerText = role.label; badge.style.display = 'block'; },
            
            card: (p) => {
                const baseSym = app.getSym(); 
                let expPill = "", expText = p.exp || "ç„¡æ•ˆæœŸ";
                if(p.exp) {
                    const days = (new Date(p.exp) - new Date()) / 86400000;
                    if(days < 0) expPill = `<span class="tag-pill tag-exp bg-red">éæœŸ</span>`; else if(days <= 30) expPill = `<span class="tag-pill tag-exp bg-org">${Math.ceil(days)}å¤©</span>`; else expPill = `<span class="tag-pill tag-exp bg-grn">å®‰å…¨</span>`;
                }
                let forPriceHtml = ""; if(p.isFor && p.curr && p.curr !== ST.sets.base) forPriceHtml = `<span class="price-for">(${app.getForSym(p.curr)}${p.raw})</span>`;
                let badges = ""; let promoDesc = [];
                if(p.promos && p.promos.length > 0) {
                     p.promos.forEach(x => {
                         if(x.type==='pct') badges += `<span class="tag-disc">â†“${x.val}%</span>`; else if(x.type==='cash') badges += `<span class="tag-disc">-$${x.val}</span>`; else if(x.type==='bogo') badges += `<span class="tag-bogo">è²·${x.buy}é€${x.get}</span>`;
                         if(x.note) promoDesc.push(x.note);
                     });
                } else { if(p.DiscPct) badges += `<span class="tag-disc">â†“${p.DiscPct}%</span>`; if(p.DiscCash) badges += `<span class="tag-disc">-$${p.DiscCash}</span>`; if(p.DiscNote) promoDesc.push(p.DiscNote); }
                let promoTextHtml = promoDesc.length > 0 ? `<div class="badge-desc-text">${promoDesc.join(' / ')}</div>` : "";
                if(p.owners) p.owners.forEach(o => badges += `<span class="tag-owner">ğŸ‘¤ ${o}</span>`);
                if(p.tags) p.tags.forEach(t => badges += `<span class="tag-user">#${t}</span>`);
                const thumbUrl = getThumb(p.img, 150); const imgDisplay = p.img ? `<img class="card-img" src="${thumbUrl}" onclick="app.lb('${p.img}')" loading="lazy">` : `<div class="card-img" style="background:#eee; display:flex; align-items:center; justify-content:center; color:#999; font-size:2rem;">ğŸ“·</div>`;
                let creatorInfo = ""; if(app.getRole().isAdmin && p.creator && p.creator !== app.currentUserEmail()) { creatorInfo = `<div style="font-size:0.75rem; color:#888; margin-top:2px;">ç”± ${p.creator.split('@')[0]} æ–°å¢</div>`; }
                const bogoInfo = app.getBogoInfo(p); const bogoHtml = bogoInfo ? `<span style="font-size:0.85rem; color:var(--action); font-weight:bold; margin-left:4px;">${bogoInfo}</span>` : '';

                // æ–°å¢å¸‚å ´åƒ¹æ ¼é¡¯ç¤º
                let marketPriceHtml = '';
                if (p.market_price && p.market_price > 0) {
                    const priceDiff = p.market_price - p.total;
                    let diffText = '';
                    let diffStyle = '';
                    if (priceDiff > 0) {
                        diffText = `è²´ ${baseSym}${priceDiff.toFixed(2)}`;
                        diffStyle = 'color: var(--danger);'; // æ¯”å¸‚åƒ¹è²´
                    } else if (priceDiff < 0) {
                        diffText = `çœ ${baseSym}${(-priceDiff).toFixed(2)}`;
                        diffStyle = 'color: var(--success);'; // æ¯”å¸‚åƒ¹ä¾¿å®œ
                    } else {
                        diffText = 'åŒå¸‚åƒ¹';
                        diffStyle = 'color: #777;';
                    }
                    marketPriceHtml = `<div style="font-size:0.9rem; color:#555; margin-top:5px;">å¸‚åƒ¹: ${baseSym}${p.market_price.toFixed(2)} <span style="${diffStyle} font-weight:bold;">(${diffText})</span></div>`;
                }


                return `<div class="card ${p.consumed?'consumed':''}" id="c-${p.id}"><div class="card-img-box">${imgDisplay}</div><div class="card-body"><div class="card-title" onclick="app.detail('${p.id}')">${p.name}</div><div class="card-sub"><span>${p.brand}</span> â€¢ <span>${p.loc}</span></div><div class="card-row" style="margin-top:2px;"><div class="card-sub">æ•ˆæœŸ: ${expText} ${expPill}</div></div>${creatorInfo}<div class="card-date">ğŸ“… åŠ å…¥: ${app.fmtDate(p.at)}</div><div class="card-row" style="margin-top:4px;"><div class="price-unit-net">æ·¨: ${baseSym}${p.net}/${p.unit}${bogoHtml}</div><div class="price-main">${baseSym}${p.total}${forPriceHtml}</div></div>${promoTextHtml}${badges ? `<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:2px;">${badges}</div>` : ''}${marketPriceHtml}<div class="card-actions"><label class="chk-lbl"><input type="checkbox" ${p.consumed?'checked':''} onchange="app.upd('${p.id}',{consumed:this.checked})"> å·²ç”¨/å·²é£Ÿ</label><label class="chk-lbl"><input type="checkbox" ${p.star?'checked':''} onchange="app.upd('${p.id}',{star:this.checked})"> â­ï¸</label><button class="btn-mini" style="margin-left:auto;" onclick="app.comp('${p.name.replace(/'/g, "\\'") }','${p.brand.replace(/'/g, "\\'") }')">âš–ï¸ æ¯”åƒ¹</button></div></div></div>`;
            },
            
            softDel: async (id) => { 
                if(confirm("ç¢ºå®šå°‡æ­¤ç”¢å“ç§»å…¥å›æ”¶æ¡¶ï¼Ÿ")) { 
                    const { error } = await supabase.from(TABLE_NAMES.products).update({ deleted: true, deletedAt: Date.now() }).eq('id', id);
                    if (error) { alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message); } else { app.nav('home'); setTimeout(() => alert("ğŸ—‘ï¸ ç”¢å“å·²ç§»è‡³å›æ”¶æ¡¶ï¼"), 300); }
                } 
            },
            restore: async (id) => { 
                const { error } = await supabase.from(TABLE_NAMES.products).update({ deleted: false }).eq('id', id);
                if (error) alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message); else alert("å·²é‚„åŸï¼");
            },
            hardDel: async (id) => { 
                if(!app.getRole().isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šåƒ… Admin å¯æ°¸ä¹…åˆªé™¤è³‡æ–™ã€‚"); 
                if(confirm("âš ï¸ æ°¸ä¹…åˆªé™¤è­¦å‘Š\n\nç¢ºèªï¼Ÿ")) {
                    const product = ST.prods.find(p => p.id === id);
                    if (product && product.pid && product.img.includes(CONFIG.supabase.url)) { // å¦‚æœåœ–ç‰‡æ˜¯ Supabase Storage çš„
                        const { error: storageError } = await supabase.storage.from('products').remove([product.pid]);
                        if (storageError) console.error("åœ–ç‰‡å¾Supabase Storageåˆªé™¤å¤±æ•—:", storageError.message);
                    }

                    const { error } = await supabase.from(TABLE_NAMES.products).delete().eq('id', id);
                    if (error) alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message);
                }
            },
            updTrashCount: () => { const count = ST.prods.filter(p => p.deleted === true).length; document.getElementById('trashCount').innerText = count; const btn = document.getElementById('btnTrash'); if(count > 0) btn.classList.add('btn-danger'); else btn.classList.remove('btn-danger'); },
            renderTrash: () => { const trashItems = ST.prods.filter(p => p.deleted === true); const role = app.getRole(); if(trashItems.length === 0) { document.getElementById('trashList').innerHTML = '<div style="text-align:center;padding:30px;color:#999;">å›æ”¶æ¡¶æ˜¯ç©ºçš„ ğŸ‰</div>'; return; } document.getElementById('trashList').innerHTML = trashItems.map(p => { const thumbUrl = getThumb(p.img, 150); const thumb = p.img ? `<img class="trash-thumb" src="${thumbUrl}" onclick="app.lb('${p.img}')">` : '<div class="trash-thumb" style="display:flex;align-items:center;justify-content:center;">ç„¡åœ–</div>'; const delBtn = role.isAdmin ? `<button class="perm-del-btn" onclick="app.hardDel('${p.id}')">æ°¸ä¹…åˆªé™¤</button>` : ''; return `<div class="trash-row">${thumb}<div class="trash-info"><div><b>${p.name}</b></div><div style="font-size:0.8rem;color:#888;">${p.pid?`è·¯å¾‘:${p.pid}`:'ç„¡è·¯å¾‘'}</div></div><div style="display:flex;flex-direction:column;gap:6px;"><button class="restore-btn" onclick="app.restore('${p.id}')">é‚„åŸ</button>${delBtn}</div></div>`; }).join(''); },
            
            renderHome: () => { const s = document.getElementById('searchInp').value.toLowerCase(); const b = document.getElementById('fBrand').value; const l = document.getElementById('fLoc').value; const t = document.getElementById('fTag').value; const sort = document.getElementById('fSort').value; const allTags = app.sortArr(ST.sets.tags); const tagSelect = document.getElementById('fTag'); if(tagSelect.options.length <= 1 || tagSelect.innerHTML.indexOf(t) === -1 && t !== "") { tagSelect.innerHTML = `<option value="">ğŸ·ï¸ æ‰€æœ‰æ¨™ç±¤</option>` + allTags.map(tag => `<option value="${tag}">${tag}</option>`).join(''); tagSelect.value = t; } let d = ST.prods.filter(p => !p.deleted && (p.name+p.brand+p.loc).toLowerCase().includes(s) && (!b || p.brand===b) && (!l || p.loc===l) && (!t || (p.tags && p.tags.includes(t)) )); d.sort((x,y) => { const tsX = x.at||0, tsY = y.at||0; if(sort==='date_desc') return tsY - tsX; else if(sort==='date_asc') return tsX - tsY; else if(sort==='price_asc') return x.net - y.net; else if(sort==='price_desc') return y.net - x.net; else if(sort==='exp_asc') return (x.exp||'z').localeCompare(y.exp||'z'); else if(sort==='exp_desc') return (y.exp||'').localeCompare(x.exp||''); else if(sort==='name_asc') return x.name.localeCompare(y.name, 'zh-Hant'); else if(sort==='name_desc') return y.name.localeCompare(x.name, 'zh-Hant'); else return tsY - tsX; }); const pendingCount = d.filter(x => !x.consumed && x.exp).length; document.getElementById('homeStats').innerText = `ç¸½æ•¸: ${d.length} | å¾…ç”¨/å¾…é£Ÿ: ${pendingCount}`; document.getElementById('homeList').innerHTML = d.map(app.card).join(''); },
            resetFilter: () => { document.getElementById('searchInp').value=''; document.getElementById('fBrand').value=''; document.getElementById('fLoc').value=''; document.getElementById('fTag').value=''; document.getElementById('fSort').value='date_desc'; app.renderHome(); },
            renderExps: () => { const ownerVal = document.getElementById('fExpOwner').value; const items = ST.prods.filter(p => !p.deleted && !p.consumed && p.exp && (ownerVal === "" || (p.owners && p.owners.includes(ownerVal)))); const s = (arr) => arr.sort((a,b)=>a.exp.localeCompare(b.exp)); const today = new Date(); const reds=[], orgs=[], grns=[]; items.forEach(p => { const diff = (new Date(p.exp) - today) / 86400000; if(diff < 0) reds.push(p); else if(diff <= 30) orgs.push(p); else grns.push(p); }); const blk = (t, c, arr) => arr.length ? `<div class="exp-head ${c}" style="padding:10px;color:white;border-radius:6px;margin:20px 0 12px;font-weight:bold;font-size:1rem;">${t} (${arr.length})</div>${s(arr).map(app.card).join('')}` : ''; document.getElementById('expiryContent').innerHTML = (reds.length?blk("ğŸ”´ å·²éæœŸ", "bg-red", reds):'') + (orgs.length?blk("ğŸŸ  30å¤©å…§åˆ°æœŸ", "bg-org", orgs):'') + (grns.length?blk("ğŸŸ¢ å®‰å…¨æœŸ", "bg-grn", grns):'') || '<div style="text-align:center;padding:30px;color:#999;font-size:1rem;">ç„¡ç›¸é—œç”¢å“</div>'; },
            renderStar: () => { const ownerVal = document.getElementById('fStarOwner').value; const stars = ST.prods.filter(p => !p.deleted && p.star && (ownerVal === "" || (p.owners && p.owners.includes(ownerVal)))); document.getElementById('starredList').innerHTML = stars.length ? stars.map(app.card).join('') : '<div style="text-align:center;padding:20px;color:#999;">å°šæœªåŠ å…¥é—œæ³¨â­ï¸</div>'; },
            
            detail: (id) => { 
                const p = ST.prods.find(x=>x.id===id); if(!p) return; 
                app.nav('detail'); 
                const canEdit = app.getRole().isAdmin || p.creator === app.currentUserEmail(); 
                let warn = ""; if(p.savedBase && p.savedBase !== ST.sets.base) warn = `<div class="warn-box"><span>âš ï¸</span><div><b>åŒ¯ç‡åŸºæº–ä¸ä¸€è‡´</b>...</div></div>`; 
                const bs = app.getSym(); 
                let breakdownHtml = ""; 
                if(p.isFor && p.curr && p.curr !== ST.sets.base) { breakdownHtml += `<div class="promo-line"><span>å¤–å¹£åŸåƒ¹</span><span>${app.getForSym(p.curr)}${p.raw}</span></div><div class="promo-line"><span>åŒ¯ç‡æ›ç®— (x${p.rateEx})</span><span>${bs}${(p.raw * (p.rateEx||1)).toFixed(2)}</span></div>`; } else { breakdownHtml += `<div class="promo-line"><span>åŸå§‹åƒ¹æ ¼</span><span>${bs}${p.raw}</span></div>`; } 
                if(p.promos && p.promos.length > 0) { 
                    p.promos.forEach(x => { 
                        let lbl = x.note ? x.note : ''; let valDisplay = ''; 
                        if(x.type==='pct') { if(!lbl) lbl=`æŠ˜æ‰£ ${x.val}%`; valDisplay=`-${x.val}%`; } else if(x.type==='cash') { if(!lbl) lbl=`æŠ˜æ‰£ $${x.val}`; valDisplay=`-${bs}${x.val}`; } else if(x.type==='bogo') { if(!lbl) lbl=`è²·${x.buy}é€${x.get}`; valDisplay=`å« (æ¯çµ„ ${bs}${(p.total / (x.buy+x.get)).toFixed(2)})`; } 
                        breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ ${lbl}</span><span>${valDisplay}</span></div>`; 
                    }); 
                } else { 
                    if(p.DiscPct) breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ æŠ˜æ‰£ ${p.DiscPct}%</span><span>-${p.DiscPct}%</span></div>`; 
                    if(p.DiscCash) breakdownHtml += `<div class="promo-line" style="color:var(--success);"><span>ğŸ ç¾é‡‘æŠ˜æŠµ</span><span>-${bs}${p.DiscCash}</span></div>`; 
                } 
                breakdownHtml += `<div class="promo-line" style="border-top:1px solid #ddd; margin-top:4px; padding-top:4px; font-weight:bold; color:var(--text);"><span>æœ€çµ‚å¯¦ä»˜</span><span class="promo-val">${bs}${p.total}</span></div>`; 

                // åœ¨è©³ç´°é é¢é¡¯ç¤ºå¸‚å ´åƒ¹æ ¼èˆ‡åƒ¹å·®
                if (p.market_price && p.market_price > 0) {
                    const priceDiff = p.market_price - p.total;
                    let diffText = '';
                    let diffStyle = '';
                    if (priceDiff > 0) {
                        diffText = `è²´ ${bs}${priceDiff.toFixed(2)}`;
                        diffStyle = 'color: var(--danger);';
                    } else if (priceDiff < 0) {
                        diffText = `çœ ${bs}${(-priceDiff).toFixed(2)}`;
                        diffStyle = 'color: var(--success);';
                    } else {
                        diffText = 'åŒå¸‚åƒ¹';
                        diffStyle = 'color: #777;';
                    }
                    breakdownHtml += `<div class="promo-line" style="margin-top:10px; font-weight:bold; color:var(--info);"><span>å¸‚åƒ¹åƒè€ƒ</span><span>${bs}${p.market_price.toFixed(2)} <span style="${diffStyle}">(${diffText})</span></span></div>`;
                }

                let tagsHtml = ""; if(p.owners) tagsHtml += `<div style="margin-top:10px;display:flex;gap:5px;">${p.owners.map(o=>`<span class="tag-owner">ğŸ‘¤ ${o}</span>`).join('')}</div>`; if(p.tags) tagsHtml += `<div style="margin-top:10px;display:flex;gap:5px;">${p.tags.map(t=>`<span class="tag-user">#${t}</span>`).join('')}</div>`; 
                const detailUrl = p.img; // Supabase Storage ç›´æ¥ä½¿ç”¨å…¬å…± URL
                const imgHtml = p.img ? `<img src="${detailUrl}" class="detail-img" onclick="app.lb('${p.img}')">` : `<div style="height:120px;background:#eee;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#999;font-size:2rem;">ğŸ“·</div>`; 
                const btnStarStyle = p.star ? 'background:#fff9c4; color:#fbc02d; border-color:#fbc02d;' : 'background:white; color:#555;'; const btnConStyle = p.consumed ? 'background:#424242; color:white; border-color:#424242;' : 'background:white; color:#555;'; const editBtns = canEdit ? `<button class="btn-mini" style="padding:10px 16px; background:#fff3e0;color:#ef6c00;" onclick="app.loadToForm('${p.id}', true)">âœï¸ ä¿®æ”¹</button><button class="btn-mini" style="padding:10px 16px; background:#ffebee;color:#c62828;" onclick="app.softDel('${p.id}')">ğŸ—‘ï¸ ä¸Ÿæ£„</button>` : `<span style="color:#999; font-size:0.8rem;">(åƒ…ç™¼å¸ƒè€…å¯ä¿®æ”¹)</span>`; 
                document.getElementById('detailContent').innerHTML = `<div style="text-align:center; padding:10px;">${imgHtml}</div>${warn}<h2 style="text-align:center; margin:10px 0 5px; color:var(--primary); font-size:1.4rem;">${p.name}</h2><div style="text-align:center;font-size:0.85rem;color:#777;margin-bottom:5px;">${p.creator ? 'ç”± '+p.creator+' æ–°å¢' : ''}</div><div style="text-align:center;margin-bottom:15px;display:flex;flex-wrap:wrap;justify-content:center;gap:5px;">${tagsHtml}</div><div style="display:flex; gap:10px; justify-content:center; margin-bottom:25px; flex-wrap:wrap;"><button class="btn-mini" style="padding:10px 14px; ${btnConStyle}" onclick="app.upd('${p.id}',{consumed:${!p.consumed}}).then(()=>app.detail('${p.id}'))">${p.consumed ? 'âœ… å·²ç”¨/å·²é£Ÿ' : 'ğŸ½ å¾…ç”¨/å¾…é£Ÿ'}</button><button class="btn-mini" style="padding:10px 14px; ${btnStarStyle}" onclick="app.upd('${p.id}',{star:${!p.star}}).then(()=>app.detail('${p.id}'))">${p.star ? 'â­ï¸ å·²é—œæ³¨' : 'â˜† é—œæ³¨'}</button><button class="btn-mini" style="padding:10px 16px; background:#e3f2fd;color:#1565c0;" onclick="app.comp('${p.name.replace(/'/g,"\\'")}','${p.brand.replace(/'/g,"\\'")}','')">âš–ï¸ æ¯”åƒ¹</button>${editBtns}</div><table class="detail-table"><tr><th>åœ°é»/å“ç‰Œ</th><td>${p.loc}<br>${p.brand}</td></tr><tr><th>è¦æ ¼/æ•¸é‡</th><td>${p.qty} ${p.unit}<br>${p.spec||'ç„¡è¦æ ¼'}</td></tr><tr><th>åŠ å…¥æ—¥æœŸ</th><td>${app.fmtDate(p.at)}</td></tr><tr><th>æœ‰æ•ˆæ—¥æœŸ</th><td>${p.exp||'--'}</td></tr><tr><th>æ·¨å–®åƒ¹</th><td>${bs}${p.net} / ${p.unit}</td></tr><tr><th>åƒ¹æ ¼è©³æƒ…</th><td>${breakdownHtml}</td></tr><tr><th>å‚™è¨»</th><td style="white-space:pre-wrap;color:#555;">${p.note||'--'}</td></tr></table>`; 
            },

            addPromoRow: (type, val='', note='', buy='', get='') => { const div = document.createElement('div'); div.className = 'promo-row'; if (type === 'bogo') { div.innerHTML = `<div class="chk-lbl" style="font-weight:bold;color:var(--action)">è²·</div><input type="number" class="form-control promo-inp-bogo inp-buy" placeholder="2" value="${buy}" oninput="app.calc()"><div class="chk-lbl" style="font-weight:bold;color:var(--action)">é€</div><input type="number" class="form-control promo-inp-bogo inp-get" placeholder="1" value="${get}" oninput="app.calc()"><input type="hidden" class="promo-inp-s" data-type="bogo" value="0"><input type="text" class="form-control promo-inp-l" placeholder="èªªæ˜ (é¸å¡«)" value="${note}"><span class="promo-del" onclick="this.parentElement.remove();app.calc()">&times;</span>`; } else { div.innerHTML = `<div class="chk-lbl" style="width:20px; justify-content:center;">${type==='pct'?'%':'$'}</div><input type="number" class="form-control promo-inp-s" data-type="${type}" placeholder="${type==='pct'?'10':'20'}" value="${val}" oninput="app.calc()"><input type="text" class="form-control promo-inp-l" placeholder="èªªæ˜" value="${note}"><span class="promo-del" onclick="this.parentElement.remove();app.calc()">&times;</span>`; } document.getElementById('promoList').appendChild(div); app.calc(); },
            handleTagInput: (e) => { if(e.key === 'Enter') { e.preventDefault(); app.addTagFromInput(); } }, addTagFromInput: () => { const inp = document.getElementById('pTagInput'); const val = inp.value.trim(); if(val) { app.addTag(val); inp.value = ''; } }, addTag: async (tag) => { if(!currentFormTags.includes(tag)) { currentFormTags.push(tag); app.renderFormTags(); if(!(ST.sets.tags||[]).includes(tag)) { // æ›´æ–° Supabase ä¸­çš„ tags
                        const currentTags = ST.sets.tags || [];
                        const newTags = [...currentTags, tag];
                        await supabase.from(TABLE_NAMES.settings).update({ tags: newTags }).eq('id', 'main');
                    } } }, removeTag: (tag) => { currentFormTags = currentFormTags.filter(t => t !== tag); app.renderFormTags(); }, 
            renderFormTags: () => { const container = document.getElementById('formTagContainer'); container.innerHTML = currentFormTags.map(t => `<div class="tag-chip"><span>#${t}</span><span style="color:#d32f2f;margin-left:2px;" onclick="app.removeTag('${t}')">&times;</span></div>`).join(''); if(currentFormTags.length === 0) container.innerHTML = '<span style="color:#aaa;font-size:0.9rem;padding:4px;">(æœªé¸æ“‡æ¨™ç±¤)</span>'; const pool = app.sortArr(ST.sets.tags); const available = pool.filter(t => !currentFormTags.includes(t)); document.getElementById('tagPool').innerHTML = available.length ? available.map(t => `<div class="tag-suggestion" onclick="app.addTag('${t}')">+ ${t}</div>`).join('') : ''; },
            toggleOwner: (name) => { const idx = currentFormOwners.indexOf(name); if(idx > -1) currentFormOwners.splice(idx, 1); else currentFormOwners.push(name); app.renderOwnerSelect(); }, 
            renderOwnerSelect: () => { const div = document.getElementById('pOwnerSelect'); const list = app.sortArr(ST.sets.owners); div.innerHTML = list.length ? list.map(o => { const active = currentFormOwners.includes(o) ? 'active' : ''; return `<div class="owner-chip-btn ${active}" onclick="app.toggleOwner('${o}')">ğŸ‘¤ ${o}</div>`; }).join('') : '<div style="color:#999;font-size:0.9rem;">(æš«ç„¡æˆå“¡ï¼Œè«‹è‡³ã€Œè¨­å®šã€æ–°å¢)</div>'; },
            
            // ğŸ›  ä¿®å¾© Issue 2: å‹•æ…‹è£œé½Šé¸é … (`ensureOpt`)
            loadToForm: (id, isEditMode) => { 
                app.resetForm(); const p = ST.prods.find(x=>x.id===id); if(!p) return; 
                document.getElementById('suggestionBox').style.display='none'; 
                document.getElementById('editId').value = isEditMode ? p.id : ''; 
                document.getElementById('addTitle').innerText = isEditMode ? "ç·¨è¼¯ç”¢å“" : "æ–°å¢ç”¢å“"; 
                document.getElementById('btnSave').innerText = isEditMode ? "âœï¸ æ›´æ–°è³‡æ–™" : "â˜ï¸ ä¿å­˜ç”¢å“"; 
                document.getElementById('pName').value = p.name; 
                
                const ensureOpt = (id, val) => { if(val) { const s = document.getElementById(id); if(!Array.from(s.options).some(o=>o.value===val)) s.add(new Option(val,val)); s.value=val; } };
                ensureOpt('pBrand', p.brand); ensureOpt('pLoc', p.loc); ensureOpt('pUnit', p.unit);
                
                document.getElementById('pSpec').value = p.spec; document.getElementById('pQty').value = p.qty; document.getElementById('pExp').value = p.exp; document.getElementById('pNote').value = p.note; document.getElementById('pPrice').value = p.raw; document.getElementById('pUseFor').checked = p.isFor; if(p.isFor) { document.getElementById('pCurr').value = p.curr; document.getElementById('pRate').value = p.rateEx; } app.toggleFor(); document.getElementById('promoList').innerHTML = ''; if(p.promos && p.promos.length > 0) { p.promos.forEach(x => app.addPromoRow(x.type, x.val, x.note, x.buy, x.get)); } else { if(p.DiscPct) app.addPromoRow('pct', p.DiscPct, p.DiscNote||''); if(p.DiscCash) app.addPromoRow('cash', p.DiscCash, p.CashNote||''); } currentFormTags = p.tags ? [...p.tags] : []; app.renderFormTags(); currentFormOwners = p.owners ? [...p.owners] : []; app.renderOwnerSelect(); document.getElementById('pImgUrl').value = p.img || ''; document.getElementById('pImgPid').value = p.pid || ''; if(p.img && !p.img.includes(CONFIG.supabase.url)) { document.getElementById('pImgExternal').value = p.img; } if(isEditMode) { document.getElementById('pOldPid').value = p.pid || ''; document.getElementById('pOldImg').value = p.img || ''; } if(p.img) { document.getElementById('imgPreview').src = p.img; document.getElementById('imgPreviewBox').style.display='block'; } else { app.removeImg(); } app.calc(); if(isEditMode) app.nav('add'); 
            },
            
            // ğŸ›  ä¿®å¾© Issue 1: åªåœ¨æ–°å¢æ™‚å¡å…¥ Creator !
            saveProd: async () => { 
                const name = document.getElementById('pName').value.trim(); if(!name) return alert("è«‹è¼¸å…¥åç¨±"); 
                const btn = document.getElementById('btnSave'); btn.disabled=true; btn.innerText="è™•ç†ä¸­..."; 
                
                let u = document.getElementById('pImgUrl').value; 
                let pid = document.getElementById('pImgPid').value; // Supabase Storage çš„è·¯å¾‘
                const f = document.getElementById('pImgFile').files[0]; 
                const extUrl = document.getElementById('pImgExternal').value.trim(); 
                
                if(f) { 
                    btn.innerText = "åœ–ç‰‡å£“ç¸®ä¸Šå‚³ä¸­..."; 
                    try { 
                        const compressedBlob = await compressImage(f); 
                        // ç”Ÿæˆå”¯ä¸€æª”æ¡ˆåï¼ŒåŒ…å«ç”¨æˆ¶ ID å’Œæ™‚é–“æˆ³
                        const fileName = `${uid}/${Date.now()}_${f.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; 
                        const { data, error } = await supabase.storage
                            .from('products') // æ›¿æ›ç‚ºæ‚¨çš„ Supabase Storage bucket åç¨±
                            .upload(fileName, compressedBlob, {
                                cacheControl: '3600',
                                upsert: true, // å¦‚æœæª”æ¡ˆå­˜åœ¨å‰‡è¦†è“‹
                                contentType: 'image/webp'
                            });

                        if(error) throw error; 
                        u = supabase.storage.from('products').getPublicUrl(data.path).data.publicUrl; // å–å¾—å…¬å…± URL
                        pid = data.path; // å„²å­˜ Supabase Storage çš„è·¯å¾‘
                    } catch(e) { 
                        alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—: " + e.message); 
                        btn.disabled=false; 
                        btn.innerText = document.getElementById('editId').value ? "âœï¸ æ›´æ–°è³‡æ–™" : "â˜ï¸ ä¿å­˜ç”¢å“"; 
                        return; 
                    } 
                } else if (extUrl) { 
                    u = extUrl; 
                    pid = ""; // å¤–éƒ¨ URL æ²’æœ‰ Supabase Storage è·¯å¾‘
                } 
                const promoRows = document.querySelectorAll('#promoList .promo-row'); const promos = []; let sumPct = 0; let sumCash = 0; let bogoCount = 0; 
                promoRows.forEach(row => { const typeInput = row.querySelector('.promo-inp-s'); const type = typeInput ? typeInput.dataset.type : null; const note = row.querySelector('.promo-inp-l').value; if (type === 'bogo') { const buy = parseFloat(row.querySelector('.inp-buy').value)||0; const get = parseFloat(row.querySelector('.inp-get').value)||0; if(buy > 0 && get > 0) { promos.push({ type, buy, get, note }); bogoCount = buy + get; } } else if (type) { const val = parseFloat(typeInput.value)||0; if(val > 0) { promos.push({type, val, note}); if(type==='pct') sumPct += val; if(type==='cash') sumCash += val; } } }); 
                const c = app.calc(); 
                
                const d = { name: name, brand: document.getElementById('pBrand').value, loc: document.getElementById('pLoc').value, qty: parseFloat(document.getElementById('pQty').value)||1, unit: document.getElementById('pUnit').value, spec: document.getElementById('pSpec').value, exp: document.getElementById('pExp').value, note: document.getElementById('pNote').value, raw: parseFloat(document.getElementById('pPrice').value)||0, isFor: document.getElementById('pUseFor').checked, curr: document.getElementById('pCurr').value, rateEx: parseFloat(document.getElementById('pRate').value)||1, promos: promos, DiscPct: sumPct, DiscCash: sumCash, tags: currentFormTags, owners: currentFormOwners, total: c.t, net: c.n, img: u, pid: pid, savedBase: ST.sets.base }; 
                
                const editId = document.getElementById('editId').value; 
                try { 
                    if(editId) { 
                        const oldPid = document.getElementById('pOldPid').value; 
                        const oldImg = document.getElementById('pOldImg').value; 
                        
                        // å¦‚æœåœ–ç‰‡è·¯å¾‘æ”¹è®Šä¸”èˆŠåœ–ç‰‡æ˜¯ä¾†è‡ª Supabase Storageï¼Œå¯ä»¥è€ƒæ…®åˆªé™¤èˆŠåœ– (éœ€è¦ RLS æ¬Šé™)
                        if (oldPid && oldPid !== pid && oldImg.includes(CONFIG.supabase.url)) {
                             console.warn("èˆŠçš„ Supabase Storage åœ–ç‰‡æœªå¾å‰ç«¯è‡ªå‹•åˆªé™¤:", oldPid);
                             // å»ºè­°ï¼šå°‡ oldPid è¨˜éŒ„åˆ°ä¸€å€‹æ¸…ç†ä½‡åˆ—è¡¨ä¸­ï¼Œè®“å¾Œç«¯æœå‹™è™•ç†æ¸…ç†ã€‚
                             // ä¾‹å¦‚ï¼šawait supabase.from('image_cleanup_queue').insert([{ path: oldPid, product_id: editId }]);
                        }

                        const { error } = await supabase.from(TABLE_NAMES.products).update(d).eq('id', editId); 
                        if(error) throw error;
                        alert("æ›´æ–°æˆåŠŸ"); 
                    } else { 
                        d.at=Date.now(); d.consumed=false; d.star=false; d.deleted=false; d.isGhost=false; 
                        d.creator = app.currentUserEmail(); d.uid = uid; 
                        const { error } = await supabase.from(TABLE_NAMES.products).insert([d]); 
                        if(error) throw error;
                        alert("æ–°å¢æˆåŠŸ"); 
                    } 
                    app.nav('home'); 
                } catch(e) { alert("å„²å­˜å¤±æ•— (æ¬Šé™/ç¶²çµ¡): " + e.message); } finally { btn.disabled=false; btn.innerText = document.getElementById('editId').value ? "âœï¸ æ›´æ–°è³‡æ–™" : "â˜ï¸ ä¿å­˜ç”¢å“"; } 
            },
            resetForm: () => { ['pName','pPrice','pRate','pQty','pSpec','pExp','pNote','pTagInput','pImgFile','pImgExternal'].forEach(k=>document.getElementById(k).value=''); document.getElementById('promoList').innerHTML = ''; currentFormTags = []; app.renderFormTags(); currentFormOwners = []; app.renderOwnerSelect(); document.getElementById('addTitle').innerText="æ–°å¢ç”¢å“"; document.getElementById('btnSave').innerText="â˜ï¸ ä¿å­˜ç”¢å“"; document.getElementById('pQty').value=1; document.getElementById('editId').value = ""; document.getElementById('pOldPid').value = ""; document.getElementById('pOldImg').value = ""; app.removeImg(); document.getElementById('pUseFor').checked=false; app.toggleFor(); },
            removeImg: () => { document.getElementById('pImgFile').value=""; document.getElementById('pImgExternal').value=""; document.getElementById('pImgUrl').value=""; document.getElementById('pImgPid').value=""; document.getElementById('imgPreviewBox').style.display='none'; document.getElementById('imgPreview').src=""; }, prevImg: (i) => { document.getElementById('pImgExternal').value = ""; if(i.files[0]) { document.getElementById('imgPreview').src=URL.createObjectURL(i.files[0]); document.getElementById('imgPreviewBox').style.display='block'; } }, prevExternal: (url) => { if(url) { document.getElementById('pImgFile').value = ""; document.getElementById('imgPreview').src = url; document.getElementById('imgPreviewBox').style.display = 'block'; } }, lb: (url) => { document.getElementById('lbImg').src=url; document.getElementById('lightbox').style.display='flex'; },
            comp: (name, brand) => { const list = ST.prods.filter(p => !p.deleted && p.name === name); list.sort((a,b) => a.net - b.net); const minPrice = list.length ? list[0].net : 0; const bs = app.getSym(); document.getElementById('compareInfo').innerText = `æ¯”åƒ¹: ${name} (å…±${list.length}ç­†)`; document.getElementById('compareBody').innerHTML = list.map(p => { const thumbUrl = getThumb(p.img, 100); const thumb = p.img ? `<img src="${thumbUrl}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;float:left;margin-right:8px;" onclick="app.lb('${p.img}')">` : `<div style="width:40px;height:40px;background:#eee;float:left;margin-right:8px;display:flex;align-items:center;justify-content:center;">ğŸ“·</div>`; const isCheap = (p.net === minPrice); let priceDisplay = `<div><b>${bs}${p.total}</b></div>`; if (p.isFor && p.curr !== ST.sets.base) priceDisplay += `<div style="color:#666;font-size:0.85rem;">(${app.getForSym(p.curr)}${p.raw})</div>`; let discInfo = ""; if(p.promos && p.promos.length > 0) { p.promos.forEach(x => { if(x.type==='pct') discInfo += `<span class="tag-disc">â†“${x.val}%</span>`; else if(x.type==='cash') discInfo += `<span class="tag-disc">-$${x.val}</span>`; else if(x.type==='bogo') discInfo += `<span class="tag-bogo">è²·${x.buy}é€${x.get}</span>`; }); } else if(p.DiscPct || p.DiscCash) { if(p.DiscPct) discInfo += `<span class="tag-disc">â†“${p.DiscPct}%</span>`; if(p.DiscCash) discInfo += `<span class="tag-disc">-$${p.DiscCash}</span>`; } if(discInfo) priceDisplay += `<div style="margin-top:2px;">${discInfo}</div>`; const bogoInfo = app.getBogoInfo(p); if(bogoInfo) priceDisplay += `<div style="margin-top:2px; font-size:0.8rem; color:var(--action); font-weight:bold;">${bogoInfo}</div>`; const statusHtml = `<div style="display:flex; flex-direction:column; gap:8px; align-items:flex-start;"><label class="chk-lbl" style="font-size:0.85rem;"><input type="checkbox" ${p.consumed?'checked':''} onchange="app.upd('${p.id}',{consumed:this.checked})"> å·²ç”¨</label><label class="chk-lbl" style="font-size:0.85rem;"><input type="checkbox" ${p.star?'checked':''} onchange="app.upd('${p.id}',{star:this.checked})"> â­ï¸</label></div>`; return `<tr class="${isCheap?'row-cheap':''}"><td onclick="app.detail('${p.id}')">${thumb} <b>${p.brand}</b><br><small>${p.loc}</small></td><td style="color:${isCheap?'#e65100':'var(--danger)'};font-weight:bold;">${bs}${p.net}${isCheap?" <span class='badge-cheap'>ğŸ†</span>":""}</td><td>${p.qty}${p.unit}<br><span style="font-size:0.8rem;color:#777;">${p.spec||''}</span></td><td>${priceDisplay}</td><td>${statusHtml}</td></tr>`; }).join(''); app.nav('compare'); },
            toggleFor: () => { const c = document.getElementById('pUseFor').checked; document.getElementById('pCurr').disabled = !c; document.getElementById('forArea').classList.toggle('hidden', !c); if(c && !document.getElementById('pCurr').value) document.getElementById('pCurr').value='USD'; app.updRateLabel(); app.calc(); }, updRateLabel: () => { const f = document.getElementById('pCurr').value; const b = ST.sets.base; const r = document.getElementById('pRate').value || '?'; document.getElementById('rateLabel').innerText = `1 ${f} = ${r} ${b}`; },
            calc: () => { const raw = parseFloat(document.getElementById('pPrice').value)||0; let pct = 0; let cash = 0; let bogoCount = 0; document.querySelectorAll('#promoList .promo-row').forEach(row => { const type = row.querySelector('.promo-inp-s').dataset.type; if (type === 'bogo') { const buy = parseFloat(row.querySelector('.inp-buy').value)||0; const get = parseFloat(row.querySelector('.inp-get').value)||0; if(buy > 0 && get > 0) { bogoCount = buy + get; } } else { const val = parseFloat(row.querySelector('.promo-inp-s').value)||0; if(type === 'pct') pct += val; if(type === 'cash') cash += val; } }); let valFor = raw * (1 - pct/100) - cash; if(valFor < 0) valFor = 0; let valBase = valFor; const isFor = document.getElementById('pUseFor').checked; if(isFor) { valBase = valFor * (parseFloat(document.getElementById('pRate').value)||1); document.getElementById('calcForRes').innerText = `å¤–å¹£å¯¦ä»˜: ${app.getForSym(document.getElementById('pCurr').value)}${valFor.toFixed(2)}`; } else { document.getElementById('calcForRes').innerText = ""; } let perPackHtml = ""; if (bogoCount > 1) { const packPrice = valBase / bogoCount; perPackHtml = ` <B style="color:#e65100;">(æ¯çµ„/åŒ…: ${app.getSym()}${packPrice.toFixed(2)})</B>`; } const q = parseFloat(document.getElementById('pQty').value)||1; const net = valBase/q; document.getElementById('calcRes').innerHTML = `æœ¬å¹£å¯¦ä»˜: ${app.getSym()}${valBase.toFixed(2)}${perPackHtml} <span style="font-size:0.9rem; color:#666; font-weight:normal;">(å–®: ${app.getSym()}${net.toFixed(2)})</span>`; return { t: Number(valBase.toFixed(2)), n: Number(net.toFixed(2)) }; },
            upd: async (id, o) => { 
                const { error } = await supabase.from(TABLE_NAMES.products).update(o).eq('id', id);
                if (error) alert("æ›´æ–°å¤±æ•— (æ¬Šé™): " + error.message);
            },
            auth: async () => { 
                if (!supabase) { alert("âš ï¸ ç³»çµ±æœªå•Ÿå‹•ï¼\nè«‹æª¢æŸ¥ Supabase URL å’Œ Anon Keyã€‚"); return; }
                const e = document.getElementById('logEmail').value.trim(); 
                const p = document.getElementById('logPwd').value.trim(); 
                if(!e || !p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); 
                const btn = document.getElementById('btnLogin'); 
                const errBox = document.getElementById('authErr'); 
                btn.disabled = true; btn.innerText = "é©—è­‰ä¸­..."; errBox.innerText = ""; 
                
                const { data, error } = await supabase.auth.signInWithPassword({ email: e, password: p });

                if (error) {
                    if (error.message.includes('Invalid login credentials') || error.message.includes('Email not confirmed')) { // Supabase éŒ¯èª¤è¨Šæ¯å¯èƒ½åŒ…å«æœªç¢ºèª
                        // å˜—è©¦è¨»å†Š
                        const { error: signUpError } = await supabase.auth.signUp({ email: e, password: p });
                        if (signUpError) {
                            if (signUpError.message.includes('already registered')) {
                                errBox.innerText = "âš ï¸ å¸³è™Ÿå·²å­˜åœ¨ï¼Œä½†å¯†ç¢¼éŒ¯èª¤ã€‚";
                            } else if (signUpError.message.includes('Password should be at least 6 characters')) {
                                errBox.innerText = "âš ï¸ å¯†ç¢¼å¤ªå¼±ï¼Œè«‹è‡³å°‘è¼¸å…¥ 6 ä½æ•¸ã€‚";
                            } else {
                                errBox.innerText = "è¨»å†Šå¤±æ•—: " + signUpError.message;
                            }
                            btn.disabled = false;
                            btn.innerText = "ç™»å…¥ / è¨»å†Š";
                        } else {
                            // æˆåŠŸè¨»å†Šï¼Œé€šå¸¸æœƒç™¼é€é©—è­‰ Email
                            errBox.innerText = "è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„ Email é€²è¡Œé©—è­‰ä¸¦ç™»å…¥ã€‚";
                            btn.disabled = false;
                            btn.innerText = "ç™»å…¥ / è¨»å†Š";
                        }
                    } else {
                        errBox.innerText = "ç™»å…¥éŒ¯èª¤: " + error.message;
                        btn.disabled = false;
                        btn.innerText = "ç™»å…¥ / è¨»å†Š";
                    }
                } else {
                    btn.innerText = "ç™»å…¥æˆåŠŸ...";
                    // onAuthStateChange æœƒè™•ç†å¾ŒçºŒå°èˆª
                }
            }, 
            logout: async () => { 
                const { error } = await supabase.auth.signOut();
                if (error) console.error("ç™»å‡ºå¤±æ•—:", error.message);
                location.reload();
            },
            suggest: (v) => { const b = document.getElementById('suggestionBox'); if(!v) { b.style.display='none'; return; } const hits = ST.prods.filter(p=> !p.deleted && p.name.includes(v)).slice(0,5); b.innerHTML = hits.map(p=>`<div class="suggest-item" onclick="app.loadToForm('${p.id}', false)"><img class="s-img" src="${p.img||''}"><div><div class="s-info">${p.name}</div><div style="font-size:0.9rem;color:#888;">${p.brand} | $${p.net}/${p.unit}</div></div></div>`).join(''); b.style.display = hits.length ? 'block' : 'none'; },
            navToAdd: () => { app.resetForm(); app.nav('add'); }, nav: (v) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); if(document.getElementById('nav-'+v)) document.getElementById('nav-'+v).classList.add('active'); if(v==='home') { document.getElementById('backBtn').style.display='none'; document.getElementById('pageTitle').innerText = app.currentUserEmail()?app.currentUserEmail().split('@')[0]:'åº«å­˜'; app.renderHome(); } else if(v==='add' && !document.getElementById('editId').value) app.resetForm(); else if(v==='trash') app.renderTrash(); else document.getElementById('backBtn').style.display='block'; window.scrollTo(0,0); },
            addOpt: async (type, id) => { 
                const el = document.getElementById(id); const v = el.value.trim(); if(!v) return; 
                const currentArray = ST.sets[type] || [];
                if (currentArray.includes(v)) { alert("é¸é …å·²å­˜åœ¨ï¼"); return; }
                const newArray = [...currentArray, v];
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ [type]: newArray }).eq('id', 'main');
                if(error) { alert('æ–°å¢å¤±æ•— (æ¬Šé™): '+error.message); } else { el.value=''; } 
            },
            delOpt: async (type, val) => { 
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šä¸€èˆ¬ç”¨æˆ¶ç„¡æ³•åˆªé™¤é¸é …ã€‚"); 
                let isUsed = false; 
                if (type === 'owners') isUsed = ST.prods.some(p => !p.deleted && p.owners && p.owners.includes(val)); 
                else { const map = { brands: 'brand', locs: 'loc', units: 'unit' }; isUsed = ST.prods.some(p => !p.deleted && p[map[type]] === val); } 
                if (isUsed) return alert(`âŒ ç„¡æ³•åˆªé™¤ [${val}]ï¼Œå› ç‚ºç›®å‰æœ‰ç”¢å“æ­£åœ¨ä½¿ç”¨æ­¤é¸é …ã€‚`); 
                if(!confirm(`ç¢ºå®šç§»é™¤å…¨åŸŸé¸é … [${val}]ï¼Ÿ`)) return; 
                
                const currentArray = ST.sets[type] || [];
                const newArray = currentArray.filter(x => x !== val);
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ [type]: newArray }).eq('id', 'main');
                if(error) alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: "+error.message); 
            },
            editOpt: async (type, oldVal) => { 
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³"); 
                const newVal = prompt(`æ”¹å [${oldVal}] ç‚º:`, oldVal); if(!newVal || newVal === oldVal) return; 

                const currentArray = ST.sets[type] || [];
                if (currentArray.includes(newVal)) { alert("æ–°åç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒåç¨±ã€‚"); return; }
                const newArray = currentArray.map(x => x === oldVal ? newVal : x);
                const { error: settingsError } = await supabase.from(TABLE_NAMES.settings).update({ [type]: newArray }).eq('id', 'main');
                if (settingsError) { alert("æ›´æ–°è¨­å®šå¤±æ•—: " + settingsError.message); return; }

                if (type !== 'owners' && type !== 'tags') { // Owners å’Œ tags è™•ç†æ–¹å¼ä¸åŒ (é™£åˆ—)
                    const map = { brands: 'brand', locs: 'loc', units: 'unit' };
                    let updatePromises = [];
                    ST.prods.forEach(p => {
                        if (p[map[type]] === oldVal) {
                            updatePromises.push(supabase.from(TABLE_NAMES.products).update({ [map[type]]: newVal }).eq('id', p.id));
                        }
                    });
                    await Promise.all(updatePromises).then(() => alert("æ›´æ–°å®Œæˆ")).catch(e => alert("æ›´æ–°ç”¢å“å¤±æ•—: " + e.message));
                } else if (type === 'tags') {
                    let updatePromises = [];
                    ST.prods.forEach(p => {
                        if (p.tags && p.tags.includes(oldVal)) {
                            const newTags = p.tags.map(t => t === oldVal ? newVal : t);
                            updatePromises.push(supabase.from(TABLE_NAMES.products).update({ tags: newTags }).eq('id', p.id));
                        }
                    });
                    await Promise.all(updatePromises).then(() => alert("æ›´æ–°å®Œæˆ")).catch(e => alert("æ›´æ–°ç”¢å“æ¨™ç±¤å¤±æ•—: " + e.message));
                } else if (type === 'owners') {
                    let updatePromises = [];
                    ST.prods.forEach(p => {
                        if (p.owners && p.owners.includes(oldVal)) {
                            const newOwners = p.owners.map(o => o === oldVal ? newVal : o);
                            updatePromises.push(supabase.from(TABLE_NAMES.products).update({ owners: newOwners }).eq('id', p.id));
                        }
                    });
                    await Promise.all(updatePromises).then(() => alert("æ›´æ–°å®Œæˆ")).catch(e => alert("æ›´æ–°ç”¢å“æ‰€æœ‰äººå¤±æ•—: " + e.message));
                }
            },
            cleanUnusedOpts: async () => { 
                if(!app.getRole().isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³ï¼šåƒ… Admin å¯åŸ·è¡Œæ¸…ç†ã€‚"); 
                if(!confirm("âš ï¸ ç¢ºå®šè¦ç§»é™¤æ‰€æœ‰ã€Œç›®å‰æ²’è¢«ä»»ä½•ç”¢å“ä½¿ç”¨ã€çš„é¸é …å—ï¼Ÿ")) return; 
                const usedBrands = new Set(); const usedLocs = new Set(); const usedUnits = new Set(); const usedOwners = new Set(); const usedTags = new Set();
                ST.prods.forEach(p => { 
                    if(!p.deleted) { 
                        if(p.brand) usedBrands.add(p.brand); 
                        if(p.loc) usedLocs.add(p.loc); 
                        if(p.unit) usedUnits.add(p.unit); 
                        if(p.owners) p.owners.forEach(o => usedOwners.add(o)); 
                        if(p.tags) p.tags.forEach(t => usedTags.add(t));
                    } 
                }); 
                const newBrands = (ST.sets.brands || []).filter(x => usedBrands.has(x)); 
                const newLocs = (ST.sets.locs || []).filter(x => usedLocs.has(x)); 
                const newUnits = (ST.sets.units || []).filter(x => usedUnits.has(x)); 
                const newOwners = (ST.sets.owners || []).filter(x => usedOwners.has(x)); 
                const newTags = (ST.sets.tags || []).filter(x => usedTags.has(x));
                
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ 
                    brands: newBrands, locs: newLocs, units: newUnits, owners: newOwners, tags: newTags 
                }).eq('id', 'main'); 
                if(error) { alert("æ¸…ç†å¤±æ•—: "+error.message); } else { alert("ğŸ§¹ æ¸…ç†å®Œæˆï¼"); } 
            },
            saveSet: async () => { 
                const newBase = document.getElementById('baseCurr').value; 
                const oldBase = ST.sets.base; if(newBase === oldBase) return alert("å¹£åˆ¥æœªæ”¹è®Š"); 
                if(!confirm(`ç¢ºå®šè®Šæ›´æœ¬å¹£ [${oldBase}] -> [${newBase}]ï¼Ÿ`)) return; 
                const btn=document.getElementById('btnBaseSave'); btn.disabled=true; btn.innerText="å„²å­˜ä¸­..."; 
                try { 
                    const nowStr = app.fmtTime(Date.now()); 
                    const { error: settingsError } = await supabase.from(TABLE_NAMES.settings).update({ base: newBase }).eq('id', 'main');
                    if (settingsError) throw settingsError;

                    // æ›´æ–°æ‰€æœ‰ç”¢å“çš„ savedBase ä¸¦è¨˜éŒ„è®Šæ›´
                    const updatePromises = ST.prods.map(p => {
                        const log = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n[ç³»çµ±é€šçŸ¥] åŒ¯ç‡åŸºæº–è®Šæ›´\nâ€¢ æ™‚é–“: ${nowStr}\nâ€¢ è®Šæ›´: ${oldBase} â” ${newBase}\nâ€¢ é‡‘é¡æœªè®Šï¼Œåƒ…æ›´æ–°å–®ä½ç¬¦è™Ÿ\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                        return supabase.from(TABLE_NAMES.products).update({ note: (p.note || '') + log, savedBase: oldBase }).eq('id', p.id);
                    });
                    await Promise.all(updatePromises); // ä½¿ç”¨ Promise.all æ¨¡æ“¬æ‰¹æ¬¡æ›´æ–°

                    alert("å·²æ›´æ–°è¨­å®š"); 
                } catch (e) { alert("è¨­å®šæ›´æ–°å¤±æ•—: " + e.message); } finally { btn.disabled=false; btn.innerText="å„²å­˜ä¿®æ”¹"; }},

            addAdmin: async (emTarget) => { 
                const em = emTarget || document.getElementById('newAdminEmail').value.trim(); 
                if(!em) return; 
                if(!app.getRole().isAdmin) return alert("æ¬Šé™ä¸è¶³"); 
                
                const currentAdmins = ST.sets.admins || [];
                if (currentAdmins.includes(em)) { alert("è©²ç”¨æˆ¶å·²æ˜¯ç®¡ç†å“¡ï¼"); return; }

                const newAdmins = [...currentAdmins, em];
                const currentAllUsers = ST.sets.allUsers || [];
                const newAllUsers = [...new Set([...currentAllUsers, em])]; // ç¢ºä¿ä¹ŸåŠ å…¥åˆ°æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨

                const { error } = await supabase.from(TABLE_NAMES.settings).update({ 
                    admins: newAdmins,
                    allUsers: newAllUsers
                }).eq('id', 'main');
                if(error) { alert("æˆæ¬Šå¤±æ•—: " + error.message); } else { document.getElementById('newAdminEmail').value = ''; } 
            },
            
            delAdmin: async (em) => { 
                if(!app.getRole().isAdmin) return alert("æ¬Šé™ä¸è¶³"); 
                if(em === ST.sets.superAdmin) return alert("âŒ ç¦æ­¢ç§»é™¤è¶…ç´šç®¡ç†å“¡ï¼"); 
                if(!confirm(`âš ï¸ ç¢ºå®šè¦å°‡ [${em}] é™ç´šç‚ºä¸€èˆ¬ç”¨æˆ¶ï¼Ÿ`)) return; 
                
                const currentAdmins = ST.sets.admins || [];
                const newAdmins = currentAdmins.filter(x => x !== em);
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ admins: newAdmins }).eq('id', 'main');
                if(error) alert("é™ç´šå¤±æ•—: " + error.message);
            },
            
            editTag: async (oldT) => { 
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³"); 
                const newT = prompt(`å°‡æ¨™ç±¤ [#${oldT}] æ”¹åç‚º:`, oldT); if(!newT || newT === oldT) return; 

                const currentTags = ST.sets.tags || [];
                if (currentTags.includes(newT)) { alert("æ–°æ¨™ç±¤åç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒåç¨±ã€‚"); return; }
                const newTags = currentTags.map(t => t === oldT ? newT : t);

                const { error: settingsError } = await supabase.from(TABLE_NAMES.settings).update({ tags: newTags }).eq('id', 'main');
                if (settingsError) { alert("æ›´æ–°è¨­å®šæ¨™ç±¤å¤±æ•—: " + settingsError.message); return; }

                // æ›´æ–°æ‰€æœ‰ä½¿ç”¨æ­¤æ¨™ç±¤çš„ç”¢å“
                let count = 0;
                let updatePromises = [];
                ST.prods.forEach(p => {
                    if (!p.deleted && p.tags && p.tags.includes(oldT)) {
                        const productNewTags = p.tags.map(tag => tag === oldT ? newT : tag);
                        updatePromises.push(supabase.from(TABLE_NAMES.products).update({ tags: productNewTags }).eq('id', p.id));
                        count++;
                    }
                });
                await Promise.all(updatePromises).catch(e => alert("æ›´æ–°ç”¢å“æ¨™ç±¤å¤±æ•—: " + e.message));
                alert(`âœ… å·²æ›´æ–° ${count} å€‹ç”¢å“çš„æ¨™ç±¤`); 
            },
            delTag: async (t) => { 
                const role = app.getRole(); if(!role.isAdmin) return alert("âŒ æ¬Šé™ä¸è¶³"); 
                const isUsed = ST.prods.some(p => !p.deleted && p.tags && p.tags.includes(t)); 
                if (isUsed) return alert(`âŒ ç„¡æ³•åˆªé™¤æ¨™ç±¤ [#${t}]ï¼Œå› ç‚ºå…¶æ­£åœ¨ä½¿ç”¨ä¸­ã€‚`); 
                if(!confirm(`âš ï¸ ç¢ºå®šç§»é™¤å…¨åŸŸæ¨™ç±¤ [#${t}]ï¼Ÿ`)) return; 
                
                const currentTags = ST.sets.tags || [];
                const newTags = currentTags.filter(x => x !== t);
                const { error } = await supabase.from(TABLE_NAMES.settings).update({ tags: newTags }).eq('id', 'main');
                if(error) alert("æ¬Šé™ä¸è¶³æˆ–éŒ¯èª¤: " + error.message);
            }
        };

        // ğŸ›  ä¿®å¾© Issue 3: æ¸²æŸ“å…¨åŸŸåˆ—è¡¨æ™‚ï¼Œå…¨éƒ¨ä½¿ç”¨ `app.sortArr` å°‡é¸é …æŒ‰å­—æ¯é€²è¡Œå®Œç¾æ’åº
        function renderSets() { 
            const role = app.getRole(); const isAdmin = role.isAdmin; const isSuper = role.isSuper;
            
            // ä½¿ç”¨æ–°å¢åŠ çš„æ’åºå‡½æ•¸è™•ç†æ‰€æœ‰å…¨åŸŸæ¸…å–®
            const sBrands = app.sortArr(ST.sets.brands);
            const sLocs = app.sortArr(ST.sets.locs);
            const sUnits = app.sortArr(ST.sets.units);
            const sOwners = app.sortArr(ST.sets.owners);
            const sTags = app.sortArr(ST.sets.tags);

            const fill = (id, arr, label) => { document.getElementById(id).innerHTML = `<option value="">${label}</option>` + arr.map(x=>`<option value="${x}">${x}</option>`).join(''); }; 
            fill('fBrand', sBrands, 'å…¨éƒ¨å“ç‰Œ'); fill('fLoc', sLocs, 'å…¨éƒ¨åœ°é»'); 
            const buildOwnerSelect = (arr) => `<option value="">ğŸ‘¤ æ‰€æœ‰æˆå“¡</option>` + (arr||[]).map(x=>`<option value="${x}">${x}</option>`).join('');
            document.getElementById('fExpOwner').innerHTML = buildOwnerSelect(sOwners); document.getElementById('fStarOwner').innerHTML = buildOwnerSelect(sOwners);
            
            const fillPure = (id, arr) => { document.getElementById(id).innerHTML = arr.map(x=>`<option value="${x}">${x}</option>`).join(''); }; 
            fillPure('pBrand', sBrands); fillPure('pLoc', sLocs); document.getElementById('pUnit').innerHTML = sUnits.map(x=>`<option value="${x}">${x}</option>`).join(''); 
            
            const cs = CURRS.map(x=>`<option value="${x}">${x}</option>`).join(''); document.getElementById('pCurr').innerHTML = cs; document.getElementById('baseCurr').innerHTML = cs; document.getElementById('baseCurr').value = ST.sets.base; 
            
            const delBtn = (type, val) => isAdmin ? `<span class="setting-del-btn" onclick="app.delOpt('${type}','${val.replace(/'/g,"\\'")}')">&times;</span>` : '';
            const mkList = (label, type, arr) => `<div class="form-group"><label class="form-label">${label}</label><div class="form-row"><input id="inp_${type}" class="form-control" placeholder="æ–°å¢"><button class="btn-mini" onclick="app.addOpt('${type}','inp_${type}')">åŠ </button></div><div style="margin-top:10px;line-height:2;">${arr.map(v => `<span class="setting-item-pill"><span class="setting-edit-txt" onclick="app.editOpt('${type}','${v.replace(/'/g,"\\'")}')">${v}</span> ${delBtn(type,v)}</span>`).join('')}</div></div><hr>`; 
            
            // ä»¥ä¸‹çµ±ä¸€ä»£å…¥å·²ç¶“ Sort éçš„é™£åˆ—
            document.getElementById('setOpts').innerHTML = mkList('æ‰€æœ‰äººæ¸…å–® (Owners)', 'owners', sOwners) + mkList('å“ç‰Œæ¸…å–®', 'brands', sBrands) + mkList('åœ°é»æ¸…å–®', 'locs', sLocs) + mkList('å–®ä½æ¸…å–®', 'units', sUnits); 
            
            if(isAdmin) { 
                document.getElementById('adminMgmtCard').classList.remove('hidden'); 
                
                if (isSuper) {
                    const rawUsers = ST.sets.allUsers || [];
                    const adminUsers = ST.sets.admins || [];
                    const allUsers = [...new Set([...rawUsers, ...adminUsers])];

                    document.getElementById('adminList').innerHTML = allUsers.map(em => {
                        let uRole = 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ¶';
                        let badgeStyle = 'background:#f5f5f5; color:#555; border:1px solid #ddd;';
                        let btnHtml = `<button class="btn-mini" style="background:#f0f8ff; color:#0277bd; border-color:#81d4fa; width:80px;" onclick="app.addAdmin('${em}')">â¬†ï¸ å‡æ¬Šé™</button>`;

                        if (em === ST.sets.superAdmin) {
                            uRole = 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡';
                            badgeStyle = 'background:#8e44ad; color:white; border:none;';
                            btnHtml = `<span style="font-size:0.8rem; color:#999; margin-right:8px;">ç„¡å¯æ“ä½œ</span>`;
                        } else if (adminUsers.includes(em)) {
                            uRole = 'ğŸ›¡ï¸ ç®¡ç†å“¡';
                            badgeStyle = 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;';
                            btnHtml = `<button class="btn-mini" style="background:#ffebee; color:#c62828; border-color:#ffcdd2; width:80px;" onclick="app.delAdmin('${em}')">â¬‡ï¸ é™ç´š</button>`;
                        }

                        return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px dashed #eee;">
                            <div style="flex:1; min-width:0; margin-right:10px;">
                                <div style="font-weight:600; font-size:0.95rem; word-break:break-all; color:#333;">${em}</div>
                                <span style="font-size:0.75rem; padding:2px 8px; border-radius:12px; margin-top:4px; display:inline-block; ${badgeStyle}">${uRole}</span>
                            </div>
                            <div style="flex-shrink:0;">${btnHtml}</div>
                        </div>`;
                    }).join('');
                } else {
                    document.getElementById('adminInputArea').style.display = 'none';
                    document.getElementById('adminList').innerHTML = (ST.sets.admins||[]).map(a => { 
                        const isS = (a === ST.sets.superAdmin); 
                        const pillStyle = isS ? 'background:#8e44ad; color:white; border:none;' : 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;'; 
                        const icon = isS ? 'ğŸ‘‘ ' : 'ğŸ›¡ï¸ '; 
                        return `<div style="padding:10px; border-bottom:1px solid #eee;"><span class="setting-item-pill" style="${pillStyle}">${icon}${a}</span></div>`; 
                    }).join(''); 
                }

                document.querySelector('.btn-clean').style.display = 'block'; 
                
                const toggle = document.getElementById('globalViewToggle');
                toggle.checked = ST.sets.globalViewEnabled !== false;
                toggle.disabled = !isSuper; 
                
            } else { 
                document.getElementById('adminMgmtCard').classList.add('hidden'); 
                document.querySelector('.btn-clean').style.display = 'none'; 
            }
            
            document.getElementById('tagMgmt').innerHTML = sTags.length ? sTags.map(t => { const editAction = isAdmin ? `onclick="app.editTag('${t}')"` : ''; const delAction = isAdmin ? `<span class="setting-del-btn" onclick="app.delTag('${t}')">&times;</span>` : ''; return `<span class="setting-item-pill tag-mgmt-pill"><span class="setting-edit-txt" ${editAction}>#${t}</span> ${delAction}</span>`; }).join('') : '<span style="color:#aaa;">(ç›®å‰ç„¡æ¨™ç±¤)</span>';
            if(document.getElementById('view-add').classList.contains('active')) app.renderOwnerSelect();
        }

        window.app = app; window.init = init; window.onload = init;
    </script>
</body>
</html>
